\doxysection{cache\+\_\+cntlr.\+cc}
\label{cache__cntlr_8cc_source}\index{common/core/memory\_subsystem/parametric\_dram\_directory\_msi/cache\_cntlr.cc@{common/core/memory\_subsystem/parametric\_dram\_directory\_msi/cache\_cntlr.cc}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#include\ "{}cache\_cntlr.h"{}}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#include\ "{}log.h"{}}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}memory\_manager.h"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}core\_manager.h"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}simulator.h"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}subsecond\_time.h"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}config.hpp"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}fault\_injection.h"{}}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ "{}hooks\_manager.h"{}}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}cache\_atd.h"{}}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ "{}shmem\_perf.h"{}}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ "{}utopia\_cache\_template.h"{}}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <cstring>}}
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ \textcolor{comment}{//\ Define\ to\ allow\ private\ L2\ caches\ not\ to\ take\ the\ stack\ lock.}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ Works\ in\ most\ cases,\ but\ seems\ to\ have\ some\ more\ bugs\ or\ race\ conditions,\ preventing\ it\ from\ being\ ready\ for\ prime\ time.}}
\DoxyCodeLine{00017\ \textcolor{comment}{//\#define\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ Lock\ iolock;}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#if\ 0}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#\ \ define\ LOCKED(...)\ \{\ ScopedLock\ sl(iolock);\ fflush(stderr);\ \_\_VA\_ARGS\_\_;\ fflush(stderr);\ \}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#\ \ define\ LOGID()\ fprintf(stderr,\ "{}[\%s]\ \%2u\%c\ [\ \%2d(\%2d)-\/L\%u\%c\ ]\ \%-\/25s@\%3u:\ "{},\ \(\backslash\)}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ itostr(getShmemPerfModel()-\/>getElapsedTime(Sim()-\/>getCoreManager()-\/>amiUserThread()\ ?\ ShmemPerfModel::\_USER\_THREAD\ :\ ShmemPerfModel::\_SIM\_THREAD)).c\_str(),\ Sim()-\/>getCoreManager()-\/>getCurrentCoreID(),\ \(\backslash\)}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Sim()-\/>getCoreManager()-\/>amiUserThread()\ ?\ '\string^'\ :\ '\_',\ \(\backslash\)}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_core\_id\_master,\ m\_core\_id,\ m\_mem\_component\ <\ MemComponent::L2\_CACHE\ ?\ 1\ :\ m\_mem\_component\ -\/\ MemComponent::L2\_CACHE+2,\ \(\backslash\)}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_mem\_component\ ==\ MemComponent::L1\_ICACHE\ ?\ 'I'\ :\ (m\_mem\_component\ ==\ MemComponent::L1\_DCACHE\ \ ?\ 'D'\ :\ '\ '),\ \ \(\backslash\)}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_\_FUNCTION\_\_,\ \_\_LINE\_\_\ \(\backslash\)}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ );}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#\ \ define\ MYLOG(...)\ LOCKED(LOGID();\ fprintf(stderr,\ \_\_VA\_ARGS\_\_);\ fprintf(stderr,\ "{}\(\backslash\)n"{});)}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#\ \ define\ DUMPDATA(data\_buf,\ data\_length)\ \{\ for(UInt32\ i\ =\ 0;\ i\ <\ data\_length;\ ++i)\ fprintf(stderr,\ "{}\%02x\ "{},\ data\_buf[i]);\ \}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#\ \ define\ MYLOG(...)\ \{\}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{keyword}{namespace\ }ParametricDramDirectoryMSI}
\DoxyCodeLine{00036\ \{}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \textcolor{keywordtype}{char}\ CStateString(CacheState::cstate\_t\ cstate)\ \{}
\DoxyCodeLine{00039\ \ \ \ \textcolor{keywordflow}{switch}(cstate)}
\DoxyCodeLine{00040\ \ \ \ \{}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::INVALID:\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'I'};}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::SHARED:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'S'};}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::SHARED\_UPGRADING:\ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'u'};}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::MODIFIED:\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'M'};}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::EXCLUSIVE:\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'E'};}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::OWNED:\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'O'};}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::INVALID\_COLD:\ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'\_'};}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::INVALID\_EVICT:\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'e'};}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheState::INVALID\_COHERENCY:\ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'c'};}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{charliteral}{'?'};}
\DoxyCodeLine{00051\ \ \ \ \}}
\DoxyCodeLine{00052\ \}}
\DoxyCodeLine{00053\ \textcolor{keywordtype}{char}\ *\ BlockTypeString(CacheBlockInfo::block\_type\_t\ block\_type)\ \{}
\DoxyCodeLine{00054\ \ \ \ \textcolor{keywordflow}{switch}(block\_type)}
\DoxyCodeLine{00055\ \ \ \ \{}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}page\_table"{}};}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheBlockInfo::block\_type\_t::NON\_PAGE\_TABLE:\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}non\_page\_table"{}};}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheBlockInfo::block\_type\_t::SECURITY:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}security"{}};}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheBlockInfo::block\_type\_t::EXPRESSIVE:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}expressive"{}};}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheBlockInfo::block\_type\_t::UTOPIA:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}utopia"{}};}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}tlb\_entry"{}};}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY\_PASSTHROUGH:\ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}tlb\_entry\_passthrough"{}};}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE\_PASSTHROUGH:\ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}page\_table\_passthrough"{}};}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}??"{}};}
\DoxyCodeLine{00066\ \ \ \ \}}
\DoxyCodeLine{00067\ \}}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ ReasonString(Transition::reason\_t\ reason)\ \{}
\DoxyCodeLine{00071\ \ \ \ \textcolor{keywordflow}{switch}(reason)}
\DoxyCodeLine{00072\ \ \ \ \{}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Transition::CORE\_RD:\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}read"{}};}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Transition::CORE\_RDEX:\ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}readex"{}};}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Transition::CORE\_WR:\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}write"{}};}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Transition::UPGRADE:\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}upgrade"{}};}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Transition::EVICT:\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}evict"{}};}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Transition::BACK\_INVAL:\ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}backinval"{}};}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Transition::COHERENCY:\ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}coherency"{}};}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}other"{}};}
\DoxyCodeLine{00081\ \ \ \ \}}
\DoxyCodeLine{00082\ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ MshrEntry\ make\_mshr(SubsecondTime\ t\_issue,\ SubsecondTime\ t\_complete)\ \{}
\DoxyCodeLine{00085\ \ \ \ MshrEntry\ e;}
\DoxyCodeLine{00086\ \ \ \ e.t\_issue\ =\ t\_issue;\ e.t\_complete\ =\ t\_complete;}
\DoxyCodeLine{00087\ \ \ \ \textcolor{keywordflow}{return}\ e;}
\DoxyCodeLine{00088\ \}}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \textcolor{preprocessor}{\#ifdef\ ENABLE\_TRACK\_SHARING\_PREVCACHES}}
\DoxyCodeLine{00091\ PrevCacheIndex\ CacheCntlrList::find(core\_id\_t\ core\_id,\ MemComponent::component\_t\ mem\_component)}
\DoxyCodeLine{00092\ \{}
\DoxyCodeLine{00093\ \ \ \ \textcolor{keywordflow}{for}(PrevCacheIndex\ idx\ =\ 0;\ idx\ <\ size();\ ++idx)}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((*\textcolor{keyword}{this})[idx]-\/>m\_core\_id\ ==\ core\_id\ \&\&\ (*\textcolor{keyword}{this})[idx]-\/>m\_mem\_component\ ==\ mem\_component)}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ idx;}
\DoxyCodeLine{00096\ \ \ \ LOG\_PRINT\_ERROR(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00097\ \}}
\DoxyCodeLine{00098\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \textcolor{keywordtype}{void}\ CacheMasterCntlr::createSetLocks(UInt32\ cache\_block\_size,\ UInt32\ num\_sets,\ UInt32\ core\_offset,\ UInt32\ num\_cores)}
\DoxyCodeLine{00101\ \{}
\DoxyCodeLine{00102\ \ \ \ m\_log\_blocksize\ =\ floorLog2(cache\_block\_size);}
\DoxyCodeLine{00103\ \ \ \ m\_num\_sets\ =\ num\_sets;}
\DoxyCodeLine{00104\ \ \ \ m\_setlocks.resize(m\_num\_sets,\ SetLock(core\_offset,\ num\_cores));}
\DoxyCodeLine{00105\ \}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ SetLock*}
\DoxyCodeLine{00108\ CacheMasterCntlr::getSetLock(IntPtr\ addr)}
\DoxyCodeLine{00109\ \{}
\DoxyCodeLine{00110\ \ \ \ \textcolor{keywordflow}{return}\ \&m\_setlocks.at((addr\ >>\ m\_log\_blocksize)\ \&\ (m\_num\_sets-\/1));}
\DoxyCodeLine{00111\ \}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00114\ CacheMasterCntlr::createATDs(String\ name,\ String\ configName,\ core\_id\_t\ master\_core\_id,\ UInt32\ shared\_cores,\ UInt32\ size,}
\DoxyCodeLine{00115\ \ \ \ UInt32\ associativity,\ UInt32\ block\_size,\ String\ replacement\_policy,\ CacheBase::hash\_t\ hash\_function)}
\DoxyCodeLine{00116\ \{}
\DoxyCodeLine{00117\ \ \ \ \textcolor{comment}{//\ Instantiate\ an\ ATD\ for\ each\ sharing\ core}}
\DoxyCodeLine{00118\ \ \ \ \textcolor{keywordflow}{for}(UInt32\ core\_id\ =\ master\_core\_id;\ core\_id\ <\ master\_core\_id\ +\ shared\_cores;\ ++core\_id)}
\DoxyCodeLine{00119\ \ \ \ \{}
\DoxyCodeLine{00120\ \ \ \ \ \ \ m\_atds.push\_back(\textcolor{keyword}{new}\ ATD(name\ +\ \textcolor{stringliteral}{"{}.atd"{}},\ configName,\ core\_id,\ size,\ associativity,\ block\_size,\ replacement\_policy,\ hash\_function));}
\DoxyCodeLine{00121\ \ \ \ \}}
\DoxyCodeLine{00122\ \}}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00125\ CacheMasterCntlr::accessATDs(Core::mem\_op\_t\ mem\_op\_type,\ \textcolor{keywordtype}{bool}\ hit,\ IntPtr\ address,\ UInt32\ core\_num)}
\DoxyCodeLine{00126\ \{}
\DoxyCodeLine{00127\ \ \ \ \textcolor{keywordflow}{if}\ (m\_atds.size())}
\DoxyCodeLine{00128\ \ \ \ \ \ \ m\_atds[core\_num]-\/>access(mem\_op\_type,\ hit,\ address);}
\DoxyCodeLine{00129\ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ CacheMasterCntlr::\string~CacheMasterCntlr()}
\DoxyCodeLine{00132\ \{}
\DoxyCodeLine{00133\ \ \ \ \textcolor{keyword}{delete}\ m\_cache;}
\DoxyCodeLine{00134\ \ \ \ \textcolor{keywordflow}{for}(std::vector<ATD*>::iterator\ it\ =\ m\_atds.begin();\ it\ !=\ m\_atds.end();\ ++it)}
\DoxyCodeLine{00135\ \ \ \ \{}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \textcolor{keyword}{delete}\ *it;}
\DoxyCodeLine{00137\ \ \ \ \}}
\DoxyCodeLine{00138\ \}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ CacheCntlr::CacheCntlr(MemComponent::component\_t\ mem\_component,}
\DoxyCodeLine{00141\ \ \ \ \ \ \ String\ name,}
\DoxyCodeLine{00142\ \ \ \ \ \ \ core\_id\_t\ core\_id,}
\DoxyCodeLine{00143\ \ \ \ \ \ \ MemoryManager*\ memory\_manager,}
\DoxyCodeLine{00144\ \ \ \ \ \ \ AddressHomeLookup*\ tag\_directory\_home\_lookup,}
\DoxyCodeLine{00145\ \ \ \ \ \ \ Semaphore*\ user\_thread\_sem,}
\DoxyCodeLine{00146\ \ \ \ \ \ \ Semaphore*\ network\_thread\_sem,}
\DoxyCodeLine{00147\ \ \ \ \ \ \ UInt32\ cache\_block\_size,}
\DoxyCodeLine{00148\ \ \ \ \ \ \ CacheParameters\ \&\ cache\_params,}
\DoxyCodeLine{00149\ \ \ \ \ \ \ ShmemPerfModel*\ shmem\_perf\_model,}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_last\_level\_cache):}
\DoxyCodeLine{00151\ \ \ \ m\_mem\_component(mem\_component),}
\DoxyCodeLine{00152\ \ \ \ m\_memory\_manager(memory\_manager),}
\DoxyCodeLine{00153\ \ \ \ m\_next\_cache\_cntlr(NULL),}
\DoxyCodeLine{00154\ \ \ \ m\_last\_level(NULL),}
\DoxyCodeLine{00155\ \ \ \ m\_tag\_directory\_home\_lookup(tag\_directory\_home\_lookup),}
\DoxyCodeLine{00156\ \ \ \ m\_perfect(cache\_params.perfect),}
\DoxyCodeLine{00157\ \ \ \ m\_passthrough(Sim()-\/>getCfg()-\/>getBoolArray(\textcolor{stringliteral}{"{}perf\_model/"{}}\ +\ cache\_params.configName\ +\ \textcolor{stringliteral}{"{}/passthrough"{}},\ core\_id)),}
\DoxyCodeLine{00158\ \ \ \ m\_coherent(cache\_params.coherent),}
\DoxyCodeLine{00159\ \ \ \ m\_prefetch\_on\_prefetch\_hit(false),}
\DoxyCodeLine{00160\ \ \ \ m\_l1\_mshr(cache\_params.outstanding\_misses\ >\ 0),}
\DoxyCodeLine{00161\ \ \ \ m\_l1\_metadata\_mshr(cache\_params.outstanding\_misses\ >\ 0),}
\DoxyCodeLine{00162\ \ \ \ m\_core\_id(core\_id),}
\DoxyCodeLine{00163\ \ \ \ m\_cache\_block\_size(cache\_block\_size),}
\DoxyCodeLine{00164\ \ \ \ m\_cache\_writethrough(cache\_params.writethrough),}
\DoxyCodeLine{00165\ \ \ \ m\_writeback\_time(cache\_params.writeback\_time),}
\DoxyCodeLine{00166\ \ \ \ m\_next\_level\_read\_bandwidth(cache\_params.next\_level\_read\_bandwidth),}
\DoxyCodeLine{00167\ \ \ \ m\_shared\_cores(cache\_params.shared\_cores),}
\DoxyCodeLine{00168\ \ \ \ m\_user\_thread\_sem(user\_thread\_sem),}
\DoxyCodeLine{00169\ \ \ \ m\_network\_thread\_sem(network\_thread\_sem),}
\DoxyCodeLine{00170\ \ \ \ m\_last\_remote\_hit\_where(HitWhere::UNKNOWN),}
\DoxyCodeLine{00171\ \ \ \ m\_shmem\_perf(new\ ShmemPerf()),}
\DoxyCodeLine{00172\ \ \ \ m\_shmem\_perf\_global(NULL),}
\DoxyCodeLine{00173\ \ \ \ m\_shmem\_perf\_model(shmem\_perf\_model),}
\DoxyCodeLine{00174\ \ \ \ metadata\_passthrough\_loc(Sim()-\/>getCfg()-\/>getInt(\textcolor{stringliteral}{"{}perf\_model/metadata/passthrough\_loc"{}}))}
\DoxyCodeLine{00175\ \{}
\DoxyCodeLine{00176\ \ \ \ m\_core\_id\_master\ =\ m\_core\_id\ -\/\ m\_core\_id\ \%\ m\_shared\_cores;}
\DoxyCodeLine{00177\ \ \ \ Sim()-\/>getStatsManager()-\/>logTopology(name,\ core\_id,\ m\_core\_id\_master);}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \ LOG\_ASSERT\_ERROR(!Sim()-\/>getCfg()-\/>hasKey(\textcolor{stringliteral}{"{}perf\_model/perfect\_llc"{}}),}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}perf\_model/perfect\_llc\ is\ deprecated,\ use\ perf\_model/lX\_cache/perfect\ instead"{}});}
\DoxyCodeLine{00181\ \ \ \ \textcolor{keywordflow}{if}\ (is\_last\_level\_cache)}
\DoxyCodeLine{00182\ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(m\_passthrough\ ==\ \textcolor{keyword}{false},\ \textcolor{stringliteral}{"{}Cache\ pass-\/through\ not\ supported\ on\ last-\/level\ cache"{}});}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \ \ \ \textcolor{keywordflow}{if}\ (isMasterCache())}
\DoxyCodeLine{00185\ \ \ \ \{}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \textcolor{comment}{/*\ Master\ cache\ */}}
\DoxyCodeLine{00187\ \ \ \ \ \ \ m\_master\ =\ \textcolor{keyword}{new}\ CacheMasterCntlr(name,\ core\_id,\ cache\_params.outstanding\_misses);}
\DoxyCodeLine{00188\ \ \ \ \ \ \ m\_master-\/>m\_cache\ =\ \textcolor{keyword}{new}\ Cache(name,}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}perf\_model/"{}}\ +\ cache\_params.configName,}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ m\_core\_id,}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ cache\_params.num\_sets,}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ cache\_params.associativity,}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \ \ \ \ m\_cache\_block\_size,}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ cache\_params.replacement\_policy,}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ CacheBase::SHARED\_CACHE,}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \ \ CacheBase::parseAddressHash(cache\_params.hash\_function),}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ Sim()-\/>getFaultinjectionManager()}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ?\ Sim()-\/>getFaultinjectionManager()-\/>getFaultInjector(m\_core\_id\_master,\ mem\_component)}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ NULL);}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ }
\DoxyCodeLine{00204\ \ \ \ \ \ \ m\_master-\/>m\_prefetcher\ =\ Prefetcher::createPrefetcher(cache\_params.prefetcher,\ cache\_params.configName,\ m\_core\_id,\ m\_shared\_cores);}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (Sim()-\/>getCfg()-\/>getBoolDefault(\textcolor{stringliteral}{"{}perf\_model/"{}}\ +\ cache\_params.configName\ +\ \textcolor{stringliteral}{"{}/atd/enabled"{}},\ \textcolor{keyword}{false}))}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ m\_master-\/>createATDs(name,}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}perf\_model/"{}}\ +\ cache\_params.configName,}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_core\_id,}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_shared\_cores,}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cache\_params.num\_sets,}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cache\_params.associativity,}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_cache\_block\_size,}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cache\_params.replacement\_policy,}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CacheBase::parseAddressHash(cache\_params.hash\_function));}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00219\ \ \ \ \ \ \ \textcolor{comment}{//Sim()-\/>getHooksManager()-\/>registerHook(HookType::HOOK\_ROI\_END,\ \_\_walkUsageBits,\ (UInt64)this,\ HooksManager::ORDER\_NOTIFY\_PRE);}}
\DoxyCodeLine{00220\ \ \ \ \}}
\DoxyCodeLine{00221\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00222\ \ \ \ \{}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \textcolor{comment}{/*\ Shared,\ non-\/master\ cache,\ we're\ just\ a\ proxy\ */}}
\DoxyCodeLine{00224\ \ \ \ \ \ \ m\_master\ =\ getMemoryManager()-\/>getCacheCntlrAt(m\_core\_id\_master,\ mem\_component)-\/>m\_master;}
\DoxyCodeLine{00225\ \ \ \ \}}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_prefetcher)}
\DoxyCodeLine{00228\ \ \ \ \ \ \ m\_prefetch\_on\_prefetch\_hit\ =\ Sim()-\/>getCfg()-\/>getBoolArray(\textcolor{stringliteral}{"{}perf\_model/"{}}\ +\ cache\_params.configName\ +\ \textcolor{stringliteral}{"{}/prefetcher/prefetch\_on\_prefetch\_hit"{}},\ core\_id);}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ \ bzero(\&stats,\ \textcolor{keyword}{sizeof}(stats));}
\DoxyCodeLine{00231\ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}tloads"{}}),\ \&stats.tloads);}
\DoxyCodeLine{00232\ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}tstores"{}}),\ \&stats.tstores);}
\DoxyCodeLine{00233\ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}tload-\/misses"{}}),\ \&stats.tload\_misses);}
\DoxyCodeLine{00234\ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}tstore-\/misses"{}}),\ \&stats.tstore\_misses);}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ \ \textcolor{keywordflow}{for}(CacheBlockInfo::block\_type\_t\ type=CacheBlockInfo::block\_type\_t::PAGE\_TABLE;type<CacheBlockInfo::block\_type\_t::NUM\_BLOCK\_TYPES;type=\ CacheBlockInfo::block\_type\_t(\textcolor{keywordtype}{int}(type)+1))\{}
\DoxyCodeLine{00239\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}loads-\/"{}})+BlockTypeString(type),\ \&stats.loads[type]);}
\DoxyCodeLine{00240\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}stores-\/"{}})+BlockTypeString(type),\ \&stats.stores[type]);}
\DoxyCodeLine{00241\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}load-\/misses-\/"{}})+BlockTypeString(type),\ \&stats.load\_misses[type]);}
\DoxyCodeLine{00242\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}store-\/misses-\/"{}})+BlockTypeString(type),\ \&stats.store\_misses[type]);}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \textcolor{comment}{//\ Does\ not\ work\ for\ loads,\ since\ the\ interval\ core\ model\ doesn't\ issue\ the\ loads\ until\ after\ the\ first\ miss\ has\ completed}}
\DoxyCodeLine{00244\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}load-\/overlapping-\/misses-\/"{}})\ +\ BlockTypeString(type),\ \&stats.load\_overlapping\_misses[type]);}
\DoxyCodeLine{00245\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}store-\/overlapping-\/misses-\/"{}})+BlockTypeString(type),\ \&stats.store\_overlapping\_misses[type]);}
\DoxyCodeLine{00246\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}loads-\/prefetch-\/"{}})+BlockTypeString(type),\ \&stats.loads\_prefetch[type]);}
\DoxyCodeLine{00247\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}stores-\/prefetch-\/"{}})+BlockTypeString(type),\ \&stats.stores\_prefetch[type]);}
\DoxyCodeLine{00248\ \ \ \ \}}
\DoxyCodeLine{00249\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}hits-\/prefetch"{}},\ \&stats.hits\_prefetch);}
\DoxyCodeLine{00250\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}evict-\/prefetch"{}},\ \&stats.evict\_prefetch);}
\DoxyCodeLine{00251\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}invalidate-\/prefetch"{}},\ \&stats.invalidate\_prefetch);}
\DoxyCodeLine{00252\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}hits-\/warmup"{}},\ \&stats.hits\_warmup);}
\DoxyCodeLine{00253\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}evict-\/warmup"{}},\ \&stats.evict\_warmup);}
\DoxyCodeLine{00254\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}invalidate-\/warmup"{}},\ \&stats.invalidate\_warmup);}
\DoxyCodeLine{00255\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}total-\/latency"{}},\ \&stats.total\_latency);}
\DoxyCodeLine{00256\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}snoop-\/latency"{}},\ \&stats.snoop\_latency);}
\DoxyCodeLine{00257\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}qbs-\/query-\/latency"{}},\ \&stats.qbs\_query\_latency);}
\DoxyCodeLine{00258\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}mshr-\/latency"{}},\ \&stats.mshr\_latency);}
\DoxyCodeLine{00259\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}metadata-\/mshr-\/latency"{}},\ \&stats.metadata\_mshr\_latency);}
\DoxyCodeLine{00260\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}prefetches"{}},\ \&stats.prefetches);}
\DoxyCodeLine{00261\ \ \ \ }
\DoxyCodeLine{00262\ \ \ \ \textcolor{keywordflow}{for}(CacheState::cstate\_t\ state\ =\ CacheState::CSTATE\_FIRST;\ state\ <\ CacheState::NUM\_CSTATE\_STATES;\ state\ =\ CacheState::cstate\_t(\textcolor{keywordtype}{int}(state)+1))\ \{}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheBlockInfo::block\_type\_t\ type=CacheBlockInfo::block\_type\_t::PAGE\_TABLE;type<CacheBlockInfo::block\_type\_t::NUM\_BLOCK\_TYPES;type=\ CacheBlockInfo::block\_type\_t(\textcolor{keywordtype}{int}(type)+1))\{}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}loads-\/"{}})+CStateString(state)+String(\textcolor{stringliteral}{"{}-\/"{}})+BlockTypeString(type),\ \&stats.loads\_state[state][type]);}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}stores-\/"{}})\ +\ CStateString(state)+String(\textcolor{stringliteral}{"{}-\/"{}})\ +\ BlockTypeString(type),\ \&stats.stores\_state[state][type]);}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}load-\/misses-\/"{}})\ +\ CStateString(state)\ +String(\textcolor{stringliteral}{"{}-\/"{}})+\ BlockTypeString(type),\ \&stats.load\_misses\_state[state][type]);}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}store-\/misses-\/"{}})\ +\ CStateString(state)+String(\textcolor{stringliteral}{"{}-\/"{}})\ +\ BlockTypeString(type),\ \&stats.store\_misses\_state[state][type]);}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00270\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00271\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}evict-\/"{}})\ +\ CStateString(state),\ \&stats.evict[state]);}
\DoxyCodeLine{00272\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}backinval-\/"{}})\ +\ CStateString(state),\ \&stats.backinval[state]);}
\DoxyCodeLine{00273\ \ \ \ \}}
\DoxyCodeLine{00274\ \ \ \ }
\DoxyCodeLine{00275\ \ \ \ \textcolor{keywordflow}{if}\ (mem\_component\ ==\ MemComponent::L1\_ICACHE\ ||\ mem\_component\ ==\ MemComponent::L1\_DCACHE)\ \{}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(HitWhere::where\_t\ hit\_where\ =\ HitWhere::WHERE\_FIRST;\ hit\_where\ <\ HitWhere::NUM\_HITWHERES;\ hit\_where\ =\ HitWhere::where\_t(\textcolor{keywordtype}{int}(hit\_where)+1))\ \{}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ where\_str\ =\ HitWhereString(hit\_where);}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (where\_str[0]\ ==\ \textcolor{charliteral}{'?'})\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}loads-\/where-\/"{}})+where\_str,\ \&stats.loads\_where[hit\_where]);}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}loads-\/where-\/page-\/table-\/"{}})+where\_str,\ \&stats.loads\_where\_page\_table[hit\_where]);}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}loads-\/where-\/utopia"{}})+where\_str,\ \&stats.loads\_where\_utopia[hit\_where]);}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}stores-\/where-\/"{}})+where\_str,\ \&stats.stores\_where[hit\_where]);}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00285\ \ \ \ \}}
\DoxyCodeLine{00286\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}coherency-\/downgrades"{}},\ \&stats.coherency\_downgrades);}
\DoxyCodeLine{00287\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}coherency-\/upgrades"{}},\ \&stats.coherency\_upgrades);}
\DoxyCodeLine{00288\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}coherency-\/writebacks"{}},\ \&stats.coherency\_writebacks);}
\DoxyCodeLine{00289\ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}coherency-\/invalidates"{}},\ \&stats.coherency\_invalidates);}
\DoxyCodeLine{00290\ \textcolor{preprocessor}{\#ifdef\ ENABLE\_TRANSITIONS}}
\DoxyCodeLine{00291\ \ \ \ \textcolor{keywordflow}{for}(CacheState::cstate\_t\ old\_state\ =\ CacheState::CSTATE\_FIRST;\ old\_state\ <\ CacheState::NUM\_CSTATE\_STATES;\ old\_state\ =\ CacheState::cstate\_t(\textcolor{keywordtype}{int}(old\_state)+1))}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheState::cstate\_t\ new\_state\ =\ CacheState::CSTATE\_FIRST;\ new\_state\ <\ CacheState::NUM\_CSTATE\_STATES;\ new\_state\ =\ CacheState::cstate\_t(\textcolor{keywordtype}{int}(new\_state)+1))}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}transitions-\/"{}})+CStateString(old\_state)+\textcolor{stringliteral}{"{}-\/"{}}+CStateString(new\_state),\ \&stats.transitions[old\_state][new\_state]);}
\DoxyCodeLine{00294\ \ \ \ \textcolor{keywordflow}{for}(Transition::reason\_t\ reason\ =\ Transition::REASON\_FIRST;\ reason\ <\ Transition::NUM\_REASONS;\ reason\ =\ Transition::reason\_t(\textcolor{keywordtype}{int}(reason)+1))}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheState::cstate\_t\ old\_state\ =\ CacheState::CSTATE\_FIRST;\ old\_state\ <\ CacheState::NUM\_CSTATE\_SPECIAL\_STATES;\ old\_state\ =\ CacheState::cstate\_t(\textcolor{keywordtype}{int}(old\_state)+1))}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheState::cstate\_t\ new\_state\ =\ CacheState::CSTATE\_FIRST;\ new\_state\ <\ CacheState::NUM\_CSTATE\_SPECIAL\_STATES;\ new\_state\ =\ CacheState::cstate\_t(\textcolor{keywordtype}{int}(new\_state)+1))}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}transitions-\/"{}})+ReasonString(reason)+\textcolor{stringliteral}{"{}-\/"{}}+CStateString(old\_state)+\textcolor{stringliteral}{"{}-\/"{}}+CStateString(new\_state),\ \&stats.transition\_reasons[reason][old\_state][new\_state]);}
\DoxyCodeLine{00298\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00299\ \ \ \ \textcolor{keywordflow}{if}\ (is\_last\_level\_cache)}
\DoxyCodeLine{00300\ \ \ \ \{}
\DoxyCodeLine{00301\ \ \ \ \ \ \ m\_shmem\_perf\_global\ =\ \textcolor{keyword}{new}\ ShmemPerf();}
\DoxyCodeLine{00302\ \ \ \ \ \ \ m\_shmem\_perf\_totaltime\ =\ SubsecondTime::Zero();}
\DoxyCodeLine{00303\ \ \ \ \ \ \ m\_shmem\_perf\_numrequests\ =\ 0;}
\DoxyCodeLine{00304\ }
\DoxyCodeLine{00305\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ ShmemPerf::NUM\_SHMEM\_TIMES;\ ++i)}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ ShmemPerf::shmem\_times\_type\_t\ reason\ =\ ShmemPerf::shmem\_times\_type\_t(i);}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ String(\textcolor{stringliteral}{"{}uncore-\/time-\/"{}})+ShmemReasonString(reason),\ \&m\_shmem\_perf\_global-\/>getComponent(reason));}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00310\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}uncore-\/totaltime"{}},\ \&m\_shmem\_perf\_totaltime);}
\DoxyCodeLine{00311\ \ \ \ \ \ \ registerStatsMetric(name,\ core\_id,\ \textcolor{stringliteral}{"{}uncore-\/requests"{}},\ \&m\_shmem\_perf\_numrequests);}
\DoxyCodeLine{00312\ \ \ \ \}}
\DoxyCodeLine{00313\ \ \ \ }
\DoxyCodeLine{00314\ \}}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ CacheCntlr::\string~CacheCntlr()}
\DoxyCodeLine{00317\ \{}
\DoxyCodeLine{00318\ \ \ \ \textcolor{keywordflow}{if}\ (isMasterCache())}
\DoxyCodeLine{00319\ \ \ \ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \textcolor{keyword}{delete}\ m\_master;}
\DoxyCodeLine{00321\ \ \ \ \}}
\DoxyCodeLine{00322\ \ \ \ \textcolor{keyword}{delete}\ m\_shmem\_perf;}
\DoxyCodeLine{00323\ \ \ \ \textcolor{keywordflow}{if}\ (m\_shmem\_perf\_global)}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \textcolor{keyword}{delete}\ m\_shmem\_perf\_global;}
\DoxyCodeLine{00325\ \textcolor{preprocessor}{\ \ \ \#ifdef\ TRACK\_LATENCY\_BY\_HITWHERE}}
\DoxyCodeLine{00326\ \ \ \ \textcolor{keywordflow}{for}(std::unordered\_map<HitWhere::where\_t,\ StatHist>::iterator\ it\ =\ lat\_by\_where.begin();\ it\ !=\ lat\_by\_where.end();\ ++it)\ \{}
\DoxyCodeLine{00327\ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\%2u-\/\%s:\ "{}},\ m\_core\_id,\ HitWhereString(it-\/>first));}
\DoxyCodeLine{00328\ \ \ \ \ \ \ it-\/>second.print();}
\DoxyCodeLine{00329\ \ \ \ \}}
\DoxyCodeLine{00330\ \textcolor{preprocessor}{\ \ \ \#endif}}
\DoxyCodeLine{00331\ \}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00334\ CacheCntlr::setPrevCacheCntlrs(CacheCntlrList\&\ prev\_cache\_cntlrs)}
\DoxyCodeLine{00335\ \{}
\DoxyCodeLine{00336\ \ \ \ \textcolor{comment}{/*\ Append\ our\ prev\_caches\ list\ to\ the\ master\ one\ (only\ master\ nodes)\ */}}
\DoxyCodeLine{00337\ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ prev\_cache\_cntlrs.begin();\ it\ !=\ prev\_cache\_cntlrs.end();\ it++)}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((*it)-\/>isMasterCache())}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_prev\_cache\_cntlrs.push\_back(*it);}
\DoxyCodeLine{00340\ \textcolor{preprocessor}{\ \ \ \#ifdef\ ENABLE\_TRACK\_SHARING\_PREVCACHES}}
\DoxyCodeLine{00341\ \ \ \ LOG\_ASSERT\_ERROR(m\_master-\/>m\_prev\_cache\_cntlrs.size()\ <=\ MAX\_NUM\_PREVCACHES,\ \textcolor{stringliteral}{"{}shared\ locations\ vector\ too\ small,\ increase\ MAX\_NUM\_PREVCACHES\ to\ at\ least\ \%u"{}},\ m\_master-\/>m\_prev\_cache\_cntlrs.size());}
\DoxyCodeLine{00342\ \textcolor{preprocessor}{\ \ \ \#endif}}
\DoxyCodeLine{00343\ \}}
\DoxyCodeLine{00344\ }
\DoxyCodeLine{00345\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00346\ CacheCntlr::setDRAMDirectAccess(DramCntlrInterface*\ dram\_cntlr,\ UInt64\ num\_outstanding)}
\DoxyCodeLine{00347\ \{}
\DoxyCodeLine{00348\ \ \ \ m\_master-\/>m\_dram\_cntlr\ =\ dram\_cntlr;}
\DoxyCodeLine{00349\ \ \ \ m\_master-\/>m\_dram\_outstanding\_writebacks\ =\ \textcolor{keyword}{new}\ ContentionModel(\textcolor{stringliteral}{"{}llc-\/evict-\/queue"{}},\ m\_core\_id,\ num\_outstanding);}
\DoxyCodeLine{00350\ \}}
\DoxyCodeLine{00351\ }
\DoxyCodeLine{00352\ }
\DoxyCodeLine{00353\ \textcolor{comment}{/*****************************************************************************}}
\DoxyCodeLine{00354\ \textcolor{comment}{\ *\ operations\ called\ by\ core\ on\ first-\/level\ cache}}
\DoxyCodeLine{00355\ \textcolor{comment}{\ *****************************************************************************/}}
\DoxyCodeLine{00356\ }
\DoxyCodeLine{00357\ HitWhere::where\_t}
\DoxyCodeLine{00358\ CacheCntlr::processMemOpFromCore(}
\DoxyCodeLine{00359\ \ \ \ \ \ \ IntPtr\ eip,}
\DoxyCodeLine{00360\ \ \ \ \ \ \ Core::lock\_signal\_t\ lock\_signal,}
\DoxyCodeLine{00361\ \ \ \ \ \ \ Core::mem\_op\_t\ mem\_op\_type,}
\DoxyCodeLine{00362\ \ \ \ \ \ \ IntPtr\ ca\_address,\ UInt32\ offset,}
\DoxyCodeLine{00363\ \ \ \ \ \ \ Byte*\ data\_buf,\ UInt32\ data\_length,}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ modeled,}
\DoxyCodeLine{00365\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ count,CacheBlockInfo::block\_type\_t\ block\_type,SubsecondTime\ TLB\_latency,\ UtopiaCache\ *shadow\_cache,}
\DoxyCodeLine{00366\ \ \ \ \ \ \ Core::mem\_origin\_t\ mem\_origin)}
\DoxyCodeLine{00367\ \{}
\DoxyCodeLine{00368\ }
\DoxyCodeLine{00369\ \ \ \ HitWhere::where\_t\ hit\_where\ =\ HitWhere::MISS;}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00371\ \ \ \ \textcolor{keywordtype}{bool}\ metadata\_request=\ (block\_type==CacheBlockInfo::block\_type\_t::PAGE\_TABLE)\ }
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ (block\_type==CacheBlockInfo::block\_type\_t::PAGE\_TABLE\_PASSTHROUGH)}
\DoxyCodeLine{00373\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ (block\_type==CacheBlockInfo::block\_type\_t::SECURITY)}
\DoxyCodeLine{00374\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ (block\_type==CacheBlockInfo::block\_type\_t::EXPRESSIVE)\ }
\DoxyCodeLine{00375\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ (block\_type==CacheBlockInfo::block\_type\_t::TLB\_ENTRY)\ }
\DoxyCodeLine{00376\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ (block\_type==CacheBlockInfo::block\_type\_t::TLB\_ENTRY\_PASSTHROUGH);}
\DoxyCodeLine{00377\ }
\DoxyCodeLine{00378\ \ \ \ \textcolor{comment}{//\ if(metadata\_request)}}
\DoxyCodeLine{00379\ \ \ \ \textcolor{comment}{//\ \{}}
\DoxyCodeLine{00380\ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ //std::cout\ <<\ "{}Mem\ op\ from\ core\ metadata:\ address\ "{}\ <<\ ca\_address\ <<\ std::endl;\ \ \ }}
\DoxyCodeLine{00381\ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00382\ }
\DoxyCodeLine{00383\ \ \ \ \textcolor{comment}{//\ Protect\ against\ concurrent\ access\ from\ sibling\ SMT\ threads}}
\DoxyCodeLine{00384\ \ \ \ ScopedLock\ sl\_smt(m\_master-\/>m\_smt\_lock);}
\DoxyCodeLine{00385\ \ \ \ }
\DoxyCodeLine{00386\ \ \ \ LOG\_PRINT(\textcolor{stringliteral}{"{}processMemOpFromCore(),\ lock\_signal(\%u),\ mem\_op\_type(\%u),\ ca\_address(0x\%x)"{}},}
\DoxyCodeLine{00387\ \ \ \ \ \ \ \ \ \ \ \ \ \ lock\_signal,\ mem\_op\_type,\ ca\_address);}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00389\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/"{}});}
\DoxyCodeLine{00390\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}\%c\%c\ \%lx+\%u..+\%u"{}},\ mem\_op\_type\ ==\ Core::WRITE\ ?\ \textcolor{charliteral}{'W'}\ :\ \textcolor{charliteral}{'R'},\ mem\_op\_type\ ==\ Core::READ\_EX\ ?\ \textcolor{charliteral}{'X'}\ :\ \textcolor{charliteral}{'\ '},\ ca\_address,\ offset,\ data\_length);}
\DoxyCodeLine{00391\ }
\DoxyCodeLine{00392\ \ \ \ LOG\_ASSERT\_ERROR((ca\_address\ \&\ (getCacheBlockSize()\ -\/\ 1))\ ==\ 0,\ \textcolor{stringliteral}{"{}address\ at\ cache\ line\ +\ \%x"{}},\ ca\_address\ \&\ (getCacheBlockSize()\ -\/\ 1));}
\DoxyCodeLine{00393\ \ \ \ LOG\_ASSERT\_ERROR(offset\ +\ data\_length\ <=\ getCacheBlockSize(),\ \textcolor{stringliteral}{"{}access\ until\ \%u\ >\ \%u"{}},\ offset\ +\ data\_length,\ getCacheBlockSize());}
\DoxyCodeLine{00394\ }
\DoxyCodeLine{00395\ \textcolor{preprocessor}{\ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{00396\ \ \ \ \textcolor{comment}{/*\ if\ this\ is\ the\ second\ part\ of\ an\ atomic\ operation:\ we\ already\ have\ the\ lock,\ don't\ lock\ again\ */}}
\DoxyCodeLine{00397\ \ \ \ \textcolor{keywordflow}{if}\ (lock\_signal\ !=\ Core::UNLOCK)}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Trying\ to\ lock\ 373\ \(\backslash\)n"{}\ <<\ std::endl;}}
\DoxyCodeLine{00399\ \ \ \ \ \ \ acquireLock(ca\_address);}
\DoxyCodeLine{00400\ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Locked\ successfully\ 375\(\backslash\)n"{}\ <<\ std::endl;}}
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00402\ \textcolor{preprocessor}{\ \ \ \#else}}
\DoxyCodeLine{00403\ \ \ \ \textcolor{comment}{/*\ if\ we'll\ need\ the\ next\ level\ (because\ we're\ a\ writethrough\ cache,\ and\ either\ this\ is\ a\ write}}
\DoxyCodeLine{00404\ \textcolor{comment}{\ \ \ \ \ \ or\ we're\ part\ of\ an\ atomic\ pair\ in\ which\ this\ or\ the\ other\ memop\ is\ potentially\ a\ write):}}
\DoxyCodeLine{00405\ \textcolor{comment}{\ \ \ \ \ \ make\ sure\ to\ lock\ it\ now,\ so\ the\ cache\ line\ in\ L2\ doesn't\ fall\ from\ under\ us}}
\DoxyCodeLine{00406\ \textcolor{comment}{\ \ \ \ \ \ between\ operationPermissibleinCache\ and\ the\ writethrough\ */}}
\DoxyCodeLine{00407\ \ \ \ \textcolor{keywordtype}{bool}\ lock\_all\ =\ m\_cache\_writethrough\ \&\&\ ((mem\_op\_type\ ==\ Core::WRITE)\ ||\ (lock\_signal\ !=\ Core::NONE));}
\DoxyCodeLine{00408\ }
\DoxyCodeLine{00409\ \ \ \ \ \textcolor{comment}{/*\ if\ this\ is\ the\ second\ part\ of\ an\ atomic\ operation:\ we\ already\ have\ the\ lock,\ don't\ lock\ again\ */}}
\DoxyCodeLine{00410\ \ \ \ \textcolor{keywordflow}{if}\ (lock\_signal\ !=\ Core::UNLOCK)\ \{}
\DoxyCodeLine{00411\ \ \ \ \ \ \ }
\DoxyCodeLine{00412\ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Trying\ to\ lock\ 387\ \(\backslash\)n"{}\ <<\ std::endl;}}
\DoxyCodeLine{00413\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lock\_all)}
\DoxyCodeLine{00414\ \ \ \ \ \ \ \ \ \ acquireStackLock(ca\_address);}
\DoxyCodeLine{00415\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \ \ \ acquireLock(ca\_address);}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00418\ \ \ \ \}}
\DoxyCodeLine{00419\ \textcolor{preprocessor}{\ \ \ \#endif}}
\DoxyCodeLine{00420\ }
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00422\ \ \ \ SubsecondTime\ t\_start\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00423\ \ \ }
\DoxyCodeLine{00424\ \ \ \ UtopiaCache::where\_t\ shadow\_cache\_lookup;}
\DoxyCodeLine{00425\ \ \ \ \textcolor{keywordtype}{bool}\ shadow\_cache\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00426\ }
\DoxyCodeLine{00427\ \ \ \ \textcolor{keywordflow}{if}(shadow\_cache\ \&\&\ metadata\_request)\{}
\DoxyCodeLine{00428\ \ \ \ \ \ \ }
\DoxyCodeLine{00429\ \ \ \ \ \ \ \textcolor{comment}{//\ For\ page\ table\ metadata:\ perform\ lookup\ inside\ the\ shadow\ cache\ }}
\DoxyCodeLine{00430\ \ \ \ \ \ \ shadow\_cache\_lookup\ =\ shadow\_cache-\/>lookup(ca\_address,\ t\_start,\ \textcolor{keyword}{true},\ count);}
\DoxyCodeLine{00431\ \ \ \ \ \ \ }
\DoxyCodeLine{00432\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(shadow\_cache\_lookup\ ==\ UtopiaCache::where\_t::HIT)}
\DoxyCodeLine{00433\ \ \ \ \ \ \ \ \ \ shadow\_cache\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00434\ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Shadow\_cache\ lookup:\ "{}\ <<\ shadow\_cache\_hit\ <<\ std::endl;\ }}
\DoxyCodeLine{00435\ \ \ \ \}}
\DoxyCodeLine{00436\ }
\DoxyCodeLine{00437\ }
\DoxyCodeLine{00438\ \ \ \ \textcolor{keywordtype}{bool}\ cache\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00439\ \ \ \ \textcolor{keywordtype}{bool}\ prefetch\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00440\ \ \ \ CacheBlockInfo\ *cache\_block\_info;}
\DoxyCodeLine{00441\ }
\DoxyCodeLine{00442\ \ \ \ \textcolor{keywordflow}{if}(!shadow\_cache\ ||\ !metadata\_request)\{}
\DoxyCodeLine{00443\ \ \ \ \ \ \ }
\DoxyCodeLine{00444\ \ \ \ \ \ \ cache\_hit\ =\ operationPermissibleinCache(ca\_address,\ mem\_op\_type,\ \&cache\_block\_info);}
\DoxyCodeLine{00445\ \ \ \ }
\DoxyCodeLine{00446\ \ \ \ \}}
\DoxyCodeLine{00447\ }
\DoxyCodeLine{00448\ \ \ \ }
\DoxyCodeLine{00449\ \ \ \ \textcolor{keywordflow}{if}\ (!cache\_hit\ \&\&\ m\_perfect)}
\DoxyCodeLine{00450\ \ \ \ \{}
\DoxyCodeLine{00451\ \ \ \ \ \ \ cache\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00452\ \ \ \ \ \ \ hit\_where\ =\ HitWhere::where\_t(m\_mem\_component);}
\DoxyCodeLine{00453\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info)}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>setCState(CacheState::MODIFIED);}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \ \ \ insertCacheBlock(ca\_address,\ mem\_op\_type\ ==\ Core::READ\ ?\ CacheState::SHARED\ :\ CacheState::MODIFIED,\ NULL,\ m\_core\_id,\ ShmemPerfModel::\_USER\_THREAD,\ block\_type);}
\DoxyCodeLine{00458\ \ \ \ \ \ \ \ \ \ cache\_block\_info\ =\ getCacheBlockInfo(ca\_address);}
\DoxyCodeLine{00459\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00460\ \ \ \ \}}
\DoxyCodeLine{00461\ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\ cache\_hit\ \&\&\ m\_passthrough\ )}
\DoxyCodeLine{00462\ \ \ \ \{}
\DoxyCodeLine{00463\ \ \ \ \ \ \ cache\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00464\ \ \ \ \ \ \ cache\_block\_info-\/>invalidate();}
\DoxyCodeLine{00465\ \ \ \ \ \ \ cache\_block\_info\ =\ NULL;}
\DoxyCodeLine{00466\ \ \ \ \}}
\DoxyCodeLine{00467\ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}(\ cache\_hit\ \&\&\ \ metadata\_request\ \&\&\ (metadata\_passthrough\_loc\ !=\ 1)\ )\{}
\DoxyCodeLine{00468\ }
\DoxyCodeLine{00469\ \ \ \ \ \ \ cache\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00470\ \ \ \ \ \ \ cache\_block\_info-\/>invalidate();}
\DoxyCodeLine{00471\ \ \ \ \ \ \ cache\_block\_info\ =\ NULL;}
\DoxyCodeLine{00472\ \ \ \ }
\DoxyCodeLine{00473\ \ \ \ \}}
\DoxyCodeLine{00474\ }
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00476\ \ \ \ \textcolor{keywordflow}{if}\ (count\ \&\&\ !(shadow\_cache\ \&\&\ metadata\_request))}
\DoxyCodeLine{00477\ \ \ \ \{}
\DoxyCodeLine{00478\ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00479\ \ \ \ \ \ \ \textcolor{comment}{//\ Update\ the\ Cache\ Counters}}
\DoxyCodeLine{00480\ \ \ \ \ \ \ getCache()-\/>updateCounters(cache\_hit);}
\DoxyCodeLine{00481\ \ \ \ \ \ \ updateCounters(mem\_op\_type,\ ca\_address,\ cache\_hit,\ getCacheState(cache\_block\_info),\ block\_type,Prefetch::NONE);}
\DoxyCodeLine{00482\ \ \ \ \}}
\DoxyCodeLine{00483\ }
\DoxyCodeLine{00484\ \ \ }
\DoxyCodeLine{00485\ }
\DoxyCodeLine{00486\ \ \ \ \textcolor{keywordflow}{if}\ (cache\_hit)}
\DoxyCodeLine{00487\ \ \ \ \{}
\DoxyCodeLine{00488\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}L1\ hit"{}});}
\DoxyCodeLine{00489\ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_DATA\_AND\_TAGS,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00490\ \ \ \ \ \ \ hit\_where\ =\ (HitWhere::where\_t)m\_mem\_component;}
\DoxyCodeLine{00491\ }
\DoxyCodeLine{00492\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>hasOption(CacheBlockInfo::WARMUP)\ \&\&\ Sim()-\/>getInstrumentationMode()\ !=\ InstMode::CACHE\_ONLY)}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \ \ \ stats.hits\_warmup++;}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>clearOption(CacheBlockInfo::WARMUP);}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00497\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>hasOption(CacheBlockInfo::PREFETCH))}
\DoxyCodeLine{00498\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ line\ was\ fetched\ by\ the\ prefetcher\ and\ has\ proven\ useful}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ \ stats.hits\_prefetch++;}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ \ prefetch\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>clearOption(CacheBlockInfo::PREFETCH);}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00504\ }
\DoxyCodeLine{00505\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled\ \&\&\ m\_l1\_mshr\ \&\&\ m\_l1\_metadata\_mshr)}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00507\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!metadata\_request)\{}
\DoxyCodeLine{00508\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00509\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00510\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_completed\ =\ m\_master-\/>m\_l1\_mshr.getTagCompletionTime(ca\_address);}
\DoxyCodeLine{00511\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (t\_completed\ !=\ SubsecondTime::MaxTime()\ \&\&\ t\_completed\ >\ t\_now)}
\DoxyCodeLine{00512\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00513\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mem\_op\_type\ ==\ Core::WRITE)}
\DoxyCodeLine{00514\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.store\_overlapping\_misses[CacheBlockInfo::block\_type\_t::NON\_PAGE\_TABLE];}
\DoxyCodeLine{00515\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00516\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.load\_overlapping\_misses[CacheBlockInfo::block\_type\_t::NON\_PAGE\_TABLE];}
\DoxyCodeLine{00517\ }
\DoxyCodeLine{00518\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ t\_completed\ -\/\ t\_now;}
\DoxyCodeLine{00519\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getShmemPerfModel()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00520\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}(modeled\ \&\&\ m\_l1\_mshr)\{}
\DoxyCodeLine{00523\ }
\DoxyCodeLine{00524\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00525\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00526\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_completed\ =\ m\_master-\/>m\_l1\_metadata\_mshr.getTagCompletionTime(ca\_address);}
\DoxyCodeLine{00527\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (t\_completed\ !=\ SubsecondTime::MaxTime()\ \&\&\ t\_completed\ >\ t\_now)}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mem\_op\_type\ ==\ Core::WRITE)}
\DoxyCodeLine{00530\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.store\_overlapping\_misses[block\_type];}
\DoxyCodeLine{00531\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00532\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.load\_overlapping\_misses[block\_type];}
\DoxyCodeLine{00533\ }
\DoxyCodeLine{00534\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ t\_completed\ -\/\ t\_now;}
\DoxyCodeLine{00535\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getShmemPerfModel()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00536\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00537\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00538\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00539\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00540\ }
\DoxyCodeLine{00541\ }
\DoxyCodeLine{00542\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled)}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*std::cout<<"{}MSHR\(\backslash\)n"{};}}
\DoxyCodeLine{00545\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ for\ (int\ i\ =\ 0;\ i\ <\ m\_master-\/>mshr.size();\ i++)}}
\DoxyCodeLine{00546\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \{}}
\DoxyCodeLine{00547\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ std::cout<<"{}Mshr\ Entry:"{}<<m\_master-\/>mshr[i].t\_issue<<"{}\ "{}<<m\_master-\/>mshr[i].t\_complete<<"{}\(\backslash\)n"{};}}
\DoxyCodeLine{00548\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \}*/}}
\DoxyCodeLine{00549\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!metadata\_request)\{}
\DoxyCodeLine{00550\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ hit,\ but\ maybe\ the\ prefetcher\ filled\ it\ at\ a\ future\ time\ stamp.\ If\ so,\ delay.}}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>mshr.count(ca\_address)}
\DoxyCodeLine{00554\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&\&\ (m\_master-\/>mshr[ca\_address].t\_issue\ <\ t\_now\ \&\&\ m\_master-\/>mshr[ca\_address].t\_complete\ >\ t\_now))}
\DoxyCodeLine{00555\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00556\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ m\_master-\/>mshr[ca\_address].t\_complete\ -\/\ t\_now;}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stats.mshr\_latency\ +=\ latency;}
\DoxyCodeLine{00558\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00559\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00560\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ hit,\ but\ maybe\ the\ prefetcher\ filled\ it\ at\ a\ future\ time\ stamp.\ If\ so,\ delay.}}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00565\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>metadata\_mshr.count(ca\_address)}
\DoxyCodeLine{00566\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&\&\ (m\_master-\/>metadata\_mshr[ca\_address].t\_issue\ <\ t\_now\ \&\&\ m\_master-\/>metadata\_mshr[ca\_address].t\_complete\ >\ t\_now))}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ m\_master-\/>metadata\_mshr[ca\_address].t\_complete\ -\/\ t\_now;}
\DoxyCodeLine{00569\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stats.metadata\_mshr\_latency\ +=\ latency;}
\DoxyCodeLine{00570\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00571\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00572\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00573\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00574\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00575\ }
\DoxyCodeLine{00576\ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00577\ \ \ \ \ \ \ \textcolor{comment}{/*\ cache\ miss:\ either\ wrong\ coherency\ state\ or\ not\ present\ in\ the\ cache\ */}}
\DoxyCodeLine{00578\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}L1\ miss"{}});}
\DoxyCodeLine{00579\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_passthrough\ \&\&\ !(block\_type\ ==\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY\_PASSTHROUGH))}
\DoxyCodeLine{00580\ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_TAGS,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00581\ }
\DoxyCodeLine{00582\ \ \ \ \ \ \ SubsecondTime\ t\_miss\_begin\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00583\ \ \ \ \ \ \ SubsecondTime\ t\_mshr\_avail\ =\ t\_miss\_begin;}
\DoxyCodeLine{00584\ }
\DoxyCodeLine{00585\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled\ \&\&\ m\_l1\_mshr\ \&\&\ !m\_passthrough\ \&\&\ m\_l1\_metadata\_mshr\ \&\&\ !(block\_type\ ==\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY\_PASSTHROUGH))}
\DoxyCodeLine{00586\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00587\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!metadata\_request)\{}
\DoxyCodeLine{00588\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00589\ \ \ \ \ \ \ \ \ \ \ \ \ t\_mshr\_avail\ =\ m\_master-\/>m\_l1\_mshr.getStartTime(t\_miss\_begin);}
\DoxyCodeLine{00590\ \ \ \ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(t\_mshr\_avail\ >=\ t\_miss\_begin,\ \textcolor{stringliteral}{"{}t\_mshr\_avail\ <\ t\_miss\_begin"{}});}
\DoxyCodeLine{00591\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ mshr\_latency\ =\ t\_mshr\_avail\ -\/\ t\_miss\_begin;}
\DoxyCodeLine{00592\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Delay\ until\ we\ have\ an\ empty\ slot\ in\ the\ MSHR}}
\DoxyCodeLine{00593\ \ \ \ \ \ \ \ \ \ \ \ \ getShmemPerfModel()-\/>incrElapsedTime(mshr\_latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00594\ \ \ \ \ \ \ \ \ \ \ \ \ stats.mshr\_latency\ +=\ mshr\_latency;}
\DoxyCodeLine{00595\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00596\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{00597\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00598\ \ \ \ \ \ \ \ \ \ \ \ \ t\_mshr\_avail\ =\ m\_master-\/>m\_l1\_metadata\_mshr.getStartTime(t\_miss\_begin);}
\DoxyCodeLine{00599\ \ \ \ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(t\_mshr\_avail\ >=\ t\_miss\_begin,\ \textcolor{stringliteral}{"{}t\_mshr\_avail\ <\ t\_miss\_begin"{}});}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ mshr\_latency\ =\ t\_mshr\_avail\ -\/\ t\_miss\_begin;}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Delay\ until\ we\ have\ an\ empty\ slot\ in\ the\ MSHR}}
\DoxyCodeLine{00602\ \ \ \ \ \ \ \ \ \ \ \ \ getShmemPerfModel()-\/>incrElapsedTime(mshr\_latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00603\ \ \ \ \ \ \ \ \ \ \ \ \ stats.metadata\_mshr\_latency\ +=\ mshr\_latency;}
\DoxyCodeLine{00604\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00605\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00606\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00607\ }
\DoxyCodeLine{00608\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lock\_signal\ ==\ Core::UNLOCK)}
\DoxyCodeLine{00609\ \ \ \ \ \ \ \ \ \ LOG\_PRINT\_ERROR(\textcolor{stringliteral}{"{}Expected\ to\ find\ address(0x\%x)\ in\ L1\ Cache"{}},\ ca\_address);}
\DoxyCodeLine{00610\ }
\DoxyCodeLine{00611\ \textcolor{preprocessor}{\ \ \ \ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{00612\ \textcolor{preprocessor}{\ \ \ \ \ \ \#else}}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!lock\_all)}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \ \ \ acquireStackLock(ca\_address,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00615\ \textcolor{preprocessor}{\ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00616\ }
\DoxyCodeLine{00617\ \ \ \ \ \ \ \textcolor{comment}{//\ Invalidate\ the\ cache\ block\ before\ passing\ the\ request\ to\ L2\ Cache}}
\DoxyCodeLine{00618\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (getCacheState(ca\_address)\ !=\ CacheState::INVALID)}
\DoxyCodeLine{00619\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00620\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Invalidate:\ "{}\ <<\ \_\_LINE\_\_\ <<\ std::endl;}}
\DoxyCodeLine{00621\ \ \ \ \ \ \ \ \ \ invalidateCacheBlock(ca\_address);}
\DoxyCodeLine{00622\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00623\ }
\DoxyCodeLine{00624\ }
\DoxyCodeLine{00625\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}processMemOpFromCore\ l\%d\ before\ next"{}},\ m\_mem\_component);}
\DoxyCodeLine{00626\ \ \ \ \ \ \ hit\_where\ =\ m\_next\_cache\_cntlr-\/>processShmemReqFromPrevCache(eip,\ \textcolor{keyword}{this},\ mem\_op\_type,\ ca\_address,\ modeled,\ count,block\_type,\ Prefetch::NONE,\ t\_start,\ \textcolor{keyword}{false},\ mem\_origin);}
\DoxyCodeLine{00627\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ next\_cache\_hit\ =\ hit\_where\ !=\ HitWhere::MISS;}
\DoxyCodeLine{00628\ \ \ \ \ \ \ \textcolor{comment}{//\ if(hit\_where\ !=\ HitWhere::MISS\ \&\&\ metadata\_request\ \&\&\ \ (metadata\_passthrough\_loc\ >\ 2))}}
\DoxyCodeLine{00629\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ std::cout\ <<\ "{}Metadata\ hit\ in\ L2\ on\ address:"{}\ <<\ \ ca\_address\ <<\ std::endl;}}
\DoxyCodeLine{00630\ }
\DoxyCodeLine{00631\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}processMemOpFromCore\ l\%d\ next\ hit\ =\ \%d"{}},\ m\_mem\_component,\ next\_cache\_hit);}
\DoxyCodeLine{00632\ }
\DoxyCodeLine{00633\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (next\_cache\_hit)\ \{}
\DoxyCodeLine{00634\ }
\DoxyCodeLine{00635\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00636\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ last\ level\ miss,\ a\ message\ has\ been\ sent.\ */}}
\DoxyCodeLine{00637\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00638\ }
\DoxyCodeLine{00639\ \ \ \ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}processMemOpFromCore\ l\%d\ waiting\ for\ sent\ message"{}},\ m\_mem\_component);}
\DoxyCodeLine{00640\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{00641\ \ \ \ \ \ \ \ \ \ \ \ \ releaseLock(ca\_address);}
\DoxyCodeLine{00642\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#else}}
\DoxyCodeLine{00643\ \ \ \ \ \ \ \ \ \ \ \ \ releaseStackLock(ca\_address);}
\DoxyCodeLine{00644\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00645\ \ \ \ \ \ \ \ \ \ \ \ \ waitForNetworkThread();}
\DoxyCodeLine{00646\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00647\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}processMemOpFromCore\ l\%d\ postwakeup"{}},\ m\_mem\_component);}
\DoxyCodeLine{00648\ }
\DoxyCodeLine{00649\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//acquireStackLock(ca\_address);}}
\DoxyCodeLine{00650\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Pass\ stack\ lock\ through\ from\ network\ thread}}
\DoxyCodeLine{00651\ }
\DoxyCodeLine{00652\ \ \ \ \ \ \ \ \ \ \ \ \ wakeUpNetworkThread();}
\DoxyCodeLine{00653\ \ \ \ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}processMemOpFromCore\ l\%d\ got\ message\ reply"{}},\ m\_mem\_component);}
\DoxyCodeLine{00654\ }
\DoxyCodeLine{00655\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ have\ the\ next\ cache\ levels\ fill\ themselves\ with\ the\ new\ data\ */}}
\DoxyCodeLine{00656\ \ \ \ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}processMemOpFromCore\ l\%d\ before\ next\ fill"{}},\ m\_mem\_component);}
\DoxyCodeLine{00657\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//if(!(metadata\_request\ \&\&\ \ (metadata\_passthrough\_loc\ >\ 2)))\ //If\ L2\ is\ passthrough,\ then\ we\ wont\ find\ the\ data\ inside\ the\ L2}}
\DoxyCodeLine{00658\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ hit\_where\ =\ m\_next\_cache\_cntlr-\/>processShmemReqFromPrevCache(eip,\ \textcolor{keyword}{this},\ mem\_op\_type,\ ca\_address,\ \textcolor{keyword}{false},\ \textcolor{keyword}{false},block\_type,\ Prefetch::NONE,\ t\_start,\ \textcolor{keyword}{true},\ mem\_origin);}
\DoxyCodeLine{00659\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00660\ \ \ \ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}processMemOpFromCore\ l\%d\ after\ next\ fill"{}},\ m\_mem\_component);}
\DoxyCodeLine{00661\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00662\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!(metadata\_request\ \&\&\ \ (metadata\_passthrough\_loc\ >\ 2)))\ \textcolor{comment}{//If\ L2\ is\ passthrough,\ then\ we\ wont\ find\ the\ data\ inside\ the\ L2}}
\DoxyCodeLine{00663\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(hit\_where\ !=\ HitWhere::MISS,}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Tried\ to\ read\ in\ next-\/level\ cache,\ but\ data\ is\ already\ gone"{}});}
\DoxyCodeLine{00665\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00666\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{00667\ \ \ \ \ \ \ \ \ \ releaseStackLock(ca\_address,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00668\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#else}}
\DoxyCodeLine{00669\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00670\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00671\ }
\DoxyCodeLine{00672\ }
\DoxyCodeLine{00673\ \ \ \ \ \ \ \textcolor{comment}{/*\ data\ should\ now\ be\ in\ next-\/level\ cache,\ go\ get\ it\ */}}
\DoxyCodeLine{00674\ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00675\ }
\DoxyCodeLine{00676\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ !(metadata\_request\ \&\&\ (metadata\_passthrough\_loc\ !=1))\ )}
\DoxyCodeLine{00677\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00678\ }
\DoxyCodeLine{00679\ \ \ \ \ \ \ \ \ \ copyDataFromNextLevel(mem\_op\_type,\ ca\_address,\ modeled,\ t\_now,\ block\_type);}
\DoxyCodeLine{00680\ }
\DoxyCodeLine{00681\ \ \ \ \ \ \ \ \ \ cache\_block\_info\ =\ getCacheBlockInfo(ca\_address);}
\DoxyCodeLine{00682\ }
\DoxyCodeLine{00683\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{00684\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#else}}
\DoxyCodeLine{00685\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!lock\_all)}
\DoxyCodeLine{00686\ \ \ \ \ \ \ \ \ \ \ \ \ releaseStackLock(ca\_address,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00687\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00688\ }
\DoxyCodeLine{00689\ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(operationPermissibleinCache(ca\_address,\ mem\_op\_type),}
\DoxyCodeLine{00690\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Expected\ \%x\ to\ be\ valid\ in\ L1"{}},\ ca\_address);}
\DoxyCodeLine{00691\ \ \ \ }
\DoxyCodeLine{00692\ }
\DoxyCodeLine{00693\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled\ \&\&\ m\_l1\_mshr\ \&\&\ !m\_passthrough\ \&\&\ m\_l1\_metadata\_mshr)}
\DoxyCodeLine{00694\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00695\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!metadata\_request)\{}
\DoxyCodeLine{00696\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_miss\_end\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00697\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00698\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_l1\_mshr.getCompletionTime(t\_miss\_begin,\ t\_miss\_end\ -\/\ t\_mshr\_avail,\ ca\_address);}
\DoxyCodeLine{00699\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00700\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{00701\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_miss\_end\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00702\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00703\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_l1\_metadata\_mshr.getCompletionTime(t\_miss\_begin,\ t\_miss\_end\ -\/\ t\_mshr\_avail,\ ca\_address);}
\DoxyCodeLine{00704\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00705\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00706\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00707\ \ \ \ \ \ \ }
\DoxyCodeLine{00708\ \ \ \ \ \ \ }
\DoxyCodeLine{00709\ \ \ \ \ \ \ }
\DoxyCodeLine{00710\ }
\DoxyCodeLine{00711\ \ \ \ \ \ \ \textcolor{comment}{//Change\ Sim()-\/>getConfig()-\/>hasCacheEfficiencyCallbacks()}}
\DoxyCodeLine{00712\ \ \ \ \ \ \ \textcolor{comment}{//\ if\ (modeled\ \&\&\ m\_next\_cache\_cntlr\ \&\&\ !m\_perfect\ \&\&\ Sim()-\/>getConfig()-\/>hasCacheEfficiencyCallbacks())}}
\DoxyCodeLine{00713\ \ \ \ \ \ \ \textcolor{comment}{//\ \{}}
\DoxyCodeLine{00714\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ bool\ new\_bits\ =\ cache\_block\_info-\/>updateUsage(offset,\ data\_length);}}
\DoxyCodeLine{00715\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ if\ (new\_bits)}}
\DoxyCodeLine{00716\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \{}}
\DoxyCodeLine{00717\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>updateUsageBits(ca\_address,\ cache\_block\_info-\/>getUsage());}}
\DoxyCodeLine{00718\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \}}}
\DoxyCodeLine{00719\ \ \ \ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00720\ }
\DoxyCodeLine{00721\ \ \ \ \ \ \ \textcolor{comment}{//\ Change\ Sim()-\/>getConfig()-\/>hasCacheEfficiencyCallbacks()}}
\DoxyCodeLine{00722\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled\ \&\&\ m\_next\_cache\_cntlr\ \&\&\ !m\_perfect\ \&\&\ Sim()-\/>getCfg()-\/>getBool(\textcolor{stringliteral}{"{}perf\_model/cache\_usage/enabled"{}}))}
\DoxyCodeLine{00723\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00724\ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ new\_bits\ =\ cache\_block\_info-\/>updateUsage(offset,\ data\_length);}
\DoxyCodeLine{00725\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_bits)}
\DoxyCodeLine{00726\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00727\ \ \ \ \ \ \ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>updateUsageBits(ca\_address,\ cache\_block\_info-\/>getUsage());}
\DoxyCodeLine{00728\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00729\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00730\ }
\DoxyCodeLine{00731\ \ \ \ \ \ \ \textcolor{comment}{//do\ access\ cache\ only\ if\ L1\ is\ not\ a\ passthrough\ cache}}
\DoxyCodeLine{00732\ \ \ \ \ \ \ \ \ \ accessCache(mem\_op\_type,\ ca\_address,\ offset,\ data\_buf,\ data\_length,\ hit\_where\ ==\ HitWhere::where\_t(m\_mem\_component)\ \&\&\ count);}
\DoxyCodeLine{00733\ \ \ \ }
\DoxyCodeLine{00734\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00735\ \ \ \ }
\DoxyCodeLine{00736\ \ \ \ \}}
\DoxyCodeLine{00737\ }
\DoxyCodeLine{00738\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}access\ done"{}});}
\DoxyCodeLine{00739\ }
\DoxyCodeLine{00740\ }
\DoxyCodeLine{00741\ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00742\ \ \ \ SubsecondTime\ total\_latency\ =\ t\_now\ -\/\ t\_start;}
\DoxyCodeLine{00743\ }
\DoxyCodeLine{00744\ \ \ \ \textcolor{comment}{//\ From\ here\ on\ downwards:\ not\ long\ anymore,\ only\ stats\ update\ so\ blanket\ cntrl\ lock}}
\DoxyCodeLine{00745\ \ \ \ \{}
\DoxyCodeLine{00746\ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00747\ }
\DoxyCodeLine{00748\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\ cache\_hit\ \&\&\ count)\ \{}
\DoxyCodeLine{00749\ \ \ \ \ \ \ \ \ \ stats.total\_latency\ +=\ total\_latency;}
\DoxyCodeLine{00750\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00751\ }
\DoxyCodeLine{00752\ \textcolor{preprocessor}{\ \ \ \ \ \ \#ifdef\ TRACK\_LATENCY\_BY\_HITWHERE}}
\DoxyCodeLine{00753\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (count)}
\DoxyCodeLine{00754\ \ \ \ \ \ \ \ \ \ lat\_by\_where[hit\_where].update(total\_latency.getNS());}
\DoxyCodeLine{00755\ \textcolor{preprocessor}{\ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00756\ }
\DoxyCodeLine{00757\ \ \ \ \ \ \ \textcolor{comment}{/*\ if\ this\ is\ the\ first\ part\ of\ an\ atomic\ operation:\ keep\ the\ lock(s)\ */}}
\DoxyCodeLine{00758\ \textcolor{preprocessor}{\ \ \ \ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{00759\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lock\_signal\ !=\ Core::LOCK)}
\DoxyCodeLine{00760\ \ \ \ \ \ \ \ \ \ releaseLock(ca\_address);}
\DoxyCodeLine{00761\ \textcolor{preprocessor}{\ \ \ \ \ \ \#else}}
\DoxyCodeLine{00762\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lock\_signal\ !=\ Core::LOCK)\ \{}
\DoxyCodeLine{00763\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lock\_all)}
\DoxyCodeLine{00764\ \ \ \ \ \ \ \ \ \ \ \ \ releaseStackLock(ca\_address);}
\DoxyCodeLine{00765\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00766\ \ \ \ \ \ \ \ \ \ \ \ \ releaseLock(ca\_address);}
\DoxyCodeLine{00767\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00768\ \textcolor{preprocessor}{\ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00769\ }
\DoxyCodeLine{00770\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mem\_op\_type\ ==\ Core::WRITE)}
\DoxyCodeLine{00771\ \ \ \ \ \ \ \ \ \ stats.stores\_where[hit\_where]++;}
\DoxyCodeLine{00772\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00773\ \ \ \ \ \ \ \ \ \ stats.loads\_where[hit\_where]++;}
\DoxyCodeLine{00774\ }
\DoxyCodeLine{00775\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(block\_type\ ==\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE)}
\DoxyCodeLine{00776\ \ \ \ \ \ \ \ \ \ stats.loads\_where\_page\_table[hit\_where]++;}
\DoxyCodeLine{00777\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::UTOPIA)}
\DoxyCodeLine{00778\ \ \ \ \ \ \ \ \ \ stats.loads\_where\_utopia[hit\_where]++;}
\DoxyCodeLine{00779\ }
\DoxyCodeLine{00780\ \ \ \ \}}
\DoxyCodeLine{00781\ \ \ \ SubsecondTime\ t\_end\_final\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00782\ \ \ \ getShmemPerfModel()-\/>incrElapsedTime(TLB\_latency,ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00783\ }
\DoxyCodeLine{00784\ \ \ \textcolor{comment}{//\ std::cout\ <<\ "{}Metadata\ request"{}\ <<\ metadata\_request\ <<\ std::endl;}}
\DoxyCodeLine{00785\ }
\DoxyCodeLine{00786\ \ \ \ \textcolor{keywordflow}{if}(!metadata\_request)\{}
\DoxyCodeLine{00787\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled\ \&\&\ m\_master-\/>m\_prefetcher)}
\DoxyCodeLine{00788\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00789\ \ \ \ \ \ \ \ \ \ trainPrefetcher(eip,\ ca\_address,\ mem\_op\_type,\ cache\_hit,\ prefetch\_hit,\ t\_start);}
\DoxyCodeLine{00790\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00791\ }
\DoxyCodeLine{00792\ \ \ \ \ \ \ \textcolor{comment}{//\ Call\ Prefetch\ on\ next-\/level\ caches\ (but\ not\ for\ atomic\ instructions\ as\ that\ causes\ a\ locking\ mess)}}
\DoxyCodeLine{00793\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lock\_signal\ !=\ Core::LOCK\ \&\&\ modeled)}
\DoxyCodeLine{00794\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00795\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Let's\ prefetch\(\backslash\)n"{};}}
\DoxyCodeLine{00796\ \ \ \ \ \ \ \ \ \ Prefetch(eip,\ t\_start);}
\DoxyCodeLine{00797\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00798\ \ \ \ \}}
\DoxyCodeLine{00799\ \ \ \ }
\DoxyCodeLine{00800\ \ \ \ }
\DoxyCodeLine{00801\ \ \ \ \textcolor{comment}{//\ if\ (Sim()-\/>getConfig()-\/>getCacheEfficiencyCallbacks().notify\_access\_func)}}
\DoxyCodeLine{00802\ \ \ \ \textcolor{comment}{//\ \ \ \ Sim()-\/>getConfig()-\/>getCacheEfficiencyCallbacks().call\_notify\_access(cache\_block\_info-\/>getOwner(),\ mem\_op\_type,\ hit\_where);}}
\DoxyCodeLine{00803\ }
\DoxyCodeLine{00804\ \ \ \ }
\DoxyCodeLine{00805\ }
\DoxyCodeLine{00806\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}returning\ \%s,\ latency\ \%lu\ ns,\ and\ with\ translation\ latency\ \%lu"{}},\ HitWhereString(hit\_where),\ total\_latency.getNS(),TLB\_latency.getNS());}
\DoxyCodeLine{00807\ \ \ \ }
\DoxyCodeLine{00808\ \ \ \ \textcolor{keywordflow}{return}\ hit\_where;}
\DoxyCodeLine{00809\ \}}
\DoxyCodeLine{00810\ }
\DoxyCodeLine{00811\ }
\DoxyCodeLine{00812\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00813\ CacheCntlr::updateHits(Core::mem\_op\_t\ mem\_op\_type,\ UInt64\ hits)}
\DoxyCodeLine{00814\ \{}
\DoxyCodeLine{00815\ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00816\ }
\DoxyCodeLine{00817\ \ \ \ \textcolor{keywordflow}{while}(hits\ >\ 0)}
\DoxyCodeLine{00818\ \ \ \ \{}
\DoxyCodeLine{00819\ \ \ \ \ \ \ getCache()-\/>updateCounters(\textcolor{keyword}{true});}
\DoxyCodeLine{00820\ \ \ \ \ \ \ updateCounters(mem\_op\_type,\ 0,\ \textcolor{keyword}{true},\ mem\_op\_type\ ==\ Core::READ\ ?\ CacheState::SHARED\ :\ CacheState::MODIFIED,\ CacheBlockInfo::block\_type\_t::NON\_PAGE\_TABLE,Prefetch::NONE);}
\DoxyCodeLine{00821\ \ \ \ \ \ \ hits-\/-\/;}
\DoxyCodeLine{00822\ \ \ \ \}}
\DoxyCodeLine{00823\ \}}
\DoxyCodeLine{00824\ }
\DoxyCodeLine{00825\ }
\DoxyCodeLine{00826\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00827\ CacheCntlr::copyDataFromNextLevel(Core::mem\_op\_t\ mem\_op\_type,\ IntPtr\ address,\ \textcolor{keywordtype}{bool}\ modeled,\ SubsecondTime\ t\_now,\ CacheBlockInfo::block\_type\_t\ block\_type)}
\DoxyCodeLine{00828\ \{}
\DoxyCodeLine{00829\ \ \ \ \textcolor{comment}{//\ TODO:\ what\ if\ it's\ already\ gone?\ someone\ else\ may\ invalitate\ it\ between\ the\ time\ it\ arrived\ an\ when\ we\ get\ here...}}
\DoxyCodeLine{00830\ \ \ \ LOG\_ASSERT\_ERROR(m\_next\_cache\_cntlr-\/>operationPermissibleinCache(address,\ mem\_op\_type),}
\DoxyCodeLine{00831\ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Tried\ to\ read\ from\ next-\/level\ cache,\ but\ data\ is\ already\ gone"{}});}
\DoxyCodeLine{00832\ MYLOG(\textcolor{stringliteral}{"{}copyDataFromNextLevel\ l\%d"{}},\ m\_mem\_component);}
\DoxyCodeLine{00833\ }
\DoxyCodeLine{00834\ \ \ \ Byte\ data\_buf[m\_next\_cache\_cntlr-\/>getCacheBlockSize()];}
\DoxyCodeLine{00835\ \ \ \ m\_next\_cache\_cntlr-\/>retrieveCacheBlock(address,\ data\_buf,\ ShmemPerfModel::\_USER\_THREAD,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00836\ }
\DoxyCodeLine{00837\ \ \ \ CacheState::cstate\_t\ cstate\ =\ m\_next\_cache\_cntlr-\/>getCacheState(address);}
\DoxyCodeLine{00838\ \ \ \ \textcolor{comment}{//CacheBlockInfo::block\_type\_t\ block\_type\ =\ m\_next\_cache\_cntlr-\/>getCacheBlockType(address);}}
\DoxyCodeLine{00839\ }
\DoxyCodeLine{00840\ \ \ \ \textcolor{comment}{//\ TODO:\ increment\ time?\ tag\ access\ on\ next\ level,\ also\ data\ access\ if\ this\ is\ not\ an\ upgrade}}
\DoxyCodeLine{00841\ }
\DoxyCodeLine{00842\ \ \ \ \textcolor{keywordflow}{if}\ (modeled\ \&\&\ !m\_next\_level\_read\_bandwidth.isInfinite())}
\DoxyCodeLine{00843\ \ \ \ \{}
\DoxyCodeLine{00844\ \ \ \ \ \ \ SubsecondTime\ delay\ =\ m\_next\_level\_read\_bandwidth.getRoundedLatency(getCacheBlockSize()\ *\ 8);}
\DoxyCodeLine{00845\ \ \ \ \ \ \ SubsecondTime\ t\_done\ =\ m\_master-\/>m\_next\_level\_read\_bandwidth.getCompletionTime(t\_now,\ delay);}
\DoxyCodeLine{00846\ \ \ \ \ \ \ \textcolor{comment}{//\ Assume\ cache\ access\ time\ already\ contains\ transfer\ latency,\ increment\ time\ by\ contention\ delay\ only}}
\DoxyCodeLine{00847\ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(t\_done\ >=\ t\_now\ +\ delay,\ \textcolor{stringliteral}{"{}Did\ not\ expect\ next-\/level\ cache\ to\ be\ this\ fast"{}});}
\DoxyCodeLine{00848\ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(t\_done\ -\/\ t\_now\ -\/\ delay,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00849\ \ \ \ \}}
\DoxyCodeLine{00850\ }
\DoxyCodeLine{00851\ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{00852\ \ \ \ }
\DoxyCodeLine{00853\ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info)}
\DoxyCodeLine{00854\ \ \ \ \{}
\DoxyCodeLine{00855\ \ \ \ \ \ \ \textcolor{comment}{//\ Block\ already\ present\ (upgrade):\ don't\ insert,\ but\ update}}
\DoxyCodeLine{00856\ \ \ \ \ \ \ \textcolor{comment}{//\ @RBERA:\ should\ we\ update\ cache\ block\ type\ too?}}
\DoxyCodeLine{00857\ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Update\ Cache\ Block:\ "{}\ <<\ \_\_LINE\_\_\ <<\ "{}\ "{}<<CStateString(cstate)<<std::endl;}}
\DoxyCodeLine{00858\ \ \ \ \ \ \ updateCacheBlock(address,\ cstate,\ Transition::UPGRADE,\ NULL,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{00859\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}copyDataFromNextLevel\ l\%d\ done\ (updated)"{}},\ m\_mem\_component);}
\DoxyCodeLine{00860\ \ \ \ \}}
\DoxyCodeLine{00861\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00862\ \ \ \ \{}
\DoxyCodeLine{00863\ \ \ \ \ \ \ \textcolor{comment}{//\ Insert\ the\ Cache\ Block\ in\ our\ own\ cache}}
\DoxyCodeLine{00864\ \ \ \ \ \ \ insertCacheBlock(address,\ cstate,\ data\_buf,\ m\_core\_id,\ ShmemPerfModel::\_USER\_THREAD,\ block\_type);}
\DoxyCodeLine{00865\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}copyDataFromNextLevel\ l\%d\ done\ (inserted)"{}},\ m\_mem\_component);}
\DoxyCodeLine{00866\ \ \ \ \}}
\DoxyCodeLine{00867\ \}}
\DoxyCodeLine{00868\ }
\DoxyCodeLine{00869\ }
\DoxyCodeLine{00870\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00871\ CacheCntlr::trainPrefetcher(IntPtr\ eip,\ IntPtr\ address,\ Core::mem\_op\_t\ mem\_op\_type,\ \textcolor{keywordtype}{bool}\ cache\_hit,\ \textcolor{keywordtype}{bool}\ prefetch\_hit,\ SubsecondTime\ t\_issue)}
\DoxyCodeLine{00872\ \{}
\DoxyCodeLine{00873\ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00874\ }
\DoxyCodeLine{00875\ \ \ \ \textcolor{comment}{//\ Always\ train\ the\ prefetcher}}
\DoxyCodeLine{00876\ \ \ \ std::vector<IntPtr>\ prefetchList\ =\ m\_master-\/>m\_prefetcher-\/>getNextAddress(address,\ m\_core\_id,\ mem\_op\_type,\ cache\_hit,\ prefetch\_hit,\ eip);}
\DoxyCodeLine{00877\ }
\DoxyCodeLine{00878\ \ \ \ \textcolor{comment}{//\ Only\ do\ prefetches\ on\ misses,\ or\ on\ hits\ to\ lines\ previously\ brought\ in\ by\ the\ prefetcher\ (if\ enabled)}}
\DoxyCodeLine{00879\ \ \ \ \textcolor{keywordflow}{if}\ (!cache\_hit\ ||\ (m\_prefetch\_on\_prefetch\_hit\ \&\&\ prefetch\_hit))}
\DoxyCodeLine{00880\ \ \ \ \{}
\DoxyCodeLine{00881\ \ \ \ \ \ \ m\_master-\/>m\_prefetch\_list.clear();}
\DoxyCodeLine{00882\ \ \ \ \ \ \ \textcolor{comment}{//\ Just\ talked\ to\ the\ next-\/level\ cache,\ wait\ a\ bit\ before\ we\ start\ to\ prefetch}}
\DoxyCodeLine{00883\ \ \ \ \ \ \ m\_master-\/>m\_prefetch\_next\ =\ t\_issue\ +\ PREFETCH\_INTERVAL;}
\DoxyCodeLine{00884\ }
\DoxyCodeLine{00885\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(std::vector<IntPtr>::iterator\ it\ =\ prefetchList.begin();\ it\ !=\ prefetchList.end();\ ++it)}
\DoxyCodeLine{00886\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00887\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Keep\ at\ most\ PREFETCH\_MAX\_QUEUE\_LENGTH\ entries\ in\ the\ prefetch\ queue}}
\DoxyCodeLine{00888\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_prefetch\_list.size()\ >\ PREFETCH\_MAX\_QUEUE\_LENGTH)}
\DoxyCodeLine{00889\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00890\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!operationPermissibleinCache(*it,\ Core::READ))}
\DoxyCodeLine{00891\ \ \ \ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_prefetch\_list.push\_back(*it);}
\DoxyCodeLine{00892\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00893\ \ \ \ \}}
\DoxyCodeLine{00894\ \}}
\DoxyCodeLine{00895\ }
\DoxyCodeLine{00896\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00897\ CacheCntlr::Prefetch(IntPtr\ eip,SubsecondTime\ t\_now)}
\DoxyCodeLine{00898\ \{}
\DoxyCodeLine{00899\ \ \ \ IntPtr\ address\_to\_prefetch\ =\ INVALID\_ADDRESS;}
\DoxyCodeLine{00900\ \ \ \ eip\ =\ 0xdeadbeef;}
\DoxyCodeLine{00901\ }
\DoxyCodeLine{00902\ \ \ \ \{}
\DoxyCodeLine{00903\ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{00904\ }
\DoxyCodeLine{00905\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_prefetch\_next\ <=\ t\_now)}
\DoxyCodeLine{00906\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00907\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}(!m\_master-\/>m\_prefetch\_list.empty())}
\DoxyCodeLine{00908\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00909\ \ \ \ \ \ \ \ \ \ \ \ \ IntPtr\ address\ =\ m\_master-\/>m\_prefetch\_list.front();}
\DoxyCodeLine{00910\ \ \ \ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_prefetch\_list.pop\_front();}
\DoxyCodeLine{00911\ }
\DoxyCodeLine{00912\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ address\ again,\ maybe\ some\ other\ core\ already\ brought\ it\ into\ the\ cache}}
\DoxyCodeLine{00913\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!operationPermissibleinCache(address,\ Core::READ))}
\DoxyCodeLine{00914\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00915\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ address\_to\_prefetch\ =\ address;}
\DoxyCodeLine{00916\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Do\ at\ most\ one\ prefetch\ now,\ save\ the\ rest\ for\ a\ future\ call}}
\DoxyCodeLine{00917\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00918\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00919\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00920\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00921\ \ \ \ \}}
\DoxyCodeLine{00922\ }
\DoxyCodeLine{00923\ \ \ \ \textcolor{keywordflow}{if}\ (address\_to\_prefetch\ !=\ INVALID\_ADDRESS)}
\DoxyCodeLine{00924\ \ \ \ \{}
\DoxyCodeLine{00925\ \ \ \ \ \ \ doPrefetch(eip,\ address\_to\_prefetch,\ m\_master-\/>m\_prefetch\_next);}
\DoxyCodeLine{00926\ \ \ \ \ \ \ atomic\_add\_subsecondtime(m\_master-\/>m\_prefetch\_next,\ PREFETCH\_INTERVAL);}
\DoxyCodeLine{00927\ \ \ \ \}}
\DoxyCodeLine{00928\ }
\DoxyCodeLine{00929\ \ \ \ \textcolor{comment}{//\ In\ case\ the\ next-\/level\ cache\ has\ a\ prefetcher,\ run\ it}}
\DoxyCodeLine{00930\ \ \ \ \textcolor{keywordflow}{if}\ (m\_next\_cache\_cntlr)}
\DoxyCodeLine{00931\ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>Prefetch(eip,\ t\_now);}
\DoxyCodeLine{00932\ \}}
\DoxyCodeLine{00933\ }
\DoxyCodeLine{00934\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00935\ CacheCntlr::doPrefetch(IntPtr\ eip,\ IntPtr\ prefetch\_address,\ SubsecondTime\ t\_start)}
\DoxyCodeLine{00936\ \{}
\DoxyCodeLine{00937\ \ \ \ ++stats.prefetches;}
\DoxyCodeLine{00938\ \ \ \ acquireStackLock(prefetch\_address);}
\DoxyCodeLine{00939\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}prefetching\ \%lx"{}},\ prefetch\_address);}
\DoxyCodeLine{00940\ \ \ \ SubsecondTime\ t\_before\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{00941\ \ \ \ getShmemPerfModel()-\/>setElapsedTime(ShmemPerfModel::\_USER\_THREAD,\ t\_start);\ \textcolor{comment}{//\ Start\ the\ prefetch\ at\ the\ same\ time\ as\ the\ original\ miss}}
\DoxyCodeLine{00942\ \ \ \ HitWhere::where\_t\ hit\_where\ =\ processShmemReqFromPrevCache(eip,\ \textcolor{keyword}{this},\ Core::READ,\ prefetch\_address,\ \textcolor{keyword}{true},\ \textcolor{keyword}{true},CacheBlockInfo::block\_type\_t::NON\_PAGE\_TABLE,\ Prefetch::OWN,\ t\_start,\ \textcolor{keyword}{false},\ Core::mem\_origin\_t::NORMAL);}
\DoxyCodeLine{00943\ }
\DoxyCodeLine{00944\ \ \ \ \textcolor{keywordflow}{if}\ (hit\_where\ ==\ HitWhere::MISS)}
\DoxyCodeLine{00945\ \ \ \ \{}
\DoxyCodeLine{00946\ \ \ \ \ \ \ \textcolor{comment}{/*\ last\ level\ miss,\ a\ message\ has\ been\ sent.\ */}}
\DoxyCodeLine{00947\ }
\DoxyCodeLine{00948\ \ \ \ \ \ \ releaseStackLock(prefetch\_address);}
\DoxyCodeLine{00949\ \ \ \ \ \ \ waitForNetworkThread();}
\DoxyCodeLine{00950\ \ \ \ \ \ \ wakeUpNetworkThread();}
\DoxyCodeLine{00951\ }
\DoxyCodeLine{00952\ \ \ \ \ \ \ hit\_where\ =\ processShmemReqFromPrevCache(eip,\ \textcolor{keyword}{this},\ Core::READ,\ prefetch\_address,\ \textcolor{keyword}{false},\ \textcolor{keyword}{false},CacheBlockInfo::block\_type\_t::NON\_PAGE\_TABLE,\ Prefetch::OWN,\ t\_start,\ \textcolor{keyword}{false},\ Core::mem\_origin\_t::NORMAL);}
\DoxyCodeLine{00953\ }
\DoxyCodeLine{00954\ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(hit\_where\ !=\ HitWhere::MISS,\ \textcolor{stringliteral}{"{}Line\ was\ not\ there\ after\ prefetch"{}});}
\DoxyCodeLine{00955\ \ \ \ \}}
\DoxyCodeLine{00956\ }
\DoxyCodeLine{00957\ \ \ \ getShmemPerfModel()-\/>setElapsedTime(ShmemPerfModel::\_USER\_THREAD,\ t\_before);\ \textcolor{comment}{//\ Ignore\ changes\ to\ time\ made\ by\ the\ prefetch\ call}}
\DoxyCodeLine{00958\ \ \ \ releaseStackLock(prefetch\_address);}
\DoxyCodeLine{00959\ \}}
\DoxyCodeLine{00960\ }
\DoxyCodeLine{00961\ }
\DoxyCodeLine{00962\ \textcolor{comment}{/*****************************************************************************}}
\DoxyCodeLine{00963\ \textcolor{comment}{\ *\ operations\ called\ by\ cache\ on\ next-\/level\ cache}}
\DoxyCodeLine{00964\ \textcolor{comment}{\ *****************************************************************************/}}
\DoxyCodeLine{00965\ }
\DoxyCodeLine{00966\ HitWhere::where\_t}
\DoxyCodeLine{00967\ CacheCntlr::processShmemReqFromPrevCache(IntPtr\ eip,\ CacheCntlr*\ requester,\ Core::mem\_op\_t\ mem\_op\_type,\ IntPtr\ address,\ \textcolor{keywordtype}{bool}\ modeled,\ \textcolor{keywordtype}{bool}\ count,CacheBlockInfo::block\_type\_t\ block\_type,\ Prefetch::prefetch\_type\_t\ isPrefetch,\ SubsecondTime\ t\_issue,\ \textcolor{keywordtype}{bool}\ have\_write\_lock,\ Core::mem\_origin\_t\ mem\_origin)}
\DoxyCodeLine{00968\ \{}
\DoxyCodeLine{00969\ \textcolor{preprocessor}{\ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{00970\ \ \ \ \textcolor{keywordtype}{bool}\ have\_write\_lock\_internal\ =\ have\_write\_lock;}
\DoxyCodeLine{00971\ \ \ \ \textcolor{keywordflow}{if}\ (!\ have\_write\_lock\ \&\&\ m\_shared\_cores\ >\ 1)}
\DoxyCodeLine{00972\ \ \ \ \{}
\DoxyCodeLine{00973\ \ \ \ \ \ \ acquireStackLock(address,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00974\ \ \ \ \ \ \ have\_write\_lock\_internal\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00975\ \ \ \ \}}
\DoxyCodeLine{00976\ \textcolor{preprocessor}{\ \ \ \#else}}
\DoxyCodeLine{00977\ \ \ \ \textcolor{keywordtype}{bool}\ have\_write\_lock\_internal\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00978\ \textcolor{preprocessor}{\ \ \ \#endif}}
\DoxyCodeLine{00979\ \ \ \ \textcolor{comment}{//std::\ cout\ <<\ "{}Block\ type\ =\ "{}\ <<\ block\_type\ <<\ std::endl;\ }}
\DoxyCodeLine{00980\ \ \ \ \textcolor{keywordtype}{bool}\ metadata\_request\ =\ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE)\ ||\ }
\DoxyCodeLine{00981\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE\_PASSTHROUGH)\ ||\ }
\DoxyCodeLine{00982\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::SECURITY)\ ||\ }
\DoxyCodeLine{00983\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::EXPRESSIVE)\ ||\ \ }
\DoxyCodeLine{00984\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY)\ ||}
\DoxyCodeLine{00985\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY\_PASSTHROUGH);}
\DoxyCodeLine{00986\ \ \ \ }
\DoxyCodeLine{00987\ \ \ \ \textcolor{keywordtype}{bool}\ cache\_hit\ =\ operationPermissibleinCache(address,\ mem\_op\_type),\ sibling\_hit\ =\ \textcolor{keyword}{false},\ prefetch\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00988\ \ \ \ \textcolor{keywordtype}{bool}\ first\_hit\ =\ cache\_hit;}
\DoxyCodeLine{00989\ \ \ \ HitWhere::where\_t\ hit\_where\ =\ HitWhere::MISS;}
\DoxyCodeLine{00990\ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{00991\ }
\DoxyCodeLine{00992\ \ \ \ \textcolor{keywordflow}{if}\ (!cache\_hit\ \&\&\ m\_perfect)}
\DoxyCodeLine{00993\ \ \ \ \{}
\DoxyCodeLine{00994\ \ \ \ \ \ \ cache\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00995\ \ \ \ \ \ \ hit\_where\ =\ HitWhere::where\_t(m\_mem\_component);}
\DoxyCodeLine{00996\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info)}
\DoxyCodeLine{00997\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>setCState(CacheState::MODIFIED);}
\DoxyCodeLine{00998\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00999\ \ \ \ \ \ \ \ \ \ cache\_block\_info\ =\ insertCacheBlock(address,\ mem\_op\_type\ ==\ Core::READ\ ?\ CacheState::SHARED\ :\ CacheState::MODIFIED,\ NULL,\ m\_core\_id,\ ShmemPerfModel::\_USER\_THREAD,\ block\_type);}
\DoxyCodeLine{01000\ \ \ \ \}}
\DoxyCodeLine{01001\ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (cache\_hit\ \&\&\ m\_passthrough\ \&\&\ count)}
\DoxyCodeLine{01002\ \ \ \ \{}
\DoxyCodeLine{01003\ \ \ \ \ \ \ \textcolor{comment}{//\ Passthrough\ ==\ false:\ cache\ that\ always\ misses\ (except\ in\ the\ L1\ fill\ path,\ detected\ by\ count==false,\ where\ it\ should\ return\ the\ data)}}
\DoxyCodeLine{01004\ \ \ \ \ \ \ cache\_hit\ =\ first\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01005\ \ \ \ \ \ \ cache\_block\_info-\/>invalidate();}
\DoxyCodeLine{01006\ \ \ \ \ \ \ cache\_block\_info\ =\ NULL;}
\DoxyCodeLine{01007\ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(m\_next\_cache\_cntlr\ !=\ NULL,\ \textcolor{stringliteral}{"{}Cannot\ do\ passthrough\ on\ an\ LLC"{}});}
\DoxyCodeLine{01008\ \ \ \ \}}
\DoxyCodeLine{01009\ \ \ \ \textcolor{comment}{//\ else\ if\ (cache\_hit\ \&\&\ metadata\_request\ \&\&\ (metadata\_passthrough\_loc\ >\ 2))\{}}
\DoxyCodeLine{01010\ }
\DoxyCodeLine{01011\ \ \ \ \textcolor{comment}{//\ \ \ \ cache\_hit\ =\ first\_hit\ =\ false;}}
\DoxyCodeLine{01012\ \ \ \ \textcolor{comment}{//\ \ \ \ cache\_block\_info-\/>invalidate();}}
\DoxyCodeLine{01013\ \ \ \ \textcolor{comment}{//\ \ \ \ cache\_block\_info\ =\ NULL;}}
\DoxyCodeLine{01014\ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{01015\ }
\DoxyCodeLine{01016\ \ \ \ \textcolor{keywordflow}{if}\ (count)}
\DoxyCodeLine{01017\ \ \ \ \{}
\DoxyCodeLine{01018\ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01019\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isPrefetch\ ==\ Prefetch::NONE)}
\DoxyCodeLine{01020\ \ \ \ \ \ \ \ \ \ getCache()-\/>updateCounters(cache\_hit);}
\DoxyCodeLine{01021\ \ \ \ \ \ \ updateCounters(mem\_op\_type,\ address,\ cache\_hit,\ getCacheState(address),\ block\_type,isPrefetch);}
\DoxyCodeLine{01022\ \ \ \ \}}
\DoxyCodeLine{01023\ }
\DoxyCodeLine{01024\ \ \ \ \textcolor{keywordflow}{if}\ (cache\_hit)}
\DoxyCodeLine{01025\ \ \ \ \{}
\DoxyCodeLine{01026\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isPrefetch\ ==\ Prefetch::NONE\ \&\&\ cache\_block\_info-\/>hasOption(CacheBlockInfo::PREFETCH))}
\DoxyCodeLine{01027\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01028\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ line\ was\ fetched\ by\ the\ prefetcher\ and\ has\ proven\ useful}}
\DoxyCodeLine{01029\ \ \ \ \ \ \ \ \ \ stats.hits\_prefetch++;}
\DoxyCodeLine{01030\ \ \ \ \ \ \ \ \ \ prefetch\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01031\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>clearOption(CacheBlockInfo::PREFETCH);}
\DoxyCodeLine{01032\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01033\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>hasOption(CacheBlockInfo::WARMUP)\ \&\&\ Sim()-\/>getInstrumentationMode()\ !=\ InstMode::CACHE\_ONLY)}
\DoxyCodeLine{01034\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01035\ \ \ \ \ \ \ \ \ \ stats.hits\_warmup++;}
\DoxyCodeLine{01036\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>clearOption(CacheBlockInfo::WARMUP);}
\DoxyCodeLine{01037\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01038\ }
\DoxyCodeLine{01039\ \ \ \ \ \ \ \textcolor{comment}{//\ Increment\ Shared\ Mem\ Perf\ model\ cycle\ counts}}
\DoxyCodeLine{01040\ \textcolor{comment}{\ \ \ \ \ \ /******\ TODO:\ for\ the\ last-\/level\ cache,\ this\ is\ also\ done\ by\ the\ network\ thread\ when\ the\ message\ comes\ in.}}
\DoxyCodeLine{01041\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ we\ probably\ shouldn't\ do\ this\ twice\ */}}
\DoxyCodeLine{01042\ \ \ \ \ \ \ \textcolor{comment}{/*\ TODO:\ if\ we\ end\ up\ getting\ the\ data\ from\ a\ sibling\ cache,\ the\ access\ time\ might\ be\ only\ that}}
\DoxyCodeLine{01043\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ of\ the\ previous-\/level\ cache,\ not\ our\ (longer)\ access\ time\ */}}
\DoxyCodeLine{01044\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled)}
\DoxyCodeLine{01045\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01046\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!metadata\_request)\{}
\DoxyCodeLine{01047\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01048\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ hit,\ but\ maybe\ the\ prefetcher\ filled\ it\ at\ a\ future\ time\ stamp.\ If\ so,\ delay.}}
\DoxyCodeLine{01049\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01050\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>mshr.count(address)}
\DoxyCodeLine{01051\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&\&\ (m\_master-\/>mshr[address].t\_issue\ <\ t\_now\ \&\&\ m\_master-\/>mshr[address].t\_complete\ >\ t\_now))}
\DoxyCodeLine{01052\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01053\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ m\_master-\/>mshr[address].t\_complete\ -\/\ t\_now;}
\DoxyCodeLine{01054\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stats.mshr\_latency\ +=\ latency;}
\DoxyCodeLine{01055\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01056\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01057\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01058\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01059\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_DATA\_AND\_TAGS,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01060\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01061\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01062\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{01063\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01064\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ hit,\ but\ maybe\ the\ prefetcher\ filled\ it\ at\ a\ future\ time\ stamp.\ If\ so,\ delay.}}
\DoxyCodeLine{01065\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01066\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>metadata\_mshr.count(address)}
\DoxyCodeLine{01067\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&\&\ (m\_master-\/>metadata\_mshr[address].t\_issue\ <\ t\_now\ \&\&\ m\_master-\/>metadata\_mshr[address].t\_complete\ >\ t\_now))}
\DoxyCodeLine{01068\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01069\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ m\_master-\/>metadata\_mshr[address].t\_complete\ -\/\ t\_now;}
\DoxyCodeLine{01070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stats.metadata\_mshr\_latency\ +=\ latency;}
\DoxyCodeLine{01071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01072\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01073\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01074\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01075\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_DATA\_AND\_TAGS,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01076\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01077\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01078\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01079\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01080\ }
\DoxyCodeLine{01081\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mem\_op\_type\ !=\ Core::READ)\ \textcolor{comment}{//\ write\ that\ hits}}
\DoxyCodeLine{01082\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01083\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Invalidate/flush\ in\ previous\ levels\ */}}
\DoxyCodeLine{01084\ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ SubsecondTime::Zero();}
\DoxyCodeLine{01085\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.begin();\ it\ !=\ m\_master-\/>m\_prev\_cache\_cntlrs.end();\ it++)}
\DoxyCodeLine{01086\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01087\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (*it\ !=\ requester)}
\DoxyCodeLine{01088\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Update\ Cache\ Block:\ "{}\ <<\ \_\_LINE\_\_\ <<\ "{}\ "{}<<CStateString(CacheState::INVALID)<<std::endl;}}
\DoxyCodeLine{01090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::pair<SubsecondTime,\ bool>\ res\ =\ (*it)-\/>updateCacheBlock(address,\ CacheState::INVALID,\ Transition::COHERENCY,\ NULL,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ latency\ =\ getMax<SubsecondTime>(latency,\ res.first);}
\DoxyCodeLine{01092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sibling\_hit\ |=\ res.second;}
\DoxyCodeLine{01093\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01094\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01095\ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}add\ latency\ \%s,\ sibling\_hit(\%u)"{}},\ itostr(latency).c\_str(),\ sibling\_hit);}
\DoxyCodeLine{01096\ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01097\ \ \ \ \ \ \ \ \ \ atomic\_add\_subsecondtime(stats.snoop\_latency,\ latency);}
\DoxyCodeLine{01098\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#ifdef\ ENABLE\_TRACK\_SHARING\_PREVCACHES}}
\DoxyCodeLine{01099\ \ \ \ \ \ \ \ \ \ assert(!\ cache\_block\_info-\/>hasCachedLoc());}
\DoxyCodeLine{01100\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{01101\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01102\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>getCState()\ ==\ CacheState::MODIFIED)\ \textcolor{comment}{//\ reading\ MODIFIED\ data}}
\DoxyCodeLine{01103\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01104\ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}reading\ MODIFIED\ data"{}});}
\DoxyCodeLine{01105\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Writeback\ in\ previous\ levels\ */}}
\DoxyCodeLine{01106\ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ SubsecondTime::Zero();}
\DoxyCodeLine{01107\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.begin();\ it\ !=\ m\_master-\/>m\_prev\_cache\_cntlrs.end();\ it++)\ \{}
\DoxyCodeLine{01108\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (*it\ !=\ requester)\ \{}
\DoxyCodeLine{01109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::pair<SubsecondTime,\ bool>\ res\ =\ (*it)-\/>updateCacheBlock(address,\ CacheState::SHARED,\ Transition::COHERENCY,\ NULL,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ latency\ =\ getMax<SubsecondTime>(latency,\ res.first);}
\DoxyCodeLine{01111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sibling\_hit\ |=\ res.second;}
\DoxyCodeLine{01112\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01113\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01114\ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}add\ latency\ \%s,\ sibling\_hit(\%u)"{}},\ itostr(latency).c\_str(),\ sibling\_hit);}
\DoxyCodeLine{01115\ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01116\ \ \ \ \ \ \ \ \ \ atomic\_add\_subsecondtime(stats.snoop\_latency,\ latency);}
\DoxyCodeLine{01117\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01118\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>getCState()\ ==\ CacheState::EXCLUSIVE)\ \textcolor{comment}{//\ reading\ EXCLUSIVE\ data}}
\DoxyCodeLine{01119\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01120\ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}reading\ EXCLUSIVE\ data"{}});}
\DoxyCodeLine{01121\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ will\ have\ shared\ state}}
\DoxyCodeLine{01122\ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ SubsecondTime::Zero();}
\DoxyCodeLine{01123\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.begin();\ it\ !=\ m\_master-\/>m\_prev\_cache\_cntlrs.end();\ it++)\ \{}
\DoxyCodeLine{01124\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (*it\ !=\ requester)\ \{}
\DoxyCodeLine{01125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::pair<SubsecondTime,\ bool>\ res\ =\ (*it)-\/>updateCacheBlock(address,\ CacheState::SHARED,\ Transition::COHERENCY,\ NULL,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ latency\ =\ getMax<SubsecondTime>(latency,\ res.first);}
\DoxyCodeLine{01127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sibling\_hit\ |=\ res.second;}
\DoxyCodeLine{01128\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01129\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01130\ }
\DoxyCodeLine{01131\ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}add\ latency\ \%s,\ sibling\_hit(\%u)"{}},\ itostr(latency).c\_str(),\ sibling\_hit);}
\DoxyCodeLine{01132\ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01133\ \ \ \ \ \ \ \ \ \ atomic\_add\_subsecondtime(stats.snoop\_latency,\ latency);}
\DoxyCodeLine{01134\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01135\ }
\DoxyCodeLine{01136\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_last\_remote\_hit\_where\ !=\ HitWhere::UNKNOWN)}
\DoxyCodeLine{01137\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01138\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ handleMsgFromDramDirectory\ just\ provided\ us\ with\ the\ data.\ Its\ source\ was\ left\ in\ m\_last\_remote\_hit\_where}}
\DoxyCodeLine{01139\ \ \ \ \ \ \ \ \ \ hit\_where\ =\ m\_last\_remote\_hit\_where;}
\DoxyCodeLine{01140\ \ \ \ \ \ \ \ \ \ m\_last\_remote\_hit\_where\ =\ HitWhere::UNKNOWN;}
\DoxyCodeLine{01141\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01142\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01143\ \ \ \ \ \ \ \ \ \ hit\_where\ =\ HitWhere::where\_t(m\_mem\_component\ +\ (sibling\_hit\ ?\ HitWhere::SIBLING\ :\ 0));}
\DoxyCodeLine{01144\ }
\DoxyCodeLine{01145\ \ \ \ \}}
\DoxyCodeLine{01146\ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{comment}{//\ !cache\_hit:\ either\ data\ is\ not\ here,\ or\ operation\ on\ data\ is\ not\ permitted}}
\DoxyCodeLine{01147\ \ \ \ \{}
\DoxyCodeLine{01148\ \ \ \ \ \ \ \textcolor{comment}{//\ Increment\ shared\ mem\ perf\ model\ cycle\ counts}}
\DoxyCodeLine{01149\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled)}
\DoxyCodeLine{01150\ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_TAGS,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01151\ }
\DoxyCodeLine{01152\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info\ \&\&\ (cache\_block\_info-\/>getCState()\ ==\ CacheState::SHARED))}
\DoxyCodeLine{01153\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01154\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Data\ is\ present,\ but\ still\ no\ cache\_hit\ =>\ this\ is\ a\ write\ on\ a\ SHARED\ block.\ Do\ Upgrade}}
\DoxyCodeLine{01155\ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ SubsecondTime::Zero();}
\DoxyCodeLine{01156\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.begin();\ it\ !=\ m\_master-\/>m\_prev\_cache\_cntlrs.end();\ it++)}
\DoxyCodeLine{01157\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (*it\ !=\ requester)\{}
\DoxyCodeLine{01158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Update\ Cache\ Block:\ "{}\ <<\ \_\_LINE\_\_\ <<\ "{}\ "{}<<CStateString(CacheState::INVALID)<<std::endl;}}
\DoxyCodeLine{01159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ latency\ =\ getMax<SubsecondTime>(latency,\ (*it)-\/>updateCacheBlock(address,\ CacheState::INVALID,\ Transition::UPGRADE,\ NULL,\ ShmemPerfModel::\_USER\_THREAD).first);}
\DoxyCodeLine{01160\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01161\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01162\ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01163\ \ \ \ \ \ \ \ \ \ atomic\_add\_subsecondtime(stats.snoop\_latency,\ latency);}
\DoxyCodeLine{01164\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#ifdef\ ENABLE\_TRACK\_SHARING\_PREVCACHES}}
\DoxyCodeLine{01165\ \ \ \ \ \ \ \ \ \ assert(!\ cache\_block\_info-\/>hasCachedLoc());}
\DoxyCodeLine{01166\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{01167\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01168\ }
\DoxyCodeLine{01169\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_next\_cache\_cntlr)}
\DoxyCodeLine{01170\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01171\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info)\{}
\DoxyCodeLine{01172\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Invalidate:\ "{}\ <<\ \_\_LINE\_\_\ <<\ std::endl;}}
\DoxyCodeLine{01173\ \ \ \ \ \ \ \ \ \ \ \ \ invalidateCacheBlock(address);}
\DoxyCodeLine{01174\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01175\ }
\DoxyCodeLine{01176\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ let\ the\ next\ cache\ level\ handle\ it.}}
\DoxyCodeLine{01177\ \ \ \ \ \ \ \ \ \ hit\_where\ =\ m\_next\_cache\_cntlr-\/>processShmemReqFromPrevCache(eip,\ \textcolor{keyword}{this},\ mem\_op\_type,\ address,\ modeled,\ count,block\_type,\ isPrefetch\ ==\ Prefetch::NONE\ ?\ Prefetch::NONE\ :\ Prefetch::OTHER,\ t\_issue,\ have\_write\_lock\_internal,\ mem\_origin);}
\DoxyCodeLine{01178\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (hit\_where\ !=\ HitWhere::MISS)}
\DoxyCodeLine{01179\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01180\ \ \ \ \ \ \ \ \ \ \ \ \ cache\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01181\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ get\ the\ data\ for\ ourselves\ */}}
\DoxyCodeLine{01182\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01183\ \ \ \ \ \ \ \ \ \ \ \ \ copyDataFromNextLevel(mem\_op\_type,\ address,\ modeled,\ t\_now,block\_type);}
\DoxyCodeLine{01184\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isPrefetch\ !=\ Prefetch::NONE)}
\DoxyCodeLine{01185\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getCacheBlockInfo(address)-\/>setOption(CacheBlockInfo::PREFETCH);}
\DoxyCodeLine{01186\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01187\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01188\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{comment}{//\ last-\/level\ cache}}
\DoxyCodeLine{01189\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01190\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info\ \&\&\ cache\_block\_info-\/>getCState()\ ==\ CacheState::EXCLUSIVE)}
\DoxyCodeLine{01191\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01192\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Data\ is\ present,\ but\ still\ no\ cache\_hit\ =>\ this\ is\ a\ write\ on\ a\ SHARED\ block.\ Do\ Upgrade}}
\DoxyCodeLine{01193\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ SubsecondTime::Zero();}
\DoxyCodeLine{01194\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.begin();\ it\ !=\ m\_master-\/>m\_prev\_cache\_cntlrs.end();\ it++)}
\DoxyCodeLine{01195\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (*it\ !=\ requester)\{}
\DoxyCodeLine{01196\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Update\ Cache\ Block:\ "{}\ <<\ \_\_LINE\_\_\ <<\ "{}\ "{}<<CStateString(CacheState::INVALID)<<std::endl;}}
\DoxyCodeLine{01197\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ latency\ =\ getMax<SubsecondTime>(latency,\ (*it)-\/>updateCacheBlock(address,\ CacheState::INVALID,\ Transition::UPGRADE,\ NULL,\ ShmemPerfModel::\_USER\_THREAD).first);}
\DoxyCodeLine{01198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01200\ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01201\ \ \ \ \ \ \ \ \ \ \ \ \ atomic\_add\_subsecondtime(stats.snoop\_latency,\ latency);}
\DoxyCodeLine{01202\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ ENABLE\_TRACK\_SHARING\_PREVCACHES}}
\DoxyCodeLine{01203\ \ \ \ \ \ \ \ \ \ \ \ \ assert(!\ cache\_block\_info-\/>hasCachedLoc());}
\DoxyCodeLine{01204\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{01205\ }
\DoxyCodeLine{01206\ \ \ \ \ \ \ \ \ \ \ \ \ cache\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01207\ \ \ \ \ \ \ \ \ \ \ \ \ hit\_where\ =\ HitWhere::where\_t(m\_mem\_component);}
\DoxyCodeLine{01208\ \ \ \ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}Silent\ upgrade\ from\ E\ -\/>\ M\ for\ address\ \%lx"{}},\ address);}
\DoxyCodeLine{01209\ \ \ \ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>setCState(CacheState::MODIFIED);}
\DoxyCodeLine{01210\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01211\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_dram\_cntlr)}
\DoxyCodeLine{01212\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01213\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Direct\ DRAM\ access}}
\DoxyCodeLine{01214\ \ \ \ \ \ \ \ \ \ \ \ \ cache\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01215\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info)}
\DoxyCodeLine{01216\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01217\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ already\ have\ the\ line:\ it\ must\ have\ been\ SHARED\ and\ this\ is\ a\ write\ (else\ there\ wouldn't\ have\ been\ a\ miss)}}
\DoxyCodeLine{01218\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Upgrade\ silently}}
\DoxyCodeLine{01219\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>setCState(CacheState::MODIFIED);}
\DoxyCodeLine{01220\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ hit\_where\ =\ HitWhere::where\_t(m\_mem\_component);}
\DoxyCodeLine{01221\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01223\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01224\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_shmem\_perf-\/>reset(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD),\ m\_core\_id);}
\DoxyCodeLine{01225\ }
\DoxyCodeLine{01226\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Byte\ data\_buf[getCacheBlockSize()];}
\DoxyCodeLine{01227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency;}
\DoxyCodeLine{01228\ }
\DoxyCodeLine{01229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Do\ the\ DRAM\ access\ and\ increment\ local\ time}}
\DoxyCodeLine{01230\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ boost::tie<HitWhere::where\_t,\ SubsecondTime>(hit\_where,\ latency)\ =\ accessDRAM(Core::READ,\ address,\ isPrefetch\ !=\ Prefetch::NONE,\ data\_buf,metadata\_request);}
\DoxyCodeLine{01231\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01232\ }
\DoxyCodeLine{01233\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Insert\ the\ line.\ Be\ sure\ to\ use\ SHARED/MODIFIED\ as\ appropriate\ (upgrades\ are\ free\ anyway),\ we\ don't\ want\ to\ have\ to\ write\ back\ clean\ lines}}
\DoxyCodeLine{01234\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ insertCacheBlock(address,\ mem\_op\_type\ ==\ Core::READ\ ?\ CacheState::SHARED\ :\ CacheState::MODIFIED,\ data\_buf,\ m\_core\_id,\ ShmemPerfModel::\_USER\_THREAD,\ block\_type);}
\DoxyCodeLine{01235\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isPrefetch\ !=\ Prefetch::NONE)}
\DoxyCodeLine{01236\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getCacheBlockInfo(address)-\/>setOption(CacheBlockInfo::PREFETCH);}
\DoxyCodeLine{01237\ }
\DoxyCodeLine{01238\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ updateUncoreStatistics(hit\_where,\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD));}
\DoxyCodeLine{01239\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01240\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01241\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01242\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01243\ \ \ \ \ \ \ \ \ \ \ \ \ initiateDirectoryAccess(mem\_op\_type,\ address,\ block\_type,isPrefetch\ !=\ Prefetch::NONE,\ t\_issue);}
\DoxyCodeLine{01244\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01245\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01246\ \ \ \ \}}
\DoxyCodeLine{01247\ }
\DoxyCodeLine{01248\ \ \ \ \textcolor{keywordflow}{if}\ (cache\_hit)}
\DoxyCodeLine{01249\ \ \ \ \{}
\DoxyCodeLine{01250\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}Yay,\ hit!!"{}});}
\DoxyCodeLine{01251\ \ \ \ \ \ \ Byte\ data\_buf[getCacheBlockSize()];}
\DoxyCodeLine{01252\ \ \ \ \ \ \ retrieveCacheBlock(address,\ data\_buf,\ ShmemPerfModel::\_USER\_THREAD,\ first\_hit\ \&\&\ count);}
\DoxyCodeLine{01253\ \ \ \ \ \ \ \textcolor{comment}{/*\ Store\ completion\ time\ so\ we\ can\ detect\ overlapping\ accesses\ */}}
\DoxyCodeLine{01254\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (modeled\ \&\&\ !first\_hit\ \&\&\ !m\_passthrough)}
\DoxyCodeLine{01255\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01256\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!metadata\_request)\{}
\DoxyCodeLine{01257\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01258\ \ \ \ \ \ \ \ \ \ \ \ \ m\_master-\/>mshr[address]\ =\ make\_mshr(t\_issue,\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD));}
\DoxyCodeLine{01259\ \ \ \ \ \ \ \ \ \ \ \ \ cleanupMshr();}
\DoxyCodeLine{01260\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01261\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{01262\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01263\ \ \ \ \ \ \ \ \ \ \ \ \ m\_master-\/>metadata\_mshr[address]\ =\ make\_mshr(t\_issue,\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD));}
\DoxyCodeLine{01264\ \ \ \ \ \ \ \ \ \ \ \ \ cleanupMetadataMshr();}
\DoxyCodeLine{01265\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01266\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01267\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01268\ \ \ \ \}}
\DoxyCodeLine{01269\ }
\DoxyCodeLine{01270\ \ \ \ \textcolor{keywordflow}{if}\ (modeled\ \&\&\ m\_master-\/>m\_prefetcher\ \&\&\ !metadata\_request)}
\DoxyCodeLine{01271\ \ \ \ \{}
\DoxyCodeLine{01272\ \ \ \ \ \ \ trainPrefetcher(eip,\ address,\ mem\_op\_type,\ cache\_hit,\ prefetch\_hit,\ t\_issue);}
\DoxyCodeLine{01273\ \ \ \ \}}
\DoxyCodeLine{01274\ }
\DoxyCodeLine{01275\ \textcolor{preprocessor}{\ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{01276\ \ \ \ \textcolor{keywordflow}{if}\ (have\_write\_lock\_internal\ \&\&\ !have\_write\_lock)}
\DoxyCodeLine{01277\ \ \ \ \{}
\DoxyCodeLine{01278\ \ \ \ \ \ \ releaseStackLock(address,\ \textcolor{keyword}{true});}
\DoxyCodeLine{01279\ \ \ \ \}}
\DoxyCodeLine{01280\ \textcolor{preprocessor}{\ \ \ \#else}}
\DoxyCodeLine{01281\ \textcolor{preprocessor}{\ \ \ \#endif}}
\DoxyCodeLine{01282\ }
\DoxyCodeLine{01283\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}returning\ \%s"{}},\ HitWhereString(hit\_where));}
\DoxyCodeLine{01284\ \ \ \ \textcolor{keywordflow}{return}\ hit\_where;}
\DoxyCodeLine{01285\ \}}
\DoxyCodeLine{01286\ }
\DoxyCodeLine{01287\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01288\ CacheCntlr::notifyPrevLevelInsert(core\_id\_t\ core\_id,\ MemComponent::component\_t\ mem\_component,\ IntPtr\ address)}
\DoxyCodeLine{01289\ \{}
\DoxyCodeLine{01290\ \textcolor{preprocessor}{\ \ \ \#ifdef\ ENABLE\_TRACK\_SHARING\_PREVCACHES}}
\DoxyCodeLine{01291\ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{01292\ \ \ \ assert(cache\_block\_info);}
\DoxyCodeLine{01293\ \ \ \ PrevCacheIndex\ idx\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.find(core\_id,\ mem\_component);}
\DoxyCodeLine{01294\ \ \ \ cache\_block\_info-\/>setCachedLoc(idx);}
\DoxyCodeLine{01295\ \textcolor{preprocessor}{\ \ \ \#endif}}
\DoxyCodeLine{01296\ \}}
\DoxyCodeLine{01297\ }
\DoxyCodeLine{01298\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01299\ CacheCntlr::notifyPrevLevelEvict(core\_id\_t\ core\_id,\ MemComponent::component\_t\ mem\_component,\ IntPtr\ address)}
\DoxyCodeLine{01300\ \{}
\DoxyCodeLine{01301\ MYLOG(\textcolor{stringliteral}{"{}@\%lx"{}},\ address);}
\DoxyCodeLine{01302\ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_evicting\_buf\ \&\&\ address\ ==\ m\_master-\/>m\_evicting\_address)\ \{}
\DoxyCodeLine{01303\ MYLOG(\textcolor{stringliteral}{"{}here\ being\ evicted"{}});}
\DoxyCodeLine{01304\ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01305\ \textcolor{preprocessor}{\ \ \ \ \ \ \#ifdef\ ENABLE\_TRACK\_SHARING\_PREVCACHES}}
\DoxyCodeLine{01306\ \ \ \ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{01307\ MYLOG(\textcolor{stringliteral}{"{}here\ in\ state\ \%c"{}},\ CStateString(getCacheState(address)));}
\DoxyCodeLine{01308\ \ \ \ \ \ \ assert(cache\_block\_info);}
\DoxyCodeLine{01309\ \ \ \ \ \ \ PrevCacheIndex\ idx\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.find(core\_id,\ mem\_component);}
\DoxyCodeLine{01310\ \ \ \ \ \ \ cache\_block\_info-\/>clearCachedLoc(idx);}
\DoxyCodeLine{01311\ \textcolor{preprocessor}{\ \ \ \ \ \ \#endif}}
\DoxyCodeLine{01312\ \ \ \ \}}
\DoxyCodeLine{01313\ \}}
\DoxyCodeLine{01314\ }
\DoxyCodeLine{01315\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01316\ CacheCntlr::updateUsageBits(IntPtr\ address,\ CacheBlockInfo::BitsUsedType\ used)}
\DoxyCodeLine{01317\ \{}
\DoxyCodeLine{01318\ \ \ \ \textcolor{keywordtype}{bool}\ new\_bits;}
\DoxyCodeLine{01319\ \ \ \ \{}
\DoxyCodeLine{01320\ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01321\ \ \ \ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{01322\ \ \ \ \ \ \ new\_bits\ =\ cache\_block\_info-\/>updateUsage(used);}
\DoxyCodeLine{01323\ \ \ \ \}}
\DoxyCodeLine{01324\ \ \ \ \textcolor{keywordflow}{if}\ (new\_bits\ \&\&\ m\_next\_cache\_cntlr\ \&\&\ !m\_perfect)}
\DoxyCodeLine{01325\ \ \ \ \{}
\DoxyCodeLine{01326\ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>updateUsageBits(address,\ used);}
\DoxyCodeLine{01327\ \ \ \ \}}
\DoxyCodeLine{01328\ \}}
\DoxyCodeLine{01329\ }
\DoxyCodeLine{01330\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01331\ CacheCntlr::walkUsageBits()}
\DoxyCodeLine{01332\ \{}
\DoxyCodeLine{01333\ \ \ \ \textcolor{keywordflow}{if}\ (!m\_next\_cache\_cntlr\ \&\&\ Sim()-\/>getConfig()-\/>hasCacheEfficiencyCallbacks())}
\DoxyCodeLine{01334\ \ \ \ \{}
\DoxyCodeLine{01335\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(UInt32\ set\_index\ =\ 0;\ set\_index\ <\ m\_master-\/>m\_cache-\/>getNumSets();\ ++set\_index)}
\DoxyCodeLine{01336\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01337\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(UInt32\ way\ =\ 0;\ way\ <\ m\_master-\/>m\_cache-\/>getAssociativity();\ ++way)}
\DoxyCodeLine{01338\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01339\ \ \ \ \ \ \ \ \ \ \ \ \ CacheBlockInfo\ *block\_info\ =\ m\_master-\/>m\_cache-\/>peekBlock(set\_index,\ way);}
\DoxyCodeLine{01340\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (block\_info-\/>isValid()\ \&\&\ !block\_info-\/>hasOption(CacheBlockInfo::WARMUP))}
\DoxyCodeLine{01341\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01342\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Sim()-\/>getConfig()-\/>getCacheEfficiencyCallbacks().call\_notify\_evict(\textcolor{keyword}{true},\ block\_info-\/>getOwner(),\ 0,\ block\_info-\/>getUsage(),\ getCacheBlockSize()\ >>\ CacheBlockInfo::BitsUsedOffset);}
\DoxyCodeLine{01343\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01344\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01345\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01346\ \ \ \ \}}
\DoxyCodeLine{01347\ \}}
\DoxyCodeLine{01348\ }
\DoxyCodeLine{01349\ boost::tuple<HitWhere::where\_t,\ SubsecondTime>}
\DoxyCodeLine{01350\ CacheCntlr::accessDRAM(Core::mem\_op\_t\ mem\_op\_type,\ IntPtr\ address,\ \textcolor{keywordtype}{bool}\ isPrefetch,\ Byte*\ data\_buf,\textcolor{keywordtype}{bool}\ metadata\_request)}
\DoxyCodeLine{01351\ \{}
\DoxyCodeLine{01352\ \ \ \ ScopedLock\ sl(getLock());\ \textcolor{comment}{//\ DRAM\ is\ shared\ and\ owned\ by\ m\_master}}
\DoxyCodeLine{01353\ \ \ \ \textcolor{comment}{//std::cout<<metadata\_request<<"{}\(\backslash\)n"{};}}
\DoxyCodeLine{01354\ \ \ \ SubsecondTime\ t\_issue\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01355\ \ \ \ SubsecondTime\ dram\_latency;}
\DoxyCodeLine{01356\ \ \ \ HitWhere::where\_t\ hit\_where;}
\DoxyCodeLine{01357\ }
\DoxyCodeLine{01358\ \ \ \ \textcolor{keywordflow}{switch}\ (mem\_op\_type)}
\DoxyCodeLine{01359\ \ \ \ \{}
\DoxyCodeLine{01360\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::READ:}
\DoxyCodeLine{01361\ \ \ \ \ \ \ \ \ \ boost::tie(dram\_latency,\ hit\_where)\ =\ m\_master-\/>m\_dram\_cntlr-\/>getDataFromDram(address,\ m\_core\_id\_master,\ data\_buf,\ t\_issue,\ m\_shmem\_perf,metadata\_request);}
\DoxyCodeLine{01362\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01363\ }
\DoxyCodeLine{01364\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::READ\_EX:}
\DoxyCodeLine{01365\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::WRITE:}
\DoxyCodeLine{01366\ \ \ \ \ \ \ \ \ \ boost::tie(dram\_latency,\ hit\_where)\ =\ m\_master-\/>m\_dram\_cntlr-\/>putDataToDram(address,\ m\_core\_id\_master,\ data\_buf,\ t\_issue,metadata\_request);}
\DoxyCodeLine{01367\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01368\ }
\DoxyCodeLine{01369\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01370\ \ \ \ \ \ \ \ \ \ LOG\_PRINT\_ERROR(\textcolor{stringliteral}{"{}Unsupported\ Mem\ Op\ Type(\%u)"{}},\ mem\_op\_type);}
\DoxyCodeLine{01371\ \ \ \ \}}
\DoxyCodeLine{01372\ }
\DoxyCodeLine{01373\ \ \ \ \textcolor{keywordflow}{return}\ boost::tuple<HitWhere::where\_t,\ SubsecondTime>(hit\_where,\ dram\_latency);}
\DoxyCodeLine{01374\ \}}
\DoxyCodeLine{01375\ }
\DoxyCodeLine{01376\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01377\ CacheCntlr::initiateDirectoryAccess(Core::mem\_op\_t\ mem\_op\_type,\ IntPtr\ address,\ CacheBlockInfo::block\_type\_t\ block\_type,\ \textcolor{keywordtype}{bool}\ isPrefetch,\ SubsecondTime\ t\_issue)}
\DoxyCodeLine{01378\ \{}
\DoxyCodeLine{01379\ \ \ \ \textcolor{keywordtype}{bool}\ exclusive\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01380\ }
\DoxyCodeLine{01381\ \ \ \ \textcolor{keywordflow}{switch}\ (mem\_op\_type)}
\DoxyCodeLine{01382\ \ \ \ \{}
\DoxyCodeLine{01383\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::READ:}
\DoxyCodeLine{01384\ \ \ \ \ \ \ \ \ \ exclusive\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01385\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01386\ }
\DoxyCodeLine{01387\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::READ\_EX:}
\DoxyCodeLine{01388\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::WRITE:}
\DoxyCodeLine{01389\ \ \ \ \ \ \ \ \ \ exclusive\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01390\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01391\ }
\DoxyCodeLine{01392\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01393\ \ \ \ \ \ \ \ \ \ LOG\_PRINT\_ERROR(\textcolor{stringliteral}{"{}Unsupported\ Mem\ Op\ Type(\%u)"{}},\ mem\_op\_type);}
\DoxyCodeLine{01394\ \ \ \ \}}
\DoxyCodeLine{01395\ }
\DoxyCodeLine{01396\ \ \ \ \textcolor{keywordtype}{bool}\ first\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01397\ \ \ \ \{}
\DoxyCodeLine{01398\ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01399\ \ \ \ \ \ \ CacheDirectoryWaiter*\ request\ =\ \textcolor{keyword}{new}\ CacheDirectoryWaiter(exclusive,\ block\_type,\ isPrefetch,\ \textcolor{keyword}{this},\ t\_issue);}
\DoxyCodeLine{01400\ \ \ \ \ \ \ m\_master-\/>m\_directory\_waiters.enqueue(address,\ request);}
\DoxyCodeLine{01401\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_directory\_waiters.size(address)\ ==\ 1)}
\DoxyCodeLine{01402\ \ \ \ \ \ \ \ \ \ first\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01403\ \ \ \ \}}
\DoxyCodeLine{01404\ }
\DoxyCodeLine{01405\ \ \ \ \textcolor{keywordflow}{if}\ (first)}
\DoxyCodeLine{01406\ \ \ \ \{}
\DoxyCodeLine{01407\ \ \ \ \ \ \ m\_shmem\_perf-\/>reset(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD),\ m\_core\_id);}
\DoxyCodeLine{01408\ \ \ \ \ \ \ \textcolor{comment}{//std::cout<<"{}Request\ to\ LLC\ "{}<<std::hex<<address<<"{}\ Exclusive:\ "{}<<exclusive\ <<"{}\(\backslash\)n"{};}}
\DoxyCodeLine{01409\ \ \ \ \ \ \ \textcolor{comment}{/*\ We're\ the\ first\ one\ to\ request\ this\ address,\ send\ the\ message\ to\ the\ directory\ now\ */}}
\DoxyCodeLine{01410\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (exclusive)}
\DoxyCodeLine{01411\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01412\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01413\ \ \ \ \ \ \ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{01414\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info\ \&\&\ (cache\_block\_info-\/>getCState()\ ==\ CacheState::SHARED))}
\DoxyCodeLine{01415\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01416\ \ \ \ \ \ \ \ \ \ \ \ \ processUpgradeReqToDirectory(address,\ m\_shmem\_perf,\ ShmemPerfModel::\_USER\_THREAD,block\_type);}
\DoxyCodeLine{01417\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01418\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01419\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01420\ \ \ \ \ \ \ \ \ \ \ \ \ processExReqToDirectory(address,block\_type);}
\DoxyCodeLine{01421\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01422\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01423\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01424\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01425\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01426\ \ \ \ \ \ \ \ \ \ processShReqToDirectory(address,block\_type);}
\DoxyCodeLine{01427\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01428\ \ \ \ \}}
\DoxyCodeLine{01429\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01430\ \ \ \ \{}
\DoxyCodeLine{01431\ \ \ \ \ \ \ \textcolor{comment}{//\ Someone\ else\ is\ busy\ with\ this\ cache\ line,\ they'll\ do\ everything\ for\ us}}
\DoxyCodeLine{01432\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}\%u\ previous\ waiters"{}},\ m\_master-\/>m\_directory\_waiters.size(address));}
\DoxyCodeLine{01433\ \ \ \ \}}
\DoxyCodeLine{01434\ \}}
\DoxyCodeLine{01435\ }
\DoxyCodeLine{01436\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01437\ CacheCntlr::processExReqToDirectory(IntPtr\ address,CacheBlockInfo::block\_type\_t\ block\_type)}
\DoxyCodeLine{01438\ \{}
\DoxyCodeLine{01439\ \ \ \ \textcolor{comment}{//\ We\ need\ to\ send\ a\ request\ to\ the\ Dram\ Directory\ Cache}}
\DoxyCodeLine{01440\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}EX\ REQ>\%d\ @\ \%lx"{}},\ getHome(address)\ ,address);}
\DoxyCodeLine{01441\ }
\DoxyCodeLine{01442\ \ \ \ CacheState::cstate\_t\ cstate\ =\ getCacheState(address);}
\DoxyCodeLine{01443\ }
\DoxyCodeLine{01444\ \ \ \ LOG\_ASSERT\_ERROR\ (cstate\ !=\ CacheState::SHARED,\ \textcolor{stringliteral}{"{}ExReq\ for\ a\ Cacheblock\ in\ S,\ should\ be\ a\ UpgradeReq"{}});}
\DoxyCodeLine{01445\ \ \ \ assert((cstate\ ==\ CacheState::INVALID));}
\DoxyCodeLine{01446\ \ \ \ \textcolor{comment}{//std::cout<<"{}Send\ Message\ from\ address:\ "{}<<std::hex<<address<<"{}\ processExReqToDirectory\(\backslash\)n"{};}}
\DoxyCodeLine{01447\ \ \ \ getMemoryManager()-\/>sendMsg(PrL1PrL2DramDirectoryMSI::ShmemMsg::EX\_REQ,}
\DoxyCodeLine{01448\ \ \ \ \ \ \ \ \ \ MemComponent::LAST\_LEVEL\_CACHE,\ MemComponent::TAG\_DIR,}
\DoxyCodeLine{01449\ \ \ \ \ \ \ \ \ \ m\_core\_id\_master\ \textcolor{comment}{/*\ requester\ */},}
\DoxyCodeLine{01450\ \ \ \ \ \ \ \ \ \ getHome(address)\ \textcolor{comment}{/*\ receiver\ */},}
\DoxyCodeLine{01451\ \ \ \ \ \ \ \ \ \ address,}
\DoxyCodeLine{01452\ \ \ \ \ \ \ \ \ \ NULL,\ 0,}
\DoxyCodeLine{01453\ \ \ \ \ \ \ \ \ \ HitWhere::UNKNOWN,\ m\_shmem\_perf,\ ShmemPerfModel::\_USER\_THREAD,block\_type);}
\DoxyCodeLine{01454\ \}}
\DoxyCodeLine{01455\ }
\DoxyCodeLine{01456\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01457\ CacheCntlr::processUpgradeReqToDirectory(IntPtr\ address,\ ShmemPerf\ *perf,\ ShmemPerfModel::Thread\_t\ thread\_num,\ CacheBlockInfo::block\_type\_t\ block\_type)}
\DoxyCodeLine{01458\ \{}
\DoxyCodeLine{01459\ \ \ \ \textcolor{comment}{//\ We\ need\ to\ send\ a\ request\ to\ the\ Dram\ Directory\ Cache}}
\DoxyCodeLine{01460\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}UPGR\ REQ\ @\ \%lx"{}},\ address);}
\DoxyCodeLine{01461\ }
\DoxyCodeLine{01462\ \ \ \ CacheState::cstate\_t\ cstate\ =\ getCacheState(address);}
\DoxyCodeLine{01463\ \ \ \ assert(cstate\ ==\ CacheState::SHARED);}
\DoxyCodeLine{01464\ \ \ \ setCacheState(address,\ CacheState::SHARED\_UPGRADING);}
\DoxyCodeLine{01465\ \ \ \ \textcolor{comment}{//std::cout<<"{}Send\ Message\ from\ address:\ "{}<<std::hex<<address<<"{}\ processUpgradeReqToDirectory\(\backslash\)n"{};}}
\DoxyCodeLine{01466\ \ \ \ getMemoryManager()-\/>sendMsg(PrL1PrL2DramDirectoryMSI::ShmemMsg::UPGRADE\_REQ,}
\DoxyCodeLine{01467\ \ \ \ \ \ \ \ \ \ MemComponent::LAST\_LEVEL\_CACHE,\ MemComponent::TAG\_DIR,}
\DoxyCodeLine{01468\ \ \ \ \ \ \ \ \ \ m\_core\_id\_master\ \textcolor{comment}{/*\ requester\ */},}
\DoxyCodeLine{01469\ \ \ \ \ \ \ \ \ \ getHome(address)\ \textcolor{comment}{/*\ receiver\ */},}
\DoxyCodeLine{01470\ \ \ \ \ \ \ \ \ \ address,}
\DoxyCodeLine{01471\ \ \ \ \ \ \ \ \ \ NULL,\ 0,}
\DoxyCodeLine{01472\ \ \ \ \ \ \ \ \ \ HitWhere::UNKNOWN,\ perf,\ thread\_num,\ block\_type);}
\DoxyCodeLine{01473\ \}}
\DoxyCodeLine{01474\ }
\DoxyCodeLine{01475\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01476\ CacheCntlr::processShReqToDirectory(IntPtr\ address,CacheBlockInfo::block\_type\_t\ block\_type)}
\DoxyCodeLine{01477\ \{}
\DoxyCodeLine{01478\ MYLOG(\textcolor{stringliteral}{"{}SH\ REQ\ @\ \%lx"{}},\ address);}
\DoxyCodeLine{01479\ \textcolor{comment}{//std::cout<<"{}Send\ Message\ from\ address:\ "{}<<std::hex<<address<<"{}\ processShReqToDirectory\(\backslash\)n"{};}}
\DoxyCodeLine{01480\ \ \ \ getMemoryManager()-\/>sendMsg(PrL1PrL2DramDirectoryMSI::ShmemMsg::SH\_REQ,}
\DoxyCodeLine{01481\ \ \ \ \ \ \ \ \ \ MemComponent::LAST\_LEVEL\_CACHE,\ MemComponent::TAG\_DIR,}
\DoxyCodeLine{01482\ \ \ \ \ \ \ \ \ \ m\_core\_id\_master\ \textcolor{comment}{/*\ requester\ */},}
\DoxyCodeLine{01483\ \ \ \ \ \ \ \ \ \ getHome(address)\ \textcolor{comment}{/*\ receiver\ */},}
\DoxyCodeLine{01484\ \ \ \ \ \ \ \ \ \ address,}
\DoxyCodeLine{01485\ \ \ \ \ \ \ \ \ \ NULL,\ 0,}
\DoxyCodeLine{01486\ \ \ \ \ \ \ \ \ \ HitWhere::UNKNOWN,\ m\_shmem\_perf,\ ShmemPerfModel::\_USER\_THREAD,\ block\_type);}
\DoxyCodeLine{01487\ \}}
\DoxyCodeLine{01488\ }
\DoxyCodeLine{01489\ }
\DoxyCodeLine{01490\ }
\DoxyCodeLine{01491\ }
\DoxyCodeLine{01492\ }
\DoxyCodeLine{01493\ }
\DoxyCodeLine{01494\ \textcolor{comment}{/*****************************************************************************}}
\DoxyCodeLine{01495\ \textcolor{comment}{\ *\ internal\ operations\ called\ by\ cache\ on\ itself}}
\DoxyCodeLine{01496\ \textcolor{comment}{\ *****************************************************************************/}}
\DoxyCodeLine{01497\ }
\DoxyCodeLine{01498\ \textcolor{keywordtype}{bool}}
\DoxyCodeLine{01499\ CacheCntlr::operationPermissibleinCache(}
\DoxyCodeLine{01500\ \ \ \ \ \ \ IntPtr\ address,\ Core::mem\_op\_t\ mem\_op\_type,\ CacheBlockInfo\ **cache\_block\_info)}
\DoxyCodeLine{01501\ \{}
\DoxyCodeLine{01502\ \ \ \ CacheBlockInfo\ *block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{01503\ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info\ !=\ NULL)}
\DoxyCodeLine{01504\ \ \ \ \ \ \ *cache\_block\_info\ =\ block\_info;}
\DoxyCodeLine{01505\ }
\DoxyCodeLine{01506\ \ \ \ \textcolor{keywordtype}{bool}\ cache\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01507\ \ \ \ CacheState::cstate\_t\ cstate\ =\ getCacheState(block\_info);}
\DoxyCodeLine{01508\ }
\DoxyCodeLine{01509\ \ \ \ \textcolor{keywordflow}{switch}\ (mem\_op\_type)}
\DoxyCodeLine{01510\ \ \ \ \{}
\DoxyCodeLine{01511\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::READ:}
\DoxyCodeLine{01512\ \ \ \ \ \ \ \ \ \ cache\_hit\ =\ CacheState(cstate).readable();}
\DoxyCodeLine{01513\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01514\ }
\DoxyCodeLine{01515\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::READ\_EX:}
\DoxyCodeLine{01516\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::WRITE:}
\DoxyCodeLine{01517\ \ \ \ \ \ \ \ \ \ cache\_hit\ =\ CacheState(cstate).writable();}
\DoxyCodeLine{01518\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01519\ }
\DoxyCodeLine{01520\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01521\ \ \ \ \ \ \ \ \ \ LOG\_PRINT\_ERROR(\textcolor{stringliteral}{"{}Unsupported\ mem\_op\_type:\ \%u"{}},\ mem\_op\_type);}
\DoxyCodeLine{01522\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01523\ \ \ \ \}}
\DoxyCodeLine{01524\ }
\DoxyCodeLine{01525\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}address\ \%lx\ state\ \%c:\ permissible\ \%d"{}},\ address,\ CStateString(cstate),\ cache\_hit);}
\DoxyCodeLine{01526\ \ \ \ \textcolor{keywordflow}{return}\ cache\_hit;}
\DoxyCodeLine{01527\ \}}
\DoxyCodeLine{01528\ }
\DoxyCodeLine{01529\ }
\DoxyCodeLine{01530\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01531\ CacheCntlr::accessCache(}
\DoxyCodeLine{01532\ \ \ \ \ \ \ Core::mem\_op\_t\ mem\_op\_type,\ IntPtr\ ca\_address,\ UInt32\ offset,}
\DoxyCodeLine{01533\ \ \ \ \ \ \ Byte*\ data\_buf,\ UInt32\ data\_length,\ \textcolor{keywordtype}{bool}\ update\_replacement)}
\DoxyCodeLine{01534\ \{}
\DoxyCodeLine{01535\ \ \ \ \textcolor{keywordflow}{switch}\ (mem\_op\_type)}
\DoxyCodeLine{01536\ \ \ \ \{}
\DoxyCodeLine{01537\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::READ:}
\DoxyCodeLine{01538\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::READ\_EX:}
\DoxyCodeLine{01539\ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_cache-\/>accessSingleLine(ca\_address\ +\ offset,\ Cache::LOAD,\ data\_buf,\ data\_length,}
\DoxyCodeLine{01540\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD),\ update\_replacement);}
\DoxyCodeLine{01541\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01542\ }
\DoxyCodeLine{01543\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ Core::WRITE:}
\DoxyCodeLine{01544\ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_cache-\/>accessSingleLine(ca\_address\ +\ offset,\ Cache::STORE,\ data\_buf,\ data\_length,}
\DoxyCodeLine{01545\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD),\ update\_replacement);}
\DoxyCodeLine{01546\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Write-\/through\ cache\ -\/\ Write\ the\ next\ level\ cache\ also}}
\DoxyCodeLine{01547\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_cache\_writethrough)\ \{}
\DoxyCodeLine{01548\ \ \ \ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(m\_next\_cache\_cntlr,\ \textcolor{stringliteral}{"{}Writethrough\ enabled\ on\ last-\/level\ cache\ !?"{}});}
\DoxyCodeLine{01549\ MYLOG(\textcolor{stringliteral}{"{}writethrough\ start"{}});}
\DoxyCodeLine{01550\ \ \ \ \ \ \ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>writeCacheBlock(ca\_address,\ offset,\ data\_buf,\ data\_length,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01551\ MYLOG(\textcolor{stringliteral}{"{}writethrough\ done"{}});}
\DoxyCodeLine{01552\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01553\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01554\ }
\DoxyCodeLine{01555\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01556\ \ \ \ \ \ \ \ \ \ LOG\_PRINT\_ERROR(\textcolor{stringliteral}{"{}Unsupported\ Mem\ Op\ Type:\ \%u"{}},\ mem\_op\_type);}
\DoxyCodeLine{01557\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01558\ \ \ \ \}}
\DoxyCodeLine{01559\ \}}
\DoxyCodeLine{01560\ }
\DoxyCodeLine{01561\ }
\DoxyCodeLine{01562\ }
\DoxyCodeLine{01563\ }
\DoxyCodeLine{01564\ \textcolor{comment}{/*****************************************************************************}}
\DoxyCodeLine{01565\ \textcolor{comment}{\ *\ localized\ cache\ block\ operations}}
\DoxyCodeLine{01566\ \textcolor{comment}{\ *****************************************************************************/}}
\DoxyCodeLine{01567\ }
\DoxyCodeLine{01568\ SharedCacheBlockInfo*}
\DoxyCodeLine{01569\ CacheCntlr::getCacheBlockInfo(IntPtr\ address)}
\DoxyCodeLine{01570\ \{}
\DoxyCodeLine{01571\ \ \ \ \textcolor{keywordflow}{return}\ (SharedCacheBlockInfo*)\ m\_master-\/>m\_cache-\/>peekSingleLine(address);}
\DoxyCodeLine{01572\ \}}
\DoxyCodeLine{01573\ }
\DoxyCodeLine{01574\ CacheState::cstate\_t}
\DoxyCodeLine{01575\ CacheCntlr::getCacheState(IntPtr\ address)}
\DoxyCodeLine{01576\ \{}
\DoxyCodeLine{01577\ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{01578\ \ \ \ \textcolor{keywordflow}{return}\ getCacheState(cache\_block\_info);}
\DoxyCodeLine{01579\ \}}
\DoxyCodeLine{01580\ }
\DoxyCodeLine{01581\ CacheBlockInfo::block\_type\_t}
\DoxyCodeLine{01582\ CacheCntlr::getCacheBlockType(IntPtr\ address)}
\DoxyCodeLine{01583\ \{}
\DoxyCodeLine{01584\ \ \ \ \textcolor{keywordflow}{return}\ getCacheBlockInfo(address)-\/>getBlockType();}
\DoxyCodeLine{01585\ \}}
\DoxyCodeLine{01586\ }
\DoxyCodeLine{01587\ CacheState::cstate\_t}
\DoxyCodeLine{01588\ CacheCntlr::getCacheState(CacheBlockInfo\ *cache\_block\_info)}
\DoxyCodeLine{01589\ \{}
\DoxyCodeLine{01590\ \ \ \ \textcolor{keywordflow}{return}\ (cache\_block\_info\ ==\ NULL)\ ?\ CacheState::INVALID\ :\ cache\_block\_info-\/>getCState();}
\DoxyCodeLine{01591\ \}}
\DoxyCodeLine{01592\ }
\DoxyCodeLine{01593\ SharedCacheBlockInfo*}
\DoxyCodeLine{01594\ CacheCntlr::setCacheState(IntPtr\ address,\ CacheState::cstate\_t\ cstate)}
\DoxyCodeLine{01595\ \{}
\DoxyCodeLine{01596\ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{01597\ \ \ \ cache\_block\_info-\/>setCState(cstate);}
\DoxyCodeLine{01598\ \ \ \ \textcolor{keywordflow}{return}\ cache\_block\_info;}
\DoxyCodeLine{01599\ \}}
\DoxyCodeLine{01600\ }
\DoxyCodeLine{01601\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01602\ CacheCntlr::invalidateCacheBlock(IntPtr\ address)}
\DoxyCodeLine{01603\ \{}
\DoxyCodeLine{01604\ \ \ \ \_\_attribute\_\_((unused))\ CacheState::cstate\_t\ old\_cstate\ =\ getCacheState(address);}
\DoxyCodeLine{01605\ \ \ \ assert(old\_cstate\ !=\ CacheState::MODIFIED);}
\DoxyCodeLine{01606\ \ \ \ assert(old\_cstate\ !=\ CacheState::INVALID);}
\DoxyCodeLine{01607\ }
\DoxyCodeLine{01608\ }
\DoxyCodeLine{01609\ \ \ \ m\_master-\/>m\_cache-\/>invalidateSingleLine(address);}
\DoxyCodeLine{01610\ }
\DoxyCodeLine{01611\ \ \ \ \textcolor{keywordflow}{if}\ (m\_next\_cache\_cntlr)}
\DoxyCodeLine{01612\ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>notifyPrevLevelEvict(m\_core\_id\_master,\ m\_mem\_component,\ address);}
\DoxyCodeLine{01613\ }
\DoxyCodeLine{01614\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}\%lx\ \%c\ >\ \%c"{}},\ address,\ CStateString(old\_cstate),\ CStateString(getCacheState(address)));}
\DoxyCodeLine{01615\ \}}
\DoxyCodeLine{01616\ }
\DoxyCodeLine{01617\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01618\ CacheCntlr::retrieveCacheBlock(IntPtr\ address,\ Byte*\ data\_buf,\ ShmemPerfModel::Thread\_t\ thread\_num,\ \textcolor{keywordtype}{bool}\ update\_replacement)}
\DoxyCodeLine{01619\ \{}
\DoxyCodeLine{01620\ \ \ \ \_\_attribute\_\_((unused))\ SharedCacheBlockInfo*\ cache\_block\_info\ =\ (SharedCacheBlockInfo*)\ m\_master-\/>m\_cache-\/>accessSingleLine(}
\DoxyCodeLine{01621\ \ \ \ \ \ \ address,\ Cache::LOAD,\ data\_buf,\ getCacheBlockSize(),\ getShmemPerfModel()-\/>getElapsedTime(thread\_num),\ update\_replacement);}
\DoxyCodeLine{01622\ \ \ \ LOG\_ASSERT\_ERROR(cache\_block\_info\ !=\ NULL,\ \textcolor{stringliteral}{"{}Expected\ block\ to\ be\ there\ but\ it\ wasn't"{}});}
\DoxyCodeLine{01623\ \}}
\DoxyCodeLine{01624\ }
\DoxyCodeLine{01625\ }
\DoxyCodeLine{01626\ \textcolor{comment}{/*****************************************************************************}}
\DoxyCodeLine{01627\ \textcolor{comment}{\ *\ cache\ block\ operations\ that\ update\ the\ previous\ level(s)}}
\DoxyCodeLine{01628\ \textcolor{comment}{\ *****************************************************************************/}}
\DoxyCodeLine{01629\ }
\DoxyCodeLine{01630\ SharedCacheBlockInfo*}
\DoxyCodeLine{01631\ CacheCntlr::insertCacheBlock(IntPtr\ address,\ CacheState::cstate\_t\ cstate,\ Byte*\ data\_buf,\ core\_id\_t\ requester,\ ShmemPerfModel::Thread\_t\ thread\_num,\ CacheBlockInfo::block\_type\_t\ block\_type)}
\DoxyCodeLine{01632\ \{}
\DoxyCodeLine{01633\ }
\DoxyCodeLine{01634\ }
\DoxyCodeLine{01635\ \ }
\DoxyCodeLine{01636\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}insertCacheBlock\ at\ \%s\ l\%d\ @\ \%lx\ as\ \%c\ (now\ \%c)"{}},\ getCache()-\/>getName().c\_str(),\ m\_mem\_component,\ address,\ CStateString(cstate),\ CStateString(getCacheState(address)));}
\DoxyCodeLine{01637\ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Inserting\ cache\ block\ at\ cache:\ "{}\ <<\ getCache()-\/>getName()\ <<\ "{}\ with\ address:"{}\ <<\ address\ <<\ "{}\ with\ type:\ "{}\ <<\ block\_type\ <<\ std::endl;}}
\DoxyCodeLine{01638\ \ \ \ \textcolor{keywordtype}{bool}\ metadata\_request\ =\ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE)\ ||\ }
\DoxyCodeLine{01639\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE\_PASSTHROUGH)\ ||\ }
\DoxyCodeLine{01640\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::SECURITY)\ ||\ }
\DoxyCodeLine{01641\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::EXPRESSIVE)\ ||\ \ }
\DoxyCodeLine{01642\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY)\ ||}
\DoxyCodeLine{01643\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (block\_type\ ==\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY\_PASSTHROUGH);}
\DoxyCodeLine{01644\ \ \ \ }
\DoxyCodeLine{01645\ }
\DoxyCodeLine{01646\ \ \ \ }
\DoxyCodeLine{01647\ \ \ \ \textcolor{keywordtype}{bool}\ eviction;}
\DoxyCodeLine{01648\ \ \ \ IntPtr\ evict\_address;}
\DoxyCodeLine{01649\ \ \ \ SharedCacheBlockInfo\ evict\_block\_info;}
\DoxyCodeLine{01650\ \ \ \ Byte\ evict\_buf[getCacheBlockSize()];}
\DoxyCodeLine{01651\ \ \ \ \textcolor{comment}{//\ if(metadata\_request\ \&\&\ (metadata\_passthrough\_loc\ >\ 2\ ))\{}}
\DoxyCodeLine{01652\ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ return\ NULL;}}
\DoxyCodeLine{01653\ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{01654\ }
\DoxyCodeLine{01655\ \ \ \ LOG\_ASSERT\_ERROR(getCacheState(address)\ ==\ CacheState::INVALID,\ \textcolor{stringliteral}{"{}we\ already\ have\ this\ line,\ can't\ add\ it\ again"{}});}
\DoxyCodeLine{01656\ \ \ \ \textcolor{comment}{//printf("{}Inserting\ in\ \%s\ with\ eviction\ =\ \%d\ and\ cache\ state\ =\ \%c\ \(\backslash\)n"{},\ getCache()-\/>getName().c\_str(),\ eviction,\ CStateString(cstate));}}
\DoxyCodeLine{01657\ \ \ \ m\_master-\/>m\_cache-\/>insertSingleLine(address,\ data\_buf,}
\DoxyCodeLine{01658\ \ \ \ \ \ \ \ \ \ \&eviction,\ \&evict\_address,\ \&evict\_block\_info,\ evict\_buf,}
\DoxyCodeLine{01659\ \ \ \ \ \ \ \ \ \ getShmemPerfModel()-\/>getElapsedTime(thread\_num),\ \textcolor{keyword}{this},\ block\_type);}
\DoxyCodeLine{01660\ \ \ \ \ \ \ }
\DoxyCodeLine{01661\ \ \ \ }
\DoxyCodeLine{01662\ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ setCacheState(address,\ cstate);}
\DoxyCodeLine{01663\ \ \ \ }
\DoxyCodeLine{01664\ \ \ \ \textcolor{keywordflow}{if}\ (Sim()-\/>getInstrumentationMode()\ ==\ InstMode::CACHE\_ONLY)}
\DoxyCodeLine{01665\ \ \ \ \ \ \ cache\_block\_info-\/>setOption(CacheBlockInfo::WARMUP);}
\DoxyCodeLine{01666\ }
\DoxyCodeLine{01667\ \ \ \ \textcolor{comment}{//\ if\ (Sim()-\/>getConfig()-\/>hasCacheEfficiencyCallbacks())}}
\DoxyCodeLine{01668\ \ \ \ \textcolor{comment}{//\ \ \ \ cache\_block\_info-\/>setOwner(Sim()-\/>getConfig()-\/>getCacheEfficiencyCallbacks().call\_get\_owner(requester,\ address));}}
\DoxyCodeLine{01669\ }
\DoxyCodeLine{01670\ \ \ \ \textcolor{keywordflow}{if}\ (m\_next\_cache\_cntlr\ \&\&\ !m\_perfect)}
\DoxyCodeLine{01671\ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>notifyPrevLevelInsert(m\_core\_id\_master,\ m\_mem\_component,\ address);}
\DoxyCodeLine{01672\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}insertCacheBlock\ l\%d\ local\ done"{}},\ m\_mem\_component);}
\DoxyCodeLine{01673\ }
\DoxyCodeLine{01674\ }
\DoxyCodeLine{01675\ \ \ \ \textcolor{keywordflow}{if}\ (eviction)}
\DoxyCodeLine{01676\ \ \ \ \{}
\DoxyCodeLine{01677\ }
\DoxyCodeLine{01678\ \ \ \ \ \ \ }
\DoxyCodeLine{01679\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}evicting\ @\%lx"{}},\ evict\_address);}
\DoxyCodeLine{01680\ }
\DoxyCodeLine{01681\ \ \ \ \ \ \ \textcolor{comment}{//\ if\ (}}
\DoxyCodeLine{01682\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ !m\_next\_cache\_cntlr\ //\ Track\ at\ LLC}}
\DoxyCodeLine{01683\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \&\&\ !evict\_block\_info.hasOption(CacheBlockInfo::WARMUP)\ //\ Ignore\ blocks\ allocated\ during\ warmup\ (we\ don't\ track\ usage\ then)}}
\DoxyCodeLine{01684\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \&\&\ Sim()-\/>getConfig()-\/>hasCacheEfficiencyCallbacks()}}
\DoxyCodeLine{01685\ \ \ \ \ \ \ \textcolor{comment}{//\ )}}
\DoxyCodeLine{01686\ \ \ \ \ \ \ \textcolor{comment}{//\ \{\ \ }}
\DoxyCodeLine{01687\ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ Sim()-\/>getConfig()-\/>getCacheEfficiencyCallbacks().call\_notify\_evict(false,\ evict\_block\_info.getOwner(),\ cache\_block\_info-\/>getOwner(),\ evict\_block\_info.getUsage(),\ getCacheBlockSize()\ >>\ CacheBlockInfo::BitsUsedOffset);}}
\DoxyCodeLine{01688\ \ \ \ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{01689\ }
\DoxyCodeLine{01690\ \ \ \ \ \ \ CacheState::cstate\_t\ old\_state\ =\ evict\_block\_info.getCState();}
\DoxyCodeLine{01691\ \ \ \ \ \ \ }
\DoxyCodeLine{01692\ \ \ \ \ \ \textcolor{comment}{//\ printf("{}Evicting\ from\ \%s\ with\ counter\ =\ \%d\ \(\backslash\)n"{},\ getCache()-\/>getName().c\_str(),stats.evict[old\_state]);}}
\DoxyCodeLine{01693\ \ \ \ }
\DoxyCodeLine{01694\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}evicting\ @\%lx\ (state\ \%c)"{}},\ evict\_address,\ CStateString(old\_state));}
\DoxyCodeLine{01695\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01696\ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01697\ \ \ \ \ \ \ \ \ \ transition(}
\DoxyCodeLine{01698\ \ \ \ \ \ \ \ \ \ \ \ \ evict\_address,}
\DoxyCodeLine{01699\ \ \ \ \ \ \ \ \ \ \ \ \ Transition::EVICT,}
\DoxyCodeLine{01700\ \ \ \ \ \ \ \ \ \ \ \ \ old\_state,}
\DoxyCodeLine{01701\ \ \ \ \ \ \ \ \ \ \ \ \ CacheState::INVALID}
\DoxyCodeLine{01702\ \ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{01703\ }
\DoxyCodeLine{01704\ \ \ \ \ \ \ \ \ \ ++stats.evict[old\_state];}
\DoxyCodeLine{01705\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Line\ was\ prefetched,\ but\ is\ evicted\ without\ ever\ being\ used}}
\DoxyCodeLine{01706\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (evict\_block\_info.hasOption(CacheBlockInfo::PREFETCH))}
\DoxyCodeLine{01707\ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.evict\_prefetch;}
\DoxyCodeLine{01708\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (evict\_block\_info.hasOption(CacheBlockInfo::WARMUP))}
\DoxyCodeLine{01709\ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.evict\_warmup;}
\DoxyCodeLine{01710\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01711\ }
\DoxyCodeLine{01712\ \ \ \ \ \ \ \textcolor{comment}{/*\ TODO:\ this\ part\ looks\ a\ lot\ like\ updateCacheBlock's\ dirty\ case,\ but\ with\ the\ eviction\ buffer}}
\DoxyCodeLine{01713\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ instead\ of\ an\ address,\ and\ with\ a\ message\ to\ the\ directory\ at\ the\ end.\ Merge?\ */}}
\DoxyCodeLine{01714\ }
\DoxyCodeLine{01715\ \ \ \ \ \ \ LOG\_PRINT(\textcolor{stringliteral}{"{}Eviction:\ addr(0x\%x)"{}},\ evict\_address);}
\DoxyCodeLine{01716\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\ m\_master-\/>m\_prev\_cache\_cntlrs.empty())\ \{}
\DoxyCodeLine{01717\ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01718\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ propagate\ the\ update\ to\ the\ previous\ levels.\ they\ will\ write\ modified\ data\ back\ to\ our\ evict\ buffer\ when\ needed\ */}}
\DoxyCodeLine{01719\ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_evicting\_address\ =\ evict\_address;}
\DoxyCodeLine{01720\ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_evicting\_buf\ =\ evict\_buf;}
\DoxyCodeLine{01721\ }
\DoxyCodeLine{01722\ \ \ \ \ \ \ \ \ \ SubsecondTime\ latency\ =\ SubsecondTime::Zero();}
\DoxyCodeLine{01723\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.begin();\ it\ !=\ m\_master-\/>m\_prev\_cache\_cntlrs.end();\ it++)\{}
\DoxyCodeLine{01724\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Update\ Cache\ Block:\ "{}\ <<\ \_\_LINE\_\_\ <<\ "{}\ "{}<<CStateString(CacheState::INVALID)<<std::endl;}}
\DoxyCodeLine{01725\ \ \ \ \ \ \ \ \ \ \ \ \ latency\ =\ getMax<SubsecondTime>(latency,\ (*it)-\/>updateCacheBlock(evict\_address,\ CacheState::INVALID,\ Transition::BACK\_INVAL,\ NULL,\ thread\_num).first);}
\DoxyCodeLine{01726\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01727\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01728\ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ thread\_num);}
\DoxyCodeLine{01729\ \ \ \ \ \ \ \ \ \ atomic\_add\_subsecondtime(stats.snoop\_latency,\ latency);}
\DoxyCodeLine{01730\ }
\DoxyCodeLine{01731\ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_evicting\_address\ =\ 0;}
\DoxyCodeLine{01732\ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_evicting\_buf\ =\ NULL;}
\DoxyCodeLine{01733\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01734\ }
\DoxyCodeLine{01735\ \ \ \ \ \ \ \textcolor{comment}{/*\ now\ properly\ get\ rid\ of\ the\ evicted\ line\ */}}
\DoxyCodeLine{01736\ }
\DoxyCodeLine{01737\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_perfect)}
\DoxyCodeLine{01738\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01739\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Nothing\ to\ do\ in\ this\ case}}
\DoxyCodeLine{01740\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01741\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!m\_coherent)}
\DoxyCodeLine{01742\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01743\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ notify\ the\ next\ level,\ it\ may\ have\ already\ evicted\ the\ line\ itself\ and\ won't\ like\ our\ notifyPrevLevelEvict}}
\DoxyCodeLine{01744\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ the\ line\ wasn't\ modified\ though\ (unless\ we're\ writethrough),\ else\ data\ would\ have\ been\ lost}}
\DoxyCodeLine{01745\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_cache\_writethrough)}
\DoxyCodeLine{01746\ \ \ \ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(evict\_block\_info.getCState()\ !=\ CacheState::MODIFIED,\ \textcolor{stringliteral}{"{}Non-\/coherent\ cache\ is\ throwing\ away\ dirty\ data"{}});}
\DoxyCodeLine{01747\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01748\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (m\_next\_cache\_cntlr)}
\DoxyCodeLine{01749\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01750\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_cache\_writethrough)\ \{}
\DoxyCodeLine{01751\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ If\ we're\ a\ write-\/through\ cache\ the\ new\ data\ is\ in\ the\ next\ level\ already\ */}}
\DoxyCodeLine{01752\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01753\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Send\ dirty\ block\ to\ next\ level\ cache.\ Probably\ we\ have\ an\ evict/victim\ buffer\ to\ do\ that\ when\ we're\ idle,\ so\ ignore\ timing\ */}}
\DoxyCodeLine{01754\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (evict\_block\_info.getCState()\ ==\ CacheState::MODIFIED)}
\DoxyCodeLine{01755\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>writeCacheBlock(evict\_address,\ 0,\ evict\_buf,\ getCacheBlockSize(),\ thread\_num);}
\DoxyCodeLine{01756\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01757\ \ \ \ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>notifyPrevLevelEvict(m\_core\_id\_master,\ m\_mem\_component,\ evict\_address);}
\DoxyCodeLine{01758\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01759\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_dram\_cntlr)}
\DoxyCodeLine{01760\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01761\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (evict\_block\_info.getCState()\ ==\ CacheState::MODIFIED)}
\DoxyCodeLine{01762\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01763\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01764\ }
\DoxyCodeLine{01765\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_dram\_outstanding\_writebacks)}
\DoxyCodeLine{01766\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01767\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01768\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Delay\ if\ all\ evict\ buffers\ are\ full}}
\DoxyCodeLine{01769\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_issue\ =\ m\_master-\/>m\_dram\_outstanding\_writebacks-\/>getStartTime(t\_now);}
\DoxyCodeLine{01770\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(t\_issue\ -\/\ t\_now,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{01771\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01772\ }
\DoxyCodeLine{01773\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Access\ DRAM}}
\DoxyCodeLine{01774\ \ \ \ \ \ \ \ \ \ \ \ \ SubsecondTime\ dram\_latency;}
\DoxyCodeLine{01775\ \ \ \ \ \ \ \ \ \ \ \ \ HitWhere::where\_t\ hit\_where;}
\DoxyCodeLine{01776\ \ \ \ \ \ \ \ \ \ \ \ \ boost::tie<HitWhere::where\_t,\ SubsecondTime>(hit\_where,\ dram\_latency)\ =\ accessDRAM(Core::WRITE,\ evict\_address,\ \textcolor{keyword}{false},\ evict\_buf,block\_type);}
\DoxyCodeLine{01777\ }
\DoxyCodeLine{01778\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Occupy\ evict\ buffer}}
\DoxyCodeLine{01779\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_dram\_outstanding\_writebacks)}
\DoxyCodeLine{01780\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01781\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01782\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_dram\_outstanding\_writebacks-\/>getCompletionTime(t\_now,\ dram\_latency);}
\DoxyCodeLine{01783\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01784\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01785\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01786\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01787\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01788\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Send\ dirty\ block\ to\ directory\ */}}
\DoxyCodeLine{01789\ \ \ \ \ \ \ \ \ \ UInt32\ home\_node\_id\ =\ getHome(evict\_address);}
\DoxyCodeLine{01790\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (evict\_block\_info.getCState()\ ==\ CacheState::MODIFIED)}
\DoxyCodeLine{01791\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01792\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Send\ back\ the\ data\ also}}
\DoxyCodeLine{01793\ MYLOG(\textcolor{stringliteral}{"{}evict\ FLUSH\ \%lx"{}},\ evict\_address);}
\DoxyCodeLine{01794\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout<<"{}Send\ Message\ from\ address:\ "{}<<std::hex<<address<<"{}\ evict\ flush\(\backslash\)n"{};}}
\DoxyCodeLine{01795\ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>sendMsg(PrL1PrL2DramDirectoryMSI::ShmemMsg::FLUSH\_REP,}
\DoxyCodeLine{01796\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MemComponent::LAST\_LEVEL\_CACHE,\ MemComponent::TAG\_DIR,}
\DoxyCodeLine{01797\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_core\_id\ \textcolor{comment}{/*\ requester\ */},}
\DoxyCodeLine{01798\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ home\_node\_id\ \textcolor{comment}{/*\ receiver\ */},}
\DoxyCodeLine{01799\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ evict\_address,}
\DoxyCodeLine{01800\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ evict\_buf,\ getCacheBlockSize(),}
\DoxyCodeLine{01801\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ HitWhere::UNKNOWN,\ \&m\_dummy\_shmem\_perf,\ thread\_num,evict\_block\_info.getBlockType());}
\DoxyCodeLine{01802\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01803\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01804\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01805\ MYLOG(\textcolor{stringliteral}{"{}evict\ INV\ \%lx"{}},\ evict\_address);}
\DoxyCodeLine{01806\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout<<"{}Send\ Message\ from\ address:\ "{}<<std::hex<<address<<"{}\ evict\ inv\(\backslash\)n"{};}}
\DoxyCodeLine{01807\ \ \ \ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(evict\_block\_info.getCState()\ ==\ CacheState::SHARED\ ||\ evict\_block\_info.getCState()\ ==\ CacheState::EXCLUSIVE,}
\DoxyCodeLine{01808\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}evict\_address(0x\%x),\ evict\_state(\%u)"{}},}
\DoxyCodeLine{01809\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ evict\_address,\ evict\_block\_info.getCState());}
\DoxyCodeLine{01810\ \ \ \ \ \ \ \ \ \ \ \ \ getMemoryManager()-\/>sendMsg(PrL1PrL2DramDirectoryMSI::ShmemMsg::INV\_REP,}
\DoxyCodeLine{01811\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MemComponent::LAST\_LEVEL\_CACHE,\ MemComponent::TAG\_DIR,}
\DoxyCodeLine{01812\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_core\_id\ \textcolor{comment}{/*\ requester\ */},}
\DoxyCodeLine{01813\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ home\_node\_id\ \textcolor{comment}{/*\ receiver\ */},}
\DoxyCodeLine{01814\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ evict\_address,}
\DoxyCodeLine{01815\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ NULL,\ 0,}
\DoxyCodeLine{01816\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ HitWhere::UNKNOWN,\ \&m\_dummy\_shmem\_perf,\ thread\_num,evict\_block\_info.getBlockType());}
\DoxyCodeLine{01817\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01818\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01819\ }
\DoxyCodeLine{01820\ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(getCacheState(evict\_address)\ ==\ CacheState::INVALID,\ \textcolor{stringliteral}{"{}Evicted\ address\ did\ not\ become\ invalid,\ now\ in\ state\ \%s"{}},\ CStateString(getCacheState(evict\_address)));}
\DoxyCodeLine{01821\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}insertCacheBlock\ l\%d\ evict\ done"{}},\ m\_mem\_component);}
\DoxyCodeLine{01822\ \ \ \ \}}
\DoxyCodeLine{01823\ }
\DoxyCodeLine{01824\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}insertCacheBlock\ l\%d\ end"{}},\ m\_mem\_component);}
\DoxyCodeLine{01825\ \ \ \ \textcolor{keywordflow}{return}\ cache\_block\_info;}
\DoxyCodeLine{01826\ \}}
\DoxyCodeLine{01827\ }
\DoxyCodeLine{01828\ std::pair<SubsecondTime,\ bool>}
\DoxyCodeLine{01829\ CacheCntlr::updateCacheBlock(IntPtr\ address,\ CacheState::cstate\_t\ new\_cstate,\ Transition::reason\_t\ reason,\ Byte*\ out\_buf,\ ShmemPerfModel::Thread\_t\ thread\_num)}
\DoxyCodeLine{01830\ \{}
\DoxyCodeLine{01831\ \ \ \ \textcolor{comment}{//printf("{}Update\ Cache\ Block\ at\ l\%d\ \(\backslash\)n"{},\ m\_mem\_component);}}
\DoxyCodeLine{01832\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}updateCacheBlock"{}});}
\DoxyCodeLine{01833\ \ \ \ LOG\_ASSERT\_ERROR(new\_cstate\ <\ CacheState::NUM\_CSTATE\_STATES,\ \textcolor{stringliteral}{"{}Invalid\ new\ cstate\ \%u"{}},\ new\_cstate);}
\DoxyCodeLine{01834\ }
\DoxyCodeLine{01835\ \ \ \ \textcolor{comment}{/*\ first,\ propagate\ the\ update\ to\ the\ previous\ levels.\ they\ will\ write\ modified\ data\ back\ to\ us\ when\ needed\ */}}
\DoxyCodeLine{01836\ \ \ \ \textcolor{comment}{//\ TODO:\ performance\ fix:\ should\ only\ query\ those\ we\ know\ have\ the\ line\ (in\ cache\_block\_info-\/>m\_cached\_locs)}}
\DoxyCodeLine{01837\ \ \ \ \textcolor{comment}{/*\ TODO:\ increment\ time\ (access\ tags)\ on\ previous-\/level\ caches,\ either\ all\ (for\ a\ snooping\ protocol\ that's\ not\ keeping\ track}}
\DoxyCodeLine{01838\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ of\ cache\_block\_info-\/>m\_cached\_locs)\ or\ selective\ (snoop\ filter\ /\ directory)\ */}}
\DoxyCodeLine{01839\ \ \ \ SubsecondTime\ latency\ =\ SubsecondTime::Zero();}
\DoxyCodeLine{01840\ \ \ \ \textcolor{keywordtype}{bool}\ sibling\_hit\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01841\ }
\DoxyCodeLine{01842\ \ \ \ \textcolor{keywordflow}{if}\ (!\ m\_master-\/>m\_prev\_cache\_cntlrs.empty())}
\DoxyCodeLine{01843\ \ \ \ \{}
\DoxyCodeLine{01844\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.begin();\ it\ !=\ m\_master-\/>m\_prev\_cache\_cntlrs.end();\ it++)\ \{}
\DoxyCodeLine{01845\ \ \ \ \ \ \ \ \ \ std::pair<SubsecondTime,\ bool>\ res\ =\ (*it)-\/>updateCacheBlock(}
\DoxyCodeLine{01846\ \ \ \ \ \ \ \ \ \ \ \ \ address,\ new\_cstate,\ reason\ ==\ Transition::EVICT\ ?\ Transition::BACK\_INVAL\ :\ reason,\ NULL,\ thread\_num);}
\DoxyCodeLine{01847\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ writeback\_time\ is\ for\ the\ complete\ stack,\ so\ only\ model\ it\ at\ the\ last\ level,\ ignore\ latencies\ returned\ by\ previous\ ones}}
\DoxyCodeLine{01848\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//latency\ =\ getMax<SubsecondTime>(latency,\ res.first);}}
\DoxyCodeLine{01849\ \ \ \ \ \ \ \ \ \ sibling\_hit\ |=\ res.second;}
\DoxyCodeLine{01850\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01851\ \ \ \ \}}
\DoxyCodeLine{01852\ }
\DoxyCodeLine{01853\ \ \ \ SharedCacheBlockInfo*\ cache\_block\_info\ =\ getCacheBlockInfo(address);}
\DoxyCodeLine{01854\ \ \ \ \_\_attribute\_\_((unused))\ CacheState::cstate\_t\ old\_cstate\ =\ cache\_block\_info\ ?\ cache\_block\_info-\/>getCState()\ :\ CacheState::INVALID;}
\DoxyCodeLine{01855\ }
\DoxyCodeLine{01856\ \ \ \ \textcolor{keywordtype}{bool}\ buf\_written\ =\ \textcolor{keyword}{false},\ is\_writeback\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01857\ }
\DoxyCodeLine{01858\ \ \ \ \textcolor{keywordflow}{if}\ (!cache\_block\_info)}
\DoxyCodeLine{01859\ \ \ \ \{}
\DoxyCodeLine{01860\ \ \ \ \ \ \ \textcolor{comment}{/*\ We\ don't\ have\ the\ block,\ nothing\ to\ do\ */}}
\DoxyCodeLine{01861\ \ \ \ \}}
\DoxyCodeLine{01862\ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (new\_cstate\ ==\ cache\_block\_info-\/>getCState()\ \&\&\ out\_buf)}
\DoxyCodeLine{01863\ \ \ \ \{}
\DoxyCodeLine{01864\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ already\ have\ the\ right\ state,\ nothing\ to\ do\ except\ writing\ our\ data}}
\DoxyCodeLine{01865\ \ \ \ \ \ \ \textcolor{comment}{//\ in\ the\ out\_buf\ if\ it\ is\ passed}}
\DoxyCodeLine{01866\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ someone\ (presumably\ the\ directory\ interfacing\ code)\ is\ waiting\ to\ consume\ the\ data}}
\DoxyCodeLine{01867\ \ \ \ \ \ \ retrieveCacheBlock(address,\ out\_buf,\ thread\_num,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01868\ \ \ \ \ \ \ buf\_written\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01869\ \ \ \ \ \ \ is\_writeback\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01870\ \ \ \ \ \ \ sibling\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01871\ \ \ \ \}}
\DoxyCodeLine{01872\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01873\ \ \ \ \{}
\DoxyCodeLine{01874\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01875\ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(getLock());}
\DoxyCodeLine{01876\ \ \ \ \ \ \ \ \ \ transition(}
\DoxyCodeLine{01877\ \ \ \ \ \ \ \ \ \ \ \ \ address,}
\DoxyCodeLine{01878\ \ \ \ \ \ \ \ \ \ \ \ \ reason,}
\DoxyCodeLine{01879\ \ \ \ \ \ \ \ \ \ \ \ \ getCacheState(address),}
\DoxyCodeLine{01880\ \ \ \ \ \ \ \ \ \ \ \ \ new\_cstate}
\DoxyCodeLine{01881\ \ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{01882\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (reason\ ==\ Transition::COHERENCY)}
\DoxyCodeLine{01883\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01884\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_cstate\ ==\ CacheState::SHARED)}
\DoxyCodeLine{01885\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.coherency\_downgrades;}
\DoxyCodeLine{01886\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>getCState()\ ==\ CacheState::MODIFIED)}
\DoxyCodeLine{01887\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.coherency\_writebacks;}
\DoxyCodeLine{01888\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01889\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.coherency\_invalidates;}
\DoxyCodeLine{01890\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>hasOption(CacheBlockInfo::PREFETCH)\ \&\&\ new\_cstate\ ==\ CacheState::INVALID)}
\DoxyCodeLine{01891\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.invalidate\_prefetch;}
\DoxyCodeLine{01892\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>hasOption(CacheBlockInfo::WARMUP)\ \&\&\ new\_cstate\ ==\ CacheState::INVALID)}
\DoxyCodeLine{01893\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.invalidate\_warmup;}
\DoxyCodeLine{01894\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01895\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (reason\ ==\ Transition::UPGRADE)}
\DoxyCodeLine{01896\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01897\ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.coherency\_upgrades;}
\DoxyCodeLine{01898\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01899\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (reason\ ==\ Transition::BACK\_INVAL)}
\DoxyCodeLine{01900\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01901\ \ \ \ \ \ \ \ \ \ \ \ \ ++stats.backinval[cache\_block\_info-\/>getCState()];}
\DoxyCodeLine{01902\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01903\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01904\ }
\DoxyCodeLine{01905\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cache\_block\_info-\/>getCState()\ ==\ CacheState::MODIFIED)\ \{}
\DoxyCodeLine{01906\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ data\ is\ modified,\ write\ it\ back\ */}}
\DoxyCodeLine{01907\ }
\DoxyCodeLine{01908\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_cache\_writethrough)\ \{}
\DoxyCodeLine{01909\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ next\ level\ already\ has\ the\ data\ */}}
\DoxyCodeLine{01910\ }
\DoxyCodeLine{01911\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (m\_next\_cache\_cntlr)\ \{}
\DoxyCodeLine{01912\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ write\ straight\ into\ the\ next\ level\ cache\ */}}
\DoxyCodeLine{01913\ \ \ \ \ \ \ \ \ \ \ \ \ Byte\ data\_buf[getCacheBlockSize()];}
\DoxyCodeLine{01914\ \ \ \ \ \ \ \ \ \ \ \ \ retrieveCacheBlock(address,\ data\_buf,\ thread\_num,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01915\ \ \ \ \ \ \ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>writeCacheBlock(address,\ 0,\ data\_buf,\ getCacheBlockSize(),\ thread\_num);}
\DoxyCodeLine{01916\ \ \ \ \ \ \ \ \ \ \ \ \ is\_writeback\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01917\ \ \ \ \ \ \ \ \ \ \ \ \ sibling\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01918\ }
\DoxyCodeLine{01919\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (out\_buf)\ \{}
\DoxyCodeLine{01920\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ someone\ (presumably\ the\ directory\ interfacing\ code)\ is\ waiting\ to\ consume\ the\ data\ */}}
\DoxyCodeLine{01921\ \ \ \ \ \ \ \ \ \ \ \ \ retrieveCacheBlock(address,\ out\_buf,\ thread\_num,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01922\ \ \ \ \ \ \ \ \ \ \ \ \ buf\_written\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01923\ \ \ \ \ \ \ \ \ \ \ \ \ is\_writeback\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01924\ \ \ \ \ \ \ \ \ \ \ \ \ sibling\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01925\ }
\DoxyCodeLine{01926\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01927\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ no-\/one\ will\ take\ my\ data\ !?\ */}}
\DoxyCodeLine{01928\ \ \ \ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(\ cache\_block\_info-\/>getCState()\ !=\ CacheState::MODIFIED,\ \textcolor{stringliteral}{"{}MODIFIED\ data\ is\ about\ to\ get\ lost!"{}});}
\DoxyCodeLine{01929\ }
\DoxyCodeLine{01930\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01931\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>setCState(CacheState::SHARED);}
\DoxyCodeLine{01932\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01933\ }
\DoxyCodeLine{01934\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_cstate\ ==\ CacheState::INVALID)}
\DoxyCodeLine{01935\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01936\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (out\_buf)}
\DoxyCodeLine{01937\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01938\ \ \ \ \ \ \ \ \ \ \ \ \ retrieveCacheBlock(address,\ out\_buf,\ thread\_num,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01939\ \ \ \ \ \ \ \ \ \ \ \ \ buf\_written\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01940\ \ \ \ \ \ \ \ \ \ \ \ \ is\_writeback\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01941\ \ \ \ \ \ \ \ \ \ \ \ \ sibling\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01942\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01943\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_coherent)\{}
\DoxyCodeLine{01944\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ std::cout\ <<\ "{}Invalidate:\ "{}\ <<\ \_\_LINE\_\_\ <<\ std::endl;}}
\DoxyCodeLine{01945\ \ \ \ \ \ \ \ \ \ \ \ \ invalidateCacheBlock(address);}
\DoxyCodeLine{01946\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01947\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01948\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (new\_cstate\ ==\ CacheState::SHARED)}
\DoxyCodeLine{01949\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01950\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (out\_buf)}
\DoxyCodeLine{01951\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01952\ \ \ \ \ \ \ \ \ \ \ \ \ retrieveCacheBlock(address,\ out\_buf,\ thread\_num,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01953\ \ \ \ \ \ \ \ \ \ \ \ \ buf\_written\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01954\ \ \ \ \ \ \ \ \ \ \ \ \ is\_writeback\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01955\ \ \ \ \ \ \ \ \ \ \ \ \ sibling\_hit\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01956\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01957\ }
\DoxyCodeLine{01958\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>setCState(new\_cstate);}
\DoxyCodeLine{01959\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01960\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (new\_cstate\ ==\ CacheState::MODIFIED)}
\DoxyCodeLine{01961\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01962\ \ \ \ \ \ \ \ \ \ cache\_block\_info-\/>setCState(new\_cstate);}
\DoxyCodeLine{01963\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01964\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01965\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01966\ \ \ \ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(\textcolor{keyword}{false},\ \textcolor{stringliteral}{"{}Cannot\ change\ block\ status\ to\ \%c"{}},\ CStateString(new\_cstate));}
\DoxyCodeLine{01967\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01968\ \ \ \ \}}
\DoxyCodeLine{01969\ }
\DoxyCodeLine{01970\ \ \ \ MYLOG(\textcolor{stringliteral}{"{}@\%lx\ \ \%c\ >\ \%c\ (req:\ \%c)"{}},\ address,\ CStateString(old\_cstate),}
\DoxyCodeLine{01971\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CStateString(cache\_block\_info\ ?\ cache\_block\_info-\/>getCState()\ :\ CacheState::INVALID),}
\DoxyCodeLine{01972\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CStateString(new\_cstate));}
\DoxyCodeLine{01973\ }
\DoxyCodeLine{01974\ \ \ \ LOG\_ASSERT\_ERROR((getCacheState(address)\ ==\ CacheState::INVALID)\ ||\ (getCacheState(address)\ ==\ new\_cstate)\ ||\ !m\_coherent,}
\DoxyCodeLine{01975\ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}state\ didn't\ change\ as\ we\ wanted:\ \%c\ instead\ of\ \%c"{}},\ CStateString(getCacheState(address)),\ CStateString(new\_cstate));}
\DoxyCodeLine{01976\ }
\DoxyCodeLine{01977\ \ \ \ CacheState::cstate\_t\ current\_cstate;}
\DoxyCodeLine{01978\ \ \ \ current\_cstate\ =\ (cache\_block\_info)\ ?\ cache\_block\_info-\/>getCState():\ CacheState::INVALID;}
\DoxyCodeLine{01979\ \ \ \ LOG\_ASSERT\_ERROR((current\_cstate\ ==\ CacheState::INVALID)\ ||\ (current\_cstate\ ==\ new\_cstate)\ ||\ !m\_coherent,}
\DoxyCodeLine{01980\ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}state\ didn't\ change\ as\ we\ wanted:\ \%c\ instead\ of\ \%c"{}},\ CStateString(current\_cstate),\ CStateString(new\_cstate));}
\DoxyCodeLine{01981\ \ \ \ \textcolor{keywordflow}{if}\ (out\_buf\ \&\&\ !buf\_written)}
\DoxyCodeLine{01982\ \ \ \ \{}
\DoxyCodeLine{01983\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}cache\_block\_info:\ \%c"{}},\ cache\_block\_info\ ?\ \textcolor{charliteral}{'y'}\ :\ \textcolor{charliteral}{'n'});}
\DoxyCodeLine{01984\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}@\%lx\ \ \%c\ >\ \%c\ (req:\ \%c)"{}},\ address,\ CStateString(old\_cstate),}
\DoxyCodeLine{01985\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CStateString(cache\_block\_info\ ?\ cache\_block\_info-\/>getCState()\ :\ CacheState::INVALID),}
\DoxyCodeLine{01986\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CStateString(new\_cstate));}
\DoxyCodeLine{01987\ \ \ \ \}}
\DoxyCodeLine{01988\ \ \ \ LOG\_ASSERT\_ERROR(out\_buf\ ?\ buf\_written\ :\ \textcolor{keyword}{true},\ \textcolor{stringliteral}{"{}out\_buf\ passed\ in\ but\ never\ written\ to"{}});}
\DoxyCodeLine{01989\ \ \ \ \textcolor{comment}{/*\ Assume\ tag\ access\ caused\ by\ snooping\ is\ already\ accounted\ for\ in\ lower\ level\ cache\ access\ time,}}
\DoxyCodeLine{01990\ \textcolor{comment}{\ \ \ \ \ \ so\ only\ when\ we\ accessed\ data\ should\ we\ return\ any\ latency\ */}}
\DoxyCodeLine{01991\ \ \ \ \textcolor{keywordflow}{if}\ (is\_writeback)}
\DoxyCodeLine{01992\ \ \ \ \ \ \ latency\ +=\ m\_writeback\_time.getLatency();}
\DoxyCodeLine{01993\ \ \ \ \textcolor{keywordflow}{return}\ std::pair<SubsecondTime,\ bool>(latency,\ sibling\_hit);}
\DoxyCodeLine{01994\ \}}
\DoxyCodeLine{01995\ }
\DoxyCodeLine{01996\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{01997\ CacheCntlr::writeCacheBlock(IntPtr\ address,\ UInt32\ offset,\ Byte*\ data\_buf,\ UInt32\ data\_length,\ ShmemPerfModel::Thread\_t\ thread\_num)}
\DoxyCodeLine{01998\ \{}
\DoxyCodeLine{01999\ MYLOG(\textcolor{stringliteral}{"{}\ "{}});}
\DoxyCodeLine{02000\ }
\DoxyCodeLine{02001\ \ \ \ \textcolor{comment}{//\ TODO:\ should\ we\ update\ access\ counter?}}
\DoxyCodeLine{02002\ }
\DoxyCodeLine{02003\ \ \ \ \textcolor{keywordflow}{if}\ (m\_master-\/>m\_evicting\_buf\ \&\&\ (address\ ==\ m\_master-\/>m\_evicting\_address))\ \{}
\DoxyCodeLine{02004\ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}writing\ to\ evict\ buffer\ \%lx"{}},\ address);}
\DoxyCodeLine{02005\ assert(offset==0);}
\DoxyCodeLine{02006\ assert(data\_length==getCacheBlockSize());}
\DoxyCodeLine{02007\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data\_buf)}
\DoxyCodeLine{02008\ \ \ \ \ \ \ \ \ \ memcpy(m\_master-\/>m\_evicting\_buf\ +\ offset,\ data\_buf,\ data\_length);}
\DoxyCodeLine{02009\ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02010\ \ \ \ \ \ \ \_\_attribute\_\_((unused))\ SharedCacheBlockInfo*\ cache\_block\_info\ =\ (SharedCacheBlockInfo*)\ m\_master-\/>m\_cache-\/>accessSingleLine(}
\DoxyCodeLine{02011\ \ \ \ \ \ \ \ \ \ address\ +\ offset,\ Cache::STORE,\ data\_buf,\ data\_length,\ getShmemPerfModel()-\/>getElapsedTime(thread\_num),\ \textcolor{keyword}{false});}
\DoxyCodeLine{02012\ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(cache\_block\_info,\ \textcolor{stringliteral}{"{}writethrough\ expected\ a\ hit\ at\ next-\/level\ cache\ but\ got\ miss"{}});}
\DoxyCodeLine{02013\ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(cache\_block\_info-\/>getCState()\ ==\ CacheState::MODIFIED,\ \textcolor{stringliteral}{"{}Got\ writeback\ for\ non-\/MODIFIED\ line"{}});}
\DoxyCodeLine{02014\ \ \ \ \}}
\DoxyCodeLine{02015\ }
\DoxyCodeLine{02016\ \ \ \ \textcolor{keywordflow}{if}\ (m\_cache\_writethrough)\ \{}
\DoxyCodeLine{02017\ \ \ \ \ \ \ acquireStackLock(\textcolor{keyword}{true});}
\DoxyCodeLine{02018\ \ \ \ \ \ \ m\_next\_cache\_cntlr-\/>writeCacheBlock(address,\ offset,\ data\_buf,\ data\_length,\ thread\_num);}
\DoxyCodeLine{02019\ \ \ \ \ \ \ releaseStackLock(\textcolor{keyword}{true});}
\DoxyCodeLine{02020\ \ \ \ \}}
\DoxyCodeLine{02021\ \}}
\DoxyCodeLine{02022\ }
\DoxyCodeLine{02023\ \textcolor{keywordtype}{bool}}
\DoxyCodeLine{02024\ CacheCntlr::isInLowerLevelCache(CacheBlockInfo\ *block\_info)}
\DoxyCodeLine{02025\ \{}
\DoxyCodeLine{02026\ \ \ \ IntPtr\ address\ =\ m\_master-\/>m\_cache-\/>tagToAddress(block\_info-\/>getTag());}
\DoxyCodeLine{02027\ \ \ \ \textcolor{keywordflow}{for}(CacheCntlrList::iterator\ it\ =\ m\_master-\/>m\_prev\_cache\_cntlrs.begin();\ it\ !=\ m\_master-\/>m\_prev\_cache\_cntlrs.end();\ it++)}
\DoxyCodeLine{02028\ \ \ \ \{}
\DoxyCodeLine{02029\ \ \ \ \ \ \ \textcolor{comment}{//\ All\ caches\ are\ inclusive,\ so\ there\ is\ no\ need\ to\ propagate\ further}}
\DoxyCodeLine{02030\ \ \ \ \ \ \ SharedCacheBlockInfo*\ block\_info\ =\ (*it)-\/>getCacheBlockInfo(address);}
\DoxyCodeLine{02031\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (block\_info\ !=\ NULL)}
\DoxyCodeLine{02032\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02033\ \ \ \ \}}
\DoxyCodeLine{02034\ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02035\ \}}
\DoxyCodeLine{02036\ }
\DoxyCodeLine{02037\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02038\ CacheCntlr::incrementQBSLookupCost()}
\DoxyCodeLine{02039\ \{}
\DoxyCodeLine{02040\ \ \ \ SubsecondTime\ latency\ =\ m\_writeback\_time.getLatency();}
\DoxyCodeLine{02041\ \ \ \ getMemoryManager()-\/>incrElapsedTime(latency,\ ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{02042\ \ \ \ atomic\_add\_subsecondtime(stats.qbs\_query\_latency,\ latency);}
\DoxyCodeLine{02043\ \}}
\DoxyCodeLine{02044\ }
\DoxyCodeLine{02045\ }
\DoxyCodeLine{02046\ \textcolor{comment}{/*****************************************************************************}}
\DoxyCodeLine{02047\ \textcolor{comment}{\ *\ handle\ messages\ from\ directory\ (in\ network\ thread)}}
\DoxyCodeLine{02048\ \textcolor{comment}{\ *****************************************************************************/}}
\DoxyCodeLine{02049\ }
\DoxyCodeLine{02050\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02051\ CacheCntlr::handleMsgFromDramDirectory(}
\DoxyCodeLine{02052\ \ \ \ \ \ \ core\_id\_t\ sender,\ PrL1PrL2DramDirectoryMSI::ShmemMsg*\ shmem\_msg)}
\DoxyCodeLine{02053\ \{}
\DoxyCodeLine{02054\ \ \ \ PrL1PrL2DramDirectoryMSI::ShmemMsg::msg\_t\ shmem\_msg\_type\ =\ shmem\_msg-\/>getMsgType();}
\DoxyCodeLine{02055\ \ \ \ IntPtr\ address\ =\ shmem\_msg-\/>getAddress();}
\DoxyCodeLine{02056\ \ \ \ core\_id\_t\ requester\ =\ INVALID\_CORE\_ID;}
\DoxyCodeLine{02057\ \ \ \ \textcolor{keywordflow}{if}\ ((shmem\_msg\_type\ ==\ PrL1PrL2DramDirectoryMSI::ShmemMsg::EX\_REP)\ ||\ (shmem\_msg\_type\ ==\ PrL1PrL2DramDirectoryMSI::ShmemMsg::SH\_REP)}
\DoxyCodeLine{02058\ \ \ \ \ \ \ \ \ \ ||\ (shmem\_msg\_type\ ==\ PrL1PrL2DramDirectoryMSI::ShmemMsg::UPGRADE\_REP)\ )}
\DoxyCodeLine{02059\ \ \ \ \{}
\DoxyCodeLine{02060\ \ \ \ \ \ \ ScopedLock\ sl(getLock());\ \textcolor{comment}{//\ Keep\ lock\ when\ handling\ m\_directory\_waiters}}
\DoxyCodeLine{02061\ \ \ \ \ \ \ CacheDirectoryWaiter*\ request\ =\ m\_master-\/>m\_directory\_waiters.front(address);}
\DoxyCodeLine{02062\ \ \ \ \ \ \ requester\ =\ request-\/>cache\_cntlr-\/>m\_core\_id;}
\DoxyCodeLine{02063\ \ \ \ \}}
\DoxyCodeLine{02064\ }
\DoxyCodeLine{02065\ \ \ \ acquireStackLock(address);}
\DoxyCodeLine{02066\ MYLOG(\textcolor{stringliteral}{"{}begin"{}});}
\DoxyCodeLine{02067\ }
\DoxyCodeLine{02068\ \ \ \ \textcolor{keywordflow}{switch}\ (shmem\_msg\_type)}
\DoxyCodeLine{02069\ \ \ \ \{}
\DoxyCodeLine{02070\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ PrL1PrL2DramDirectoryMSI::ShmemMsg::EX\_REP:}
\DoxyCodeLine{02071\ MYLOG(\textcolor{stringliteral}{"{}EX\ REP<\%u\ @\ \%lx"{}},\ sender,\ address);}
\DoxyCodeLine{02072\ \ \ \ \ \ \ \ \ \ processExRepFromDramDirectory(sender,\ requester,\ shmem\_msg);}
\DoxyCodeLine{02073\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02074\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ PrL1PrL2DramDirectoryMSI::ShmemMsg::SH\_REP:}
\DoxyCodeLine{02075\ MYLOG(\textcolor{stringliteral}{"{}SH\ REP<\%u\ @\ \%lx"{}},\ sender,\ address);}
\DoxyCodeLine{02076\ \ \ \ \ \ \ \ \ \ processShRepFromDramDirectory(sender,\ \ requester,\ shmem\_msg);}
\DoxyCodeLine{02077\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02078\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ PrL1PrL2DramDirectoryMSI::ShmemMsg::UPGRADE\_REP:}
\DoxyCodeLine{02079\ MYLOG(\textcolor{stringliteral}{"{}UPGR\ REP<\%u\ @\ \%lx"{}},\ sender,\ address);}
\DoxyCodeLine{02080\ \ \ \ \ \ \ \ \ \ processUpgradeRepFromDramDirectory(sender,\ requester,\ shmem\_msg);}
\DoxyCodeLine{02081\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02082\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ PrL1PrL2DramDirectoryMSI::ShmemMsg::INV\_REQ:}
\DoxyCodeLine{02083\ MYLOG(\textcolor{stringliteral}{"{}INV\ REQ<\%u\ @\ \%lx"{}},\ sender,\ address);}
\DoxyCodeLine{02084\ \ \ \ \ \ \ \ \ \ processInvReqFromDramDirectory(sender,\ shmem\_msg);}
\DoxyCodeLine{02085\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02086\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ PrL1PrL2DramDirectoryMSI::ShmemMsg::FLUSH\_REQ:}
\DoxyCodeLine{02087\ MYLOG(\textcolor{stringliteral}{"{}FLUSH\ REQ<\%u\ @\ \%lx"{}},\ sender,\ address);}
\DoxyCodeLine{02088\ \ \ \ \ \ \ \ \ \ processFlushReqFromDramDirectory(sender,\ shmem\_msg);}
\DoxyCodeLine{02089\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02090\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ PrL1PrL2DramDirectoryMSI::ShmemMsg::WB\_REQ:}
\DoxyCodeLine{02091\ MYLOG(\textcolor{stringliteral}{"{}WB\ REQ<\%u\ @\ \%lx"{}},\ sender,\ address);}
\DoxyCodeLine{02092\ \ \ \ \ \ \ \ \ \ processWbReqFromDramDirectory(sender,\ shmem\_msg);}
\DoxyCodeLine{02093\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02094\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{02095\ \ \ \ \ \ \ \ \ \ LOG\_PRINT\_ERROR(\textcolor{stringliteral}{"{}Unrecognized\ msg\ type:\ \%u"{}},\ shmem\_msg\_type);}
\DoxyCodeLine{02096\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02097\ \ \ \ \}}
\DoxyCodeLine{02098\ }
\DoxyCodeLine{02099\ \ \ \ \textcolor{keywordflow}{if}\ ((shmem\_msg\_type\ ==\ PrL1PrL2DramDirectoryMSI::ShmemMsg::EX\_REP)\ ||\ (shmem\_msg\_type\ ==\ PrL1PrL2DramDirectoryMSI::ShmemMsg::SH\_REP)}
\DoxyCodeLine{02100\ \ \ \ \ \ \ \ \ \ ||\ (shmem\_msg\_type\ ==\ PrL1PrL2DramDirectoryMSI::ShmemMsg::UPGRADE\_REP)\ )}
\DoxyCodeLine{02101\ \ \ \ \{}
\DoxyCodeLine{02102\ \ \ \ \ \ \ getLock().acquire();\ \textcolor{comment}{//\ Keep\ lock\ when\ handling\ m\_directory\_waiters}}
\DoxyCodeLine{02103\ \ \ \ \ \ \ \textcolor{keywordflow}{while}(!\ m\_master-\/>m\_directory\_waiters.empty(address))\ \{}
\DoxyCodeLine{02104\ \ \ \ \ \ \ \ \ \ CacheDirectoryWaiter*\ request\ =\ m\_master-\/>m\_directory\_waiters.front(address);}
\DoxyCodeLine{02105\ \ \ \ \ \ \ \ \ \ getLock().release();}
\DoxyCodeLine{02106\ }
\DoxyCodeLine{02107\ \ \ \ \ \ \ \ \ \ request-\/>cache\_cntlr-\/>m\_shmem\_perf-\/>updateTime(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD),\ ShmemPerf::PENDING\_HIT);}
\DoxyCodeLine{02108\ }
\DoxyCodeLine{02109\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (request-\/>exclusive\ \&\&\ (getCacheState(address)\ ==\ CacheState::SHARED))}
\DoxyCodeLine{02110\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02111\ \ \ \ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}have\ SHARED,\ upgrading\ to\ MODIFIED\ for\ \#\%u"{}},\ request-\/>cache\_cntlr-\/>m\_core\_id);}
\DoxyCodeLine{02112\ }
\DoxyCodeLine{02113\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ (the\ master\ cache)\ are\ sending\ the\ upgrade\ request\ in\ place\ of\ request-\/>cache\_cntlr,}}
\DoxyCodeLine{02114\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ so\ use\ their\ ShmemPerf*\ rather\ than\ ours}}
\DoxyCodeLine{02115\ \ \ \ \ \ \ \ \ \ \ \ \ processUpgradeReqToDirectory(address,\ request-\/>cache\_cntlr-\/>m\_shmem\_perf,\ ShmemPerfModel::\_SIM\_THREAD,request-\/>block\_type);}
\DoxyCodeLine{02116\ }
\DoxyCodeLine{02117\ \ \ \ \ \ \ \ \ \ \ \ \ releaseStackLock(address);}
\DoxyCodeLine{02118\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{02119\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02120\ }
\DoxyCodeLine{02121\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (request-\/>isPrefetch)}
\DoxyCodeLine{02122\ \ \ \ \ \ \ \ \ \ \ \ \ getCacheBlockInfo(address)-\/>setOption(CacheBlockInfo::PREFETCH);}
\DoxyCodeLine{02123\ }
\DoxyCodeLine{02124\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Set\ the\ Counters\ in\ the\ Shmem\ Perf\ model\ accordingly}}
\DoxyCodeLine{02125\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Set\ the\ counter\ value\ in\ the\ USER\ thread\ to\ that\ in\ the\ SIM\ thread}}
\DoxyCodeLine{02126\ \ \ \ \ \ \ \ \ \ SubsecondTime\ t\_core\ =\ request-\/>cache\_cntlr-\/>getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD),}
\DoxyCodeLine{02127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ t\_here\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02128\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (t\_here\ >\ t\_core)\ \{}
\DoxyCodeLine{02129\ MYLOG(\textcolor{stringliteral}{"{}adjusting\ time\ in\ \#\%u\ from\ \%lu\ to\ \%lu"{}},\ request-\/>cache\_cntlr-\/>m\_core\_id,\ t\_core.getNS(),\ t\_here.getNS());}
\DoxyCodeLine{02130\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Unless\ the\ requesting\ core\ is\ already\ ahead\ of\ us\ (it\ may\ very\ well\ be\ if\ this\ cache's\ master\ thread's\ cpu}}
\DoxyCodeLine{02131\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ is\ falling\ behind),\ update\ its\ time\ */}}
\DoxyCodeLine{02132\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ update\ master\ thread\ time\ in\ initiateDirectoryAccess\ ?}}
\DoxyCodeLine{02133\ \ \ \ \ \ \ \ \ \ \ \ \ request-\/>cache\_cntlr-\/>getShmemPerfModel()-\/>setElapsedTime(ShmemPerfModel::\_USER\_THREAD,\ t\_here);}
\DoxyCodeLine{02134\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02135\ }
\DoxyCodeLine{02136\ MYLOG(\textcolor{stringliteral}{"{}wakeup\ user\ \#\%u"{}},\ request-\/>cache\_cntlr-\/>m\_core\_id);}
\DoxyCodeLine{02137\ \ \ \ \ \ \ \ \ \ request-\/>cache\_cntlr-\/>updateUncoreStatistics(shmem\_msg-\/>getWhere(),\ t\_here);}
\DoxyCodeLine{02138\ }
\DoxyCodeLine{02139\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//releaseStackLock(address);}}
\DoxyCodeLine{02140\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Pass\ stack\ lock\ through\ to\ user\ thread}}
\DoxyCodeLine{02141\ \ \ \ \ \ \ \ \ \ wakeUpUserThread(request-\/>cache\_cntlr-\/>m\_user\_thread\_sem);}
\DoxyCodeLine{02142\ \ \ \ \ \ \ \ \ \ waitForUserThread(request-\/>cache\_cntlr-\/>m\_network\_thread\_sem);}
\DoxyCodeLine{02143\ \ \ \ \ \ \ \ \ \ acquireStackLock(address);}
\DoxyCodeLine{02144\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(request-\/>block\_type\ ==\ CacheBlockInfo::block\_type\_t::NON\_PAGE\_TABLE)}
\DoxyCodeLine{02145\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02146\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(request-\/>cache\_cntlr-\/>getLock());}
\DoxyCodeLine{02147\ \ \ \ \ \ \ \ \ \ \ \ \ request-\/>cache\_cntlr-\/>m\_master-\/>mshr[address]\ =\ make\_mshr(request-\/>t\_issue,\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD));}
\DoxyCodeLine{02148\ \ \ \ \ \ \ \ \ \ \ \ \ cleanupMshr();}
\DoxyCodeLine{02149\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02150\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{02151\ \ \ \ \ \ \ \ \ \ \ \ \ ScopedLock\ sl(request-\/>cache\_cntlr-\/>getLock());}
\DoxyCodeLine{02152\ \ \ \ \ \ \ \ \ \ \ \ \ request-\/>cache\_cntlr-\/>m\_master-\/>metadata\_mshr[address]\ =\ make\_mshr(request-\/>t\_issue,\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD));}
\DoxyCodeLine{02153\ \ \ \ \ \ \ \ \ \ \ \ \ cleanupMetadataMshr();}
\DoxyCodeLine{02154\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02155\ }
\DoxyCodeLine{02156\ \ \ \ \ \ \ \ \ \ getLock().acquire();}
\DoxyCodeLine{02157\ \ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}about\ to\ dequeue\ request\ (\%p)\ for\ address\ \%lx"{}},\ m\_master-\/>m\_directory\_waiters.front(address),\ address\ );}
\DoxyCodeLine{02158\ \ \ \ \ \ \ \ \ \ m\_master-\/>m\_directory\_waiters.dequeue(address);}
\DoxyCodeLine{02159\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ request;}
\DoxyCodeLine{02160\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02161\ \ \ \ \ \ \ getLock().release();}
\DoxyCodeLine{02162\ MYLOG(\textcolor{stringliteral}{"{}woke\ up\ all"{}});}
\DoxyCodeLine{02163\ \ \ \ \}}
\DoxyCodeLine{02164\ }
\DoxyCodeLine{02165\ \ \ \ releaseStackLock(address);}
\DoxyCodeLine{02166\ }
\DoxyCodeLine{02167\ MYLOG(\textcolor{stringliteral}{"{}done"{}});}
\DoxyCodeLine{02168\ \}}
\DoxyCodeLine{02169\ }
\DoxyCodeLine{02170\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02171\ CacheCntlr::processExRepFromDramDirectory(core\_id\_t\ sender,\ core\_id\_t\ requester,\ PrL1PrL2DramDirectoryMSI::ShmemMsg*\ shmem\_msg)}
\DoxyCodeLine{02172\ \{}
\DoxyCodeLine{02173\ \ \ \ \textcolor{comment}{//\ Forward\ data\ from\ message\ to\ LLC,\ don't\ incur\ LLC\ data\ access\ time\ (writeback\ will\ be\ done\ asynchronously)}}
\DoxyCodeLine{02174\ \ \ \ \textcolor{comment}{//getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_DATA\_AND\_TAGS);}}
\DoxyCodeLine{02175\ MYLOG(\textcolor{stringliteral}{"{}processExRepFromDramDirectory\ l\%d"{}},\ m\_mem\_component);}
\DoxyCodeLine{02176\ }
\DoxyCodeLine{02177\ \ \ \ IntPtr\ address\ =\ shmem\_msg-\/>getAddress();}
\DoxyCodeLine{02178\ \ \ \ Byte*\ data\_buf\ =\ shmem\_msg-\/>getDataBuf();}
\DoxyCodeLine{02179\ }
\DoxyCodeLine{02180\ \ \ \ \textcolor{comment}{//\ @RBERA:\ this\ is\ CacheBlockInfo::block\_type\_t\ leak}}
\DoxyCodeLine{02181\ \ \ \ insertCacheBlock(address,\ CacheState::EXCLUSIVE,\ data\_buf,\ requester,\ ShmemPerfModel::\_SIM\_THREAD,shmem\_msg-\/>getBlockType());}
\DoxyCodeLine{02182\ MYLOG(\textcolor{stringliteral}{"{}processExRepFromDramDirectory\ l\%d\ end"{}},\ m\_mem\_component);}
\DoxyCodeLine{02183\ \}}
\DoxyCodeLine{02184\ }
\DoxyCodeLine{02185\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02186\ CacheCntlr::processShRepFromDramDirectory(core\_id\_t\ sender,\ core\_id\_t\ requester,\ PrL1PrL2DramDirectoryMSI::ShmemMsg*\ shmem\_msg)}
\DoxyCodeLine{02187\ \{}
\DoxyCodeLine{02188\ \ \ \ \textcolor{comment}{//\ Forward\ data\ from\ message\ to\ LLC,\ don't\ incur\ LLC\ data\ access\ time\ (writeback\ will\ be\ done\ asynchronously)}}
\DoxyCodeLine{02189\ \ \ \ \textcolor{comment}{//getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_DATA\_AND\_TAGS);}}
\DoxyCodeLine{02190\ MYLOG(\textcolor{stringliteral}{"{}processShRepFromDramDirectory\ l\%d"{}},\ m\_mem\_component);}
\DoxyCodeLine{02191\ }
\DoxyCodeLine{02192\ \ \ \ IntPtr\ address\ =\ shmem\_msg-\/>getAddress();}
\DoxyCodeLine{02193\ \ \ \ Byte*\ data\_buf\ =\ shmem\_msg-\/>getDataBuf();}
\DoxyCodeLine{02194\ }
\DoxyCodeLine{02195\ \ \ \ \textcolor{comment}{//\ Insert\ Cache\ Block\ in\ L2\ Cache}}
\DoxyCodeLine{02196\ \ \ \ \textcolor{comment}{//\ @RBERA:\ this\ is\ CacheBlockInfo::block\_type\_t\ leak}}
\DoxyCodeLine{02197\ \ \ \ insertCacheBlock(address,\ CacheState::SHARED,\ data\_buf,\ requester,\ ShmemPerfModel::\_SIM\_THREAD,shmem\_msg-\/>getBlockType());}
\DoxyCodeLine{02198\ \}}
\DoxyCodeLine{02199\ }
\DoxyCodeLine{02200\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02201\ CacheCntlr::processUpgradeRepFromDramDirectory(core\_id\_t\ sender,\ core\_id\_t\ requester,\ PrL1PrL2DramDirectoryMSI::ShmemMsg*\ shmem\_msg)}
\DoxyCodeLine{02202\ \{}
\DoxyCodeLine{02203\ MYLOG(\textcolor{stringliteral}{"{}processUpgradeFromDramDirectory\ l\%d"{}},\ m\_mem\_component);}
\DoxyCodeLine{02204\ \ \ \ \textcolor{comment}{//\ We\ now\ have\ the\ only\ copy.\ Change\ to\ a\ writeable\ state.}}
\DoxyCodeLine{02205\ \ \ \ IntPtr\ address\ =\ shmem\_msg-\/>getAddress();}
\DoxyCodeLine{02206\ \ \ \ CacheState::cstate\_t\ cstate\ =\ getCacheState(address);}
\DoxyCodeLine{02207\ }
\DoxyCodeLine{02208\ \ \ \ \textcolor{keywordflow}{if}\ (cstate\ ==\ CacheState::INVALID)}
\DoxyCodeLine{02209\ \ \ \ \{}
\DoxyCodeLine{02210\ \ \ \ \ \ \ \textcolor{comment}{//\ I\ lost\ my\ copy\ because\ a\ concurrent\ UPGRADE\ REQ\ had\ INVed\ it,\ because\ the\ state}}
\DoxyCodeLine{02211\ \ \ \ \ \ \ \textcolor{comment}{//\ was\ Modified\ \ when\ this\ request\ was\ processed,\ the\ data\ should\ be\ in\ the\ message}}
\DoxyCodeLine{02212\ \ \ \ \ \ \ \textcolor{comment}{//\ because\ it\ was\ FLUSHed\ (see\ dram\_directory\_cntlr.cc,\ MODIFIED\ case\ of\ the\ upgrade\ req)}}
\DoxyCodeLine{02213\ \ \ \ \ \ \ Byte*\ data\_buf\ =\ shmem\_msg-\/>getDataBuf();}
\DoxyCodeLine{02214\ \ \ \ \ \ \ LOG\_ASSERT\_ERROR(data\_buf,\ \textcolor{stringliteral}{"{}Trying\ to\ upgrade\ a\ block\ that\ is\ now\ INV\ and\ no\ data\ in\ the\ shmem\_msg"{}});}
\DoxyCodeLine{02215\ }
\DoxyCodeLine{02216\ \ \ \ \ \ \ updateCacheBlock(address,\ CacheState::MODIFIED,\ Transition::UPGRADE,\ data\_buf,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02217\ \ \ \ \}}
\DoxyCodeLine{02218\ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ \ (cstate\ ==\ CacheState::SHARED\_UPGRADING)}
\DoxyCodeLine{02219\ \ \ \ \{}
\DoxyCodeLine{02220\ \ \ \ \ \ \ \textcolor{comment}{//\ Last-\/Level\ Cache\ received\ a\ upgrade\ REP,\ but\ multiple\ private\ lower-\/level\ caches\ might}}
\DoxyCodeLine{02221\ \ \ \ \ \ \ \textcolor{comment}{//\ still\ have\ a\ shared\ copy.\ Should\ invalidate\ all\ except\ the\ ones\ from\ the\ core\ that\ initiated}}
\DoxyCodeLine{02222\ \ \ \ \ \ \ \textcolor{comment}{//\ the\ upgrade\ request\ (sender).}}
\DoxyCodeLine{02223\ }
\DoxyCodeLine{02224\ \ \ \ \ \ \ updateCacheBlock(address,\ CacheState::MODIFIED,\ Transition::UPGRADE,\ NULL,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02225\ \ \ \ \}}
\DoxyCodeLine{02226\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02227\ \ \ \ \{}
\DoxyCodeLine{02228\ \ \ \ \ \ \ LOG\_PRINT\_ERROR(\textcolor{stringliteral}{"{}Trying\ to\ upgrade\ a\ block\ that\ is\ not\ SHARED\_UPGRADING\ but\ \%c\ (\%lx)"{}},CStateString(cstate),\ address);}
\DoxyCodeLine{02229\ \ \ \ \}}
\DoxyCodeLine{02230\ \}}
\DoxyCodeLine{02231\ }
\DoxyCodeLine{02232\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02233\ CacheCntlr::processInvReqFromDramDirectory(core\_id\_t\ sender,\ PrL1PrL2DramDirectoryMSI::ShmemMsg*\ shmem\_msg)}
\DoxyCodeLine{02234\ \{}
\DoxyCodeLine{02235\ \ \ \ IntPtr\ address\ =\ shmem\_msg-\/>getAddress();}
\DoxyCodeLine{02236\ MYLOG(\textcolor{stringliteral}{"{}processInvReqFromDramDirectory\ l\%d"{}},\ m\_mem\_component);}
\DoxyCodeLine{02237\ }
\DoxyCodeLine{02238\ \ \ \ CacheState::cstate\_t\ cstate\ =\ getCacheState(address);}
\DoxyCodeLine{02239\ \ \ \ \textcolor{keywordflow}{if}\ (cstate\ !=\ CacheState::INVALID)}
\DoxyCodeLine{02240\ \ \ \ \{}
\DoxyCodeLine{02241\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cstate\ !=\ CacheState::SHARED)}
\DoxyCodeLine{02242\ \ \ \ \ \ \ \{}
\DoxyCodeLine{02243\ \ \ \ \ \ \ \ \ MYLOG(\textcolor{stringliteral}{"{}invalidating\ something\ else\ than\ SHARED:\ \%c\ "{}},\ CStateString(cstate));}
\DoxyCodeLine{02244\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02245\ \ \ \ \ \ \ \textcolor{comment}{//assert(cstate\ ==\ CacheState::SHARED);}}
\DoxyCodeLine{02246\ \ \ \ \ \ \ shmem\_msg-\/>getPerf()-\/>updateTime(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD));}
\DoxyCodeLine{02247\ }
\DoxyCodeLine{02248\ \ \ \ \ \ \ \textcolor{comment}{//\ Update\ Shared\ Mem\ perf\ counters\ for\ access\ to\ L2\ Cache}}
\DoxyCodeLine{02249\ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_TAGS,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02250\ \ \ \ \ \ \textcolor{comment}{//\ std::cout\ <<\ "{}Update\ Cache\ Block:\ "{}\ <<\ \_\_LINE\_\_\ <<\ "{}\ "{}<<CStateString(CacheState::INVALID)<<std::endl;}}
\DoxyCodeLine{02251\ \ \ \ \ \ \ updateCacheBlock(address,\ CacheState::INVALID,\ Transition::COHERENCY,\ NULL,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02252\ }
\DoxyCodeLine{02253\ \ \ \ \ \ \ shmem\_msg-\/>getPerf()-\/>updateTime(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD),\ ShmemPerf::REMOTE\_CACHE\_INV);}
\DoxyCodeLine{02254\ \ \ \ \ \ \ \textcolor{comment}{//std::cout<<"{}Send\ Message\ from\ address:\ "{}<<std::hex<<address<<"{}\ processInvReqFromDramDirectory\(\backslash\)n"{};}}
\DoxyCodeLine{02255\ \ \ \ \ \ \ getMemoryManager()-\/>sendMsg(PrL1PrL2DramDirectoryMSI::ShmemMsg::INV\_REP,}
\DoxyCodeLine{02256\ \ \ \ \ \ \ \ \ \ \ \ \ MemComponent::LAST\_LEVEL\_CACHE,\ MemComponent::TAG\_DIR,}
\DoxyCodeLine{02257\ \ \ \ \ \ \ \ \ \ \ \ \ shmem\_msg-\/>getRequester()\ \textcolor{comment}{/*\ requester\ */},}
\DoxyCodeLine{02258\ \ \ \ \ \ \ \ \ \ \ \ \ sender\ \textcolor{comment}{/*\ receiver\ */},}
\DoxyCodeLine{02259\ \ \ \ \ \ \ \ \ \ \ \ \ address,}
\DoxyCodeLine{02260\ \ \ \ \ \ \ \ \ \ \ \ \ NULL,\ 0,}
\DoxyCodeLine{02261\ \ \ \ \ \ \ \ \ \ \ \ \ HitWhere::UNKNOWN,\ shmem\_msg-\/>getPerf(),\ ShmemPerfModel::\_SIM\_THREAD,shmem\_msg-\/>getBlockType());}
\DoxyCodeLine{02262\ \ \ \ \}}
\DoxyCodeLine{02263\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02264\ \ \ \ \{}
\DoxyCodeLine{02265\ \ \ \ \ \ \ \textcolor{comment}{//\ Update\ Shared\ Mem\ perf\ counters\ for\ access\ to\ L2\ Cache}}
\DoxyCodeLine{02266\ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_TAGS,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02267\ MYLOG(\textcolor{stringliteral}{"{}invalid\ @\ \%lx,\ hoping\ eviction\ message\ is\ underway"{}},\ address);}
\DoxyCodeLine{02268\ \ \ \ \}}
\DoxyCodeLine{02269\ \}}
\DoxyCodeLine{02270\ }
\DoxyCodeLine{02271\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02272\ CacheCntlr::processFlushReqFromDramDirectory(core\_id\_t\ sender,\ PrL1PrL2DramDirectoryMSI::ShmemMsg*\ shmem\_msg)}
\DoxyCodeLine{02273\ \{}
\DoxyCodeLine{02274\ \ \ \ IntPtr\ address\ =\ shmem\_msg-\/>getAddress();}
\DoxyCodeLine{02275\ \ \ \ \ \ \ \ \ \ IntPtr\ tag;}
\DoxyCodeLine{02276\ \ \ \ \ \ \ \ UInt32\ set\_index;}
\DoxyCodeLine{02277\ }
\DoxyCodeLine{02278\ \ \ \ m\_last\_level-\/>getCache()-\/>splitAddress(address,\ tag,\ set\_index);}
\DoxyCodeLine{02279\ MYLOG(\textcolor{stringliteral}{"{}processFlushReqFromDramDirectory\ l\%d"{}},\ m\_mem\_component);}
\DoxyCodeLine{02280\ }
\DoxyCodeLine{02281\ \ \ \ \textcolor{comment}{//std::cout<<"{}Send\ Message\ from\ address:\ "{}<<address<<"{}\ processFlushReqFromDramDirectory\(\backslash\)n"{};}}
\DoxyCodeLine{02282\ \ \ \ CacheState::cstate\_t\ cstate\ =\ getCacheState(address);}
\DoxyCodeLine{02283\ \ \ \ \textcolor{keywordflow}{if}\ (cstate\ !=\ CacheState::INVALID)}
\DoxyCodeLine{02284\ \ \ \ \{}
\DoxyCodeLine{02285\ \ \ \ \ \ \ \textcolor{comment}{//assert(cstate\ ==\ CacheState::MODIFIED);}}
\DoxyCodeLine{02286\ \ \ \ \ \ \ shmem\_msg-\/>getPerf()-\/>updateTime(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD));}
\DoxyCodeLine{02287\ }
\DoxyCodeLine{02288\ \ \ \ \ \ \ \textcolor{comment}{//\ Update\ Shared\ Mem\ perf\ counters\ for\ access\ to\ L2\ Cache}}
\DoxyCodeLine{02289\ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_DATA\_AND\_TAGS,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02290\ }
\DoxyCodeLine{02291\ \ \ \ \ \ \ \textcolor{comment}{//\ Flush\ the\ line}}
\DoxyCodeLine{02292\ \ \ \ \ \ \ Byte\ data\_buf[getCacheBlockSize()];}
\DoxyCodeLine{02293\ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Update\ Cache\ Block:\ "{}\ <<\ \_\_LINE\_\_\ <<\ "{}\ "{}<<CStateString(CacheState::INVALID)<<std::endl;}}
\DoxyCodeLine{02294\ \ \ \ \ \ \ updateCacheBlock(address,\ CacheState::INVALID,\ Transition::COHERENCY,\ data\_buf,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02295\ }
\DoxyCodeLine{02296\ \ \ \ \ \ \ shmem\_msg-\/>getPerf()-\/>updateTime(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD),\ ShmemPerf::REMOTE\_CACHE\_WB);}
\DoxyCodeLine{02297\ }
\DoxyCodeLine{02298\ \ \ \ \ \ \ getMemoryManager()-\/>sendMsg(PrL1PrL2DramDirectoryMSI::ShmemMsg::FLUSH\_REP,}
\DoxyCodeLine{02299\ \ \ \ \ \ \ \ \ \ \ \ \ MemComponent::LAST\_LEVEL\_CACHE,\ MemComponent::TAG\_DIR,}
\DoxyCodeLine{02300\ \ \ \ \ \ \ \ \ \ \ \ \ shmem\_msg-\/>getRequester()\ \textcolor{comment}{/*\ requester\ */},}
\DoxyCodeLine{02301\ \ \ \ \ \ \ \ \ \ \ \ \ sender\ \textcolor{comment}{/*\ receiver\ */},}
\DoxyCodeLine{02302\ \ \ \ \ \ \ \ \ \ \ \ \ address,}
\DoxyCodeLine{02303\ \ \ \ \ \ \ \ \ \ \ \ \ data\_buf,\ getCacheBlockSize(),}
\DoxyCodeLine{02304\ \ \ \ \ \ \ \ \ \ \ \ \ HitWhere::UNKNOWN,\ shmem\_msg-\/>getPerf(),\ ShmemPerfModel::\_SIM\_THREAD,shmem\_msg-\/>getBlockType());}
\DoxyCodeLine{02305\ \ \ \ \}}
\DoxyCodeLine{02306\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02307\ \ \ \ \{}
\DoxyCodeLine{02308\ \ \ \ \ \ \ \textcolor{comment}{//\ Update\ Shared\ Mem\ perf\ counters\ for\ access\ to\ L2\ Cache}}
\DoxyCodeLine{02309\ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_TAGS,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02310\ MYLOG(\textcolor{stringliteral}{"{}invalid\ @\ \%lx,\ hoping\ eviction\ message\ is\ underway"{}},\ address);}
\DoxyCodeLine{02311\ \ \ \ \}}
\DoxyCodeLine{02312\ \}}
\DoxyCodeLine{02313\ }
\DoxyCodeLine{02314\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02315\ CacheCntlr::processWbReqFromDramDirectory(core\_id\_t\ sender,\ PrL1PrL2DramDirectoryMSI::ShmemMsg*\ shmem\_msg)}
\DoxyCodeLine{02316\ \{}
\DoxyCodeLine{02317\ \ \ \ IntPtr\ address\ =\ shmem\_msg-\/>getAddress();}
\DoxyCodeLine{02318\ MYLOG(\textcolor{stringliteral}{"{}processWbReqFromDramDirectory\ l\%d"{}},\ m\_mem\_component);}
\DoxyCodeLine{02319\ }
\DoxyCodeLine{02320\ \ \ \ CacheState::cstate\_t\ cstate\ =\ getCacheState(address);}
\DoxyCodeLine{02321\ \ \ \ \textcolor{keywordflow}{if}\ (cstate\ !=\ CacheState::INVALID)}
\DoxyCodeLine{02322\ \ \ \ \{}
\DoxyCodeLine{02323\ \ \ \ \ \ \ \textcolor{comment}{//assert(cstate\ ==\ CacheState::MODIFIED);}}
\DoxyCodeLine{02324\ \ \ \ \ \ \ shmem\_msg-\/>getPerf()-\/>updateTime(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD));}
\DoxyCodeLine{02325\ }
\DoxyCodeLine{02326\ \ \ \ \ \ \ \textcolor{comment}{//\ Update\ Shared\ Mem\ perf\ counters\ for\ access\ to\ L2\ Cache}}
\DoxyCodeLine{02327\ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_DATA\_AND\_TAGS,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02328\ }
\DoxyCodeLine{02329\ \ \ \ \ \ \ \textcolor{comment}{//\ Write-\/Back\ the\ line}}
\DoxyCodeLine{02330\ \ \ \ \ \ \ Byte\ data\_buf[getCacheBlockSize()];}
\DoxyCodeLine{02331\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cstate\ !=\ CacheState::SHARED\_UPGRADING)}
\DoxyCodeLine{02332\ \ \ \ \ \ \ \{}
\DoxyCodeLine{02333\ \ \ \ \ \ \ \ \ \ updateCacheBlock(address,\ CacheState::SHARED,\ Transition::COHERENCY,\ data\_buf,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02334\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02335\ }
\DoxyCodeLine{02336\ \ \ \ \ \ \ shmem\_msg-\/>getPerf()-\/>updateTime(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD),\ ShmemPerf::REMOTE\_CACHE\_FWD);}
\DoxyCodeLine{02337\ \ \ \ \ \ \ \textcolor{comment}{//std::cout<<"{}Send\ Message\ from\ address:\ "{}<<std::hex<<address<<"{}\ processWbReqFromDramDirectory\(\backslash\)n"{};}}
\DoxyCodeLine{02338\ \ \ \ \ \ \ getMemoryManager()-\/>sendMsg(PrL1PrL2DramDirectoryMSI::ShmemMsg::WB\_REP,}
\DoxyCodeLine{02339\ \ \ \ \ \ \ \ \ \ \ \ \ MemComponent::LAST\_LEVEL\_CACHE,\ MemComponent::TAG\_DIR,}
\DoxyCodeLine{02340\ \ \ \ \ \ \ \ \ \ \ \ \ shmem\_msg-\/>getRequester()\ \textcolor{comment}{/*\ requester\ */},}
\DoxyCodeLine{02341\ \ \ \ \ \ \ \ \ \ \ \ \ sender\ \textcolor{comment}{/*\ receiver\ */},}
\DoxyCodeLine{02342\ \ \ \ \ \ \ \ \ \ \ \ \ address,}
\DoxyCodeLine{02343\ \ \ \ \ \ \ \ \ \ \ \ \ data\_buf,\ getCacheBlockSize(),}
\DoxyCodeLine{02344\ \ \ \ \ \ \ \ \ \ \ \ \ HitWhere::UNKNOWN,\ shmem\_msg-\/>getPerf(),\ ShmemPerfModel::\_SIM\_THREAD,shmem\_msg-\/>getBlockType());}
\DoxyCodeLine{02345\ \ \ \ \}}
\DoxyCodeLine{02346\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02347\ \ \ \ \{}
\DoxyCodeLine{02348\ \ \ \ \ \ \ \textcolor{comment}{//\ Update\ Shared\ Mem\ perf\ counters\ for\ access\ to\ L2\ Cache}}
\DoxyCodeLine{02349\ \ \ \ \ \ \ getMemoryManager()-\/>incrElapsedTime(m\_mem\_component,\ CachePerfModel::ACCESS\_CACHE\_TAGS,\ ShmemPerfModel::\_SIM\_THREAD);}
\DoxyCodeLine{02350\ \ \ \ \ \ \ shmem\_msg-\/>getPerf()-\/>updateTime(getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_SIM\_THREAD),\ ShmemPerf::REMOTE\_CACHE\_WB);}
\DoxyCodeLine{02351\ MYLOG(\textcolor{stringliteral}{"{}invalid\ @\ \%lx,\ hoping\ eviction\ message\ is\ underway"{}},\ address);}
\DoxyCodeLine{02352\ \ \ \ \}}
\DoxyCodeLine{02353\ \}}
\DoxyCodeLine{02354\ }
\DoxyCodeLine{02355\ }
\DoxyCodeLine{02356\ }
\DoxyCodeLine{02357\ \textcolor{comment}{/*****************************************************************************}}
\DoxyCodeLine{02358\ \textcolor{comment}{\ *\ statistics\ functions}}
\DoxyCodeLine{02359\ \textcolor{comment}{\ *****************************************************************************/}}
\DoxyCodeLine{02360\ }
\DoxyCodeLine{02361\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02362\ CacheCntlr::updateCounters(Core::mem\_op\_t\ mem\_op\_type,\ IntPtr\ address,\ \textcolor{keywordtype}{bool}\ cache\_hit,\ CacheState::cstate\_t\ state,\ CacheBlockInfo::block\_type\_t\ block\_type,Prefetch::prefetch\_type\_t\ isPrefetch)}
\DoxyCodeLine{02363\ \{}
\DoxyCodeLine{02364\ \ \ \ \textcolor{comment}{/*\ If\ another\ miss\ to\ this\ cache\ line\ is\ still\ in\ progress:}}
\DoxyCodeLine{02365\ \textcolor{comment}{\ \ \ \ \ \ operationPermissibleinCache()\ will\ think\ it's\ a\ hit\ (so\ cache\_hit\ ==\ true)\ since\ the\ processing}}
\DoxyCodeLine{02366\ \textcolor{comment}{\ \ \ \ \ \ of\ the\ previous\ miss\ was\ done\ instantaneously.\ But\ mshr[address]\ contains\ its\ completion\ time\ */}}
\DoxyCodeLine{02367\ \ \ \ \textcolor{keywordtype}{bool}\ IsMetadata=\ block\_type\ ==\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE\ ||}
\DoxyCodeLine{02368\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ block\_type\ ==\ CacheBlockInfo::block\_type\_t::PAGE\_TABLE\_PASSTHROUGH\ ||}
\DoxyCodeLine{02369\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ block\_type\ ==\ CacheBlockInfo::block\_type\_t::SECURITY\ ||}
\DoxyCodeLine{02370\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ block\_type\ ==\ CacheBlockInfo::block\_type\_t::EXPRESSIVE\ ||}
\DoxyCodeLine{02371\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ block\_type\ ==\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY\ ||}
\DoxyCodeLine{02372\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ block\_type\ ==\ CacheBlockInfo::block\_type\_t::TLB\_ENTRY\_PASSTHROUGH;}
\DoxyCodeLine{02373\ }
\DoxyCodeLine{02374\ \ \ \ SubsecondTime\ t\_now\ =\ getShmemPerfModel()-\/>getElapsedTime(ShmemPerfModel::\_USER\_THREAD);}
\DoxyCodeLine{02375\ \ \ \ \textcolor{keywordtype}{bool}\ overlapping;}
\DoxyCodeLine{02376\ \ \ \ \textcolor{keywordflow}{if}(!IsMetadata)\{}
\DoxyCodeLine{02377\ \ \ \ \ \ \ overlapping=m\_master-\/>mshr.count(address)\ \&\&\ m\_master-\/>mshr[address].t\_issue\ <\ t\_now\ \&\&\ m\_master-\/>mshr[address].t\_complete\ >\ t\_now;}
\DoxyCodeLine{02378\ \ \ \ \}}
\DoxyCodeLine{02379\ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{02380\ \ \ \ \ \ \ overlapping=m\_master-\/>metadata\_mshr.count(address)\ \&\&\ m\_master-\/>metadata\_mshr[address].t\_issue\ <\ t\_now\ \&\&\ m\_master-\/>metadata\_mshr[address].t\_complete\ >\ t\_now;}
\DoxyCodeLine{02381\ \ \ \ \}}
\DoxyCodeLine{02382\ \ \ \ \textcolor{comment}{//\ ATD\ doesn't\ track\ state,\ so\ when\ reporting\ hit/miss\ to\ it\ we\ shouldn't\ either\ (i.e.\ write\ hit\ to\ shared\ line\ becomes\ hit,\ not\ miss)}}
\DoxyCodeLine{02383\ \ \ \ \textcolor{keywordtype}{bool}\ cache\_data\_hit\ =\ (state\ !=\ CacheState::INVALID);}
\DoxyCodeLine{02384\ \ \ \ m\_master-\/>accessATDs(mem\_op\_type,\ cache\_data\_hit,\ address,\ m\_core\_id\ -\/\ m\_core\_id\_master);}
\DoxyCodeLine{02385\ }
\DoxyCodeLine{02386\ \ \ \ \textcolor{keywordflow}{if}\ (mem\_op\_type\ ==\ Core::WRITE)}
\DoxyCodeLine{02387\ \ \ \ \{}
\DoxyCodeLine{02388\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isPrefetch\ !=\ Prefetch::OWN)}
\DoxyCodeLine{02389\ \ \ \ \ \ \ \{}
\DoxyCodeLine{02390\ \ \ \ \ \ \ \ \ \ stats.stores[block\_type]++;}
\DoxyCodeLine{02391\ \ \ \ \ \ \ \ \ \ stats.tstores++;}
\DoxyCodeLine{02392\ \ \ \ \ \ \ \ \ \ stats.stores\_state[state][block\_type]++;}
\DoxyCodeLine{02393\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\ cache\_hit\ ||\ overlapping)\ \{}
\DoxyCodeLine{02394\ \ \ \ \ \ \ \ \ \ \ \ \ stats.tstore\_misses++;}
\DoxyCodeLine{02395\ \ \ \ \ \ \ \ \ \ \ \ \ stats.store\_misses[block\_type]++;}
\DoxyCodeLine{02396\ \ \ \ \ \ \ \ \ \ \ \ \ stats.store\_misses\_state[state][block\_type]++;}
\DoxyCodeLine{02397\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (overlapping)\ \{}
\DoxyCodeLine{02398\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stats.store\_overlapping\_misses[block\_type]++;}
\DoxyCodeLine{02399\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02400\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02401\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02402\ \ \ \ \ \ \ }
\DoxyCodeLine{02403\ \ \ \ \ \ \ }
\DoxyCodeLine{02404\ \ \ \ \ \ \ }
\DoxyCodeLine{02405\ \ \ \ \}}
\DoxyCodeLine{02406\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02407\ \ \ \ \{}
\DoxyCodeLine{02408\ \ \ \ \ \ \ }
\DoxyCodeLine{02409\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isPrefetch\ !=\ Prefetch::NONE)}
\DoxyCodeLine{02410\ \ \ \ \ \ \ \ \ \ stats.loads\_prefetch[block\_type]++;}
\DoxyCodeLine{02411\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isPrefetch\ !=\ Prefetch::OWN)}
\DoxyCodeLine{02412\ \ \ \ \ \ \ \{}
\DoxyCodeLine{02413\ \ \ \ \ \ \ \ \ \ stats.tloads++;}
\DoxyCodeLine{02414\ \ \ \ \ \ \ \ \ \ stats.loads[block\_type]++;}
\DoxyCodeLine{02415\ \ \ \ \ \ \ \ \ \ stats.loads\_state[state][block\_type]++;}
\DoxyCodeLine{02416\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\ cache\_hit)\ \{}
\DoxyCodeLine{02417\ \ \ \ \ \ \ \ \ \ \ \ \ stats.tload\_misses++;}
\DoxyCodeLine{02418\ \ \ \ \ \ \ \ \ \ \ \ \ stats.load\_misses[block\_type]++;}
\DoxyCodeLine{02419\ \ \ \ \ \ \ \ \ \ \ \ \ stats.load\_misses\_state[state][block\_type]++;}
\DoxyCodeLine{02420\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (overlapping)\ \{}
\DoxyCodeLine{02421\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stats.load\_overlapping\_misses[block\_type]++;}
\DoxyCodeLine{02422\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{02423\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02424\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02425\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{02426\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//std::cout\ <<\ "{}Increase\ Reuse\ for\ address:\ "{}\ <<\ address\ <<\ "{}with\ reuse:\ "{}\ <<\ getCache()-\/>peekSingleLine(address)-\/>getReuse()\ <<std::endl;}}
\DoxyCodeLine{02427\ \ \ \ \ \ \ \ \ \ \ \ \ getCache()-\/>peekSingleLine(address)-\/>increaseReuse();}
\DoxyCodeLine{02428\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02429\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02430\ \ \ \ \ \ \ }
\DoxyCodeLine{02431\ \ \ \ \ \ \ }
\DoxyCodeLine{02432\ \ \ \ \}}
\DoxyCodeLine{02433\ }
\DoxyCodeLine{02434\ \ \ \ \textcolor{keywordflow}{if}(!IsMetadata)\{}
\DoxyCodeLine{02435\ \ \ \ \ \ \ cleanupMshr();}
\DoxyCodeLine{02436\ \ \ \ \}}
\DoxyCodeLine{02437\ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{02438\ \ \ \ \ \ \ cleanupMetadataMshr();}
\DoxyCodeLine{02439\ \ \ \ \}}
\DoxyCodeLine{02440\ \ \ \ }
\DoxyCodeLine{02441\ }
\DoxyCodeLine{02442\ \textcolor{preprocessor}{\ \ \ \#ifdef\ ENABLE\_TRANSITIONS}}
\DoxyCodeLine{02443\ \ \ \ transition(}
\DoxyCodeLine{02444\ \ \ \ \ \ \ address,}
\DoxyCodeLine{02445\ \ \ \ \ \ \ mem\_op\_type\ ==\ Core::WRITE\ ?\ Transition::CORE\_WR\ :\ (mem\_op\_type\ ==\ Core::READ\_EX\ ?\ Transition::CORE\_RDEX\ :\ Transition::CORE\_RD),}
\DoxyCodeLine{02446\ \ \ \ \ \ \ state,}
\DoxyCodeLine{02447\ \ \ \ \ \ \ mem\_op\_type\ ==\ Core::READ\ \&\&\ state\ !=\ CacheState::MODIFIED\ ?\ CacheState::SHARED\ :\ CacheState::MODIFIED}
\DoxyCodeLine{02448\ \ \ \ );}
\DoxyCodeLine{02449\ \textcolor{preprocessor}{\ \ \ \#endif}}
\DoxyCodeLine{02450\ \}}
\DoxyCodeLine{02451\ }
\DoxyCodeLine{02452\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02453\ CacheCntlr::cleanupMshr()}
\DoxyCodeLine{02454\ \{}
\DoxyCodeLine{02455\ \ \ \ \textcolor{comment}{/*\ Keep\ only\ last\ 8\ MSHR\ entries\ */}}
\DoxyCodeLine{02456\ \ \ \ \textcolor{keywordflow}{while}(m\_master-\/>mshr.size()\ >\ 8)\ \{}
\DoxyCodeLine{02457\ \ \ \ \ \ \ IntPtr\ address\_min\ =\ 0;}
\DoxyCodeLine{02458\ \ \ \ \ \ \ SubsecondTime\ time\_min\ =\ SubsecondTime::MaxTime();}
\DoxyCodeLine{02459\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(Mshr::iterator\ it\ =\ m\_master-\/>mshr.begin();\ it\ !=\ m\_master-\/>mshr.end();\ ++it)\ \{}
\DoxyCodeLine{02460\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (it-\/>second.t\_complete\ <\ time\_min)\ \{}
\DoxyCodeLine{02461\ \ \ \ \ \ \ \ \ \ \ \ \ address\_min\ =\ it-\/>first;}
\DoxyCodeLine{02462\ \ \ \ \ \ \ \ \ \ \ \ \ time\_min\ =\ it-\/>second.t\_complete;}
\DoxyCodeLine{02463\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02464\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02465\ \ \ \ \ \ \ m\_master-\/>mshr.erase(address\_min);}
\DoxyCodeLine{02466\ \ \ \ \}}
\DoxyCodeLine{02467\ \}}
\DoxyCodeLine{02468\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02469\ CacheCntlr::cleanupMetadataMshr()}
\DoxyCodeLine{02470\ \{}
\DoxyCodeLine{02471\ \ \ \ \textcolor{comment}{/*\ Keep\ only\ last\ 8\ MSHR\ entries\ */}}
\DoxyCodeLine{02472\ \ \ \ \textcolor{keywordflow}{while}(m\_master-\/>metadata\_mshr.size()\ >\ 8)\ \{}
\DoxyCodeLine{02473\ \ \ \ \ \ \ IntPtr\ address\_min\ =\ 0;}
\DoxyCodeLine{02474\ \ \ \ \ \ \ SubsecondTime\ time\_min\ =\ SubsecondTime::MaxTime();}
\DoxyCodeLine{02475\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(Mshr::iterator\ it\ =\ m\_master-\/>metadata\_mshr.begin();\ it\ !=\ m\_master-\/>metadata\_mshr.end();\ ++it)\ \{}
\DoxyCodeLine{02476\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (it-\/>second.t\_complete\ <\ time\_min)\ \{}
\DoxyCodeLine{02477\ \ \ \ \ \ \ \ \ \ \ \ \ address\_min\ =\ it-\/>first;}
\DoxyCodeLine{02478\ \ \ \ \ \ \ \ \ \ \ \ \ time\_min\ =\ it-\/>second.t\_complete;}
\DoxyCodeLine{02479\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02480\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02481\ \ \ \ \ \ \ m\_master-\/>metadata\_mshr.erase(address\_min);}
\DoxyCodeLine{02482\ \ \ \ \}}
\DoxyCodeLine{02483\ \}}
\DoxyCodeLine{02484\ }
\DoxyCodeLine{02485\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02486\ CacheCntlr::transition(IntPtr\ address,\ Transition::reason\_t\ reason,\ CacheState::cstate\_t\ old\_state,\ CacheState::cstate\_t\ new\_state)}
\DoxyCodeLine{02487\ \{}
\DoxyCodeLine{02488\ \textcolor{preprocessor}{\#ifdef\ ENABLE\_TRANSITIONS}}
\DoxyCodeLine{02489\ \ \ \ stats.transitions[old\_state][new\_state]++;}
\DoxyCodeLine{02490\ \ \ \ \textcolor{keywordflow}{if}\ (old\_state\ ==\ CacheState::INVALID)\ \{}
\DoxyCodeLine{02491\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (stats.seen.count(address)\ ==\ 0)}
\DoxyCodeLine{02492\ \ \ \ \ \ \ \ \ \ old\_state\ =\ CacheState::INVALID\_COLD;}
\DoxyCodeLine{02493\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (stats.seen[address]\ ==\ Transition::EVICT\ ||\ stats.seen[address]\ ==\ Transition::BACK\_INVAL)}
\DoxyCodeLine{02494\ \ \ \ \ \ \ \ \ \ old\_state\ =\ CacheState::INVALID\_EVICT;}
\DoxyCodeLine{02495\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (stats.seen[address]\ ==\ Transition::COHERENCY)}
\DoxyCodeLine{02496\ \ \ \ \ \ \ \ \ \ old\_state\ =\ CacheState::INVALID\_COHERENCY;}
\DoxyCodeLine{02497\ \ \ \ \}}
\DoxyCodeLine{02498\ \ \ \ stats.transition\_reasons[reason][old\_state][new\_state]++;}
\DoxyCodeLine{02499\ \ \ \ stats.seen[address]\ =\ reason;}
\DoxyCodeLine{02500\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02501\ \}}
\DoxyCodeLine{02502\ }
\DoxyCodeLine{02503\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02504\ CacheCntlr::updateUncoreStatistics(HitWhere::where\_t\ hit\_where,\ SubsecondTime\ now)}
\DoxyCodeLine{02505\ \{}
\DoxyCodeLine{02506\ \ \ \ \textcolor{comment}{//\ To\ be\ propagated\ through\ next-\/level\ refill}}
\DoxyCodeLine{02507\ \ \ \ m\_last\_remote\_hit\_where\ =\ hit\_where;}
\DoxyCodeLine{02508\ }
\DoxyCodeLine{02509\ \ \ \ \textcolor{comment}{//\ Update\ ShmemPerf}}
\DoxyCodeLine{02510\ \ \ \ \textcolor{keywordflow}{if}\ (m\_shmem\_perf-\/>getInitialTime()\ >\ SubsecondTime::Zero())}
\DoxyCodeLine{02511\ \ \ \ \{}
\DoxyCodeLine{02512\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can't\ really\ be\ sure\ that\ there\ are\ not\ outstanding\ transations\ that\ still\ pass\ a\ pointer}}
\DoxyCodeLine{02513\ \ \ \ \ \ \ \textcolor{comment}{//\ around\ to\ our\ ShmemPerf\ structure.\ By\ settings\ its\ last\ time\ to\ MaxTime,\ we\ prevent\ anyone}}
\DoxyCodeLine{02514\ \ \ \ \ \ \ \textcolor{comment}{//\ from\ updating\ statistics\ while\ we're\ reading\ them.}}
\DoxyCodeLine{02515\ \ \ \ \ \ \ m\_shmem\_perf-\/>disable();}
\DoxyCodeLine{02516\ }
\DoxyCodeLine{02517\ \ \ \ \ \ \ m\_shmem\_perf\_global-\/>add(m\_shmem\_perf);}
\DoxyCodeLine{02518\ \ \ \ \ \ \ m\_shmem\_perf\_totaltime\ +=\ now\ -\/\ m\_shmem\_perf-\/>getInitialTime();}
\DoxyCodeLine{02519\ \ \ \ \ \ \ m\_shmem\_perf\_numrequests\ ++;}
\DoxyCodeLine{02520\ }
\DoxyCodeLine{02521\ \ \ \ \ \ \ m\_shmem\_perf-\/>reset(SubsecondTime::Zero(),\ INVALID\_CORE\_ID);}
\DoxyCodeLine{02522\ \ \ \ \}}
\DoxyCodeLine{02523\ \}}
\DoxyCodeLine{02524\ }
\DoxyCodeLine{02525\ }
\DoxyCodeLine{02526\ \textcolor{comment}{/*****************************************************************************}}
\DoxyCodeLine{02527\ \textcolor{comment}{\ *\ utility\ functions}}
\DoxyCodeLine{02528\ \textcolor{comment}{\ *****************************************************************************/}}
\DoxyCodeLine{02529\ }
\DoxyCodeLine{02530\ \textcolor{comment}{/*\ Lock\ design:}}
\DoxyCodeLine{02531\ \textcolor{comment}{\ \ \ -\/\ we\ want\ to\ allow\ concurrent\ access\ for\ operations\ that\ only\ touch\ the\ first-\/level\ cache}}
\DoxyCodeLine{02532\ \textcolor{comment}{\ \ \ -\/\ we\ want\ concurrent\ access\ to\ different\ addresses\ as\ much\ as\ possible}}
\DoxyCodeLine{02533\ \textcolor{comment}{}}
\DoxyCodeLine{02534\ \textcolor{comment}{\ \ \ Master\ last-\/level\ cache\ contains\ one\ shared/exclusive-\/lock\ per\ set\ (according\ to\ the\ first-\/level\ cache's\ set\ size)}}
\DoxyCodeLine{02535\ \textcolor{comment}{\ \ \ -\/\ First-\/level\ cache\ transactions\ acquire\ the\ lock\ pertaining\ to\ the\ set\ they'll\ use\ in\ shared\ mode.}}
\DoxyCodeLine{02536\ \textcolor{comment}{\ \ \ \ \ Multiple\ first-\/level\ caches\ can\ do\ this\ simultaneously.}}
\DoxyCodeLine{02537\ \textcolor{comment}{\ \ \ \ \ Since\ only\ a\ single\ thread\ accesses\ each\ L1,\ there\ should\ be\ no\ extra\ per-\/cache\ lock\ needed}}
\DoxyCodeLine{02538\ \textcolor{comment}{\ \ \ \ \ (The\ above\ is\ not\ strictly\ true,\ but\ Core\ takes\ care\ of\ this\ since\ MemoryManager\ only\ has\ one\ cycle\ count\ anyway).}}
\DoxyCodeLine{02539\ \textcolor{comment}{\ \ \ \ \ On\ a\ miss,\ a\ lock\ upgrade\ is\ needed.}}
\DoxyCodeLine{02540\ \textcolor{comment}{\ \ \ -\/\ Other\ levels,\ or\ the\ first\ level\ on\ miss,\ acquire\ the\ lock\ in\ exclusive\ mode\ which\ locks\ out\ both\ L1-\/only\ and\ L2+\ transactions.}}
\DoxyCodeLine{02541\ \textcolor{comment}{\ \ \ \#ifdef\ PRIVATE\_L2\_OPTIMIZATION}}
\DoxyCodeLine{02542\ \textcolor{comment}{\ \ \ -\/\ (On\ Nehalem,\ the\ L2\ is\ private\ so\ it\ is\ only\ the\ L3\ (the\ first\ level\ with\ m\_sharing\_cores\ >\ 1)\ that\ takes\ the\ exclusive\ lock).}}
\DoxyCodeLine{02543\ \textcolor{comment}{\ \ \ \#endif}}
\DoxyCodeLine{02544\ \textcolor{comment}{}}
\DoxyCodeLine{02545\ \textcolor{comment}{\ \ \ Additionally,\ for\ per-\/cache\ objects\ that\ are\ not\ private\ to\ a\ cache\ set,\ each\ cache\ controller\ has\ its\ own\ (normal)\ lock,}}
\DoxyCodeLine{02546\ \textcolor{comment}{\ \ \ use\ getLock()\ for\ this.\ This\ is\ required\ for\ statistics\ updates,\ the\ directory\ waiters\ queue,\ etc.}}
\DoxyCodeLine{02547\ \textcolor{comment}{*/}}
\DoxyCodeLine{02548\ }
\DoxyCodeLine{02549\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02550\ CacheCntlr::acquireLock(UInt64\ address)}
\DoxyCodeLine{02551\ \{}
\DoxyCodeLine{02552\ MYLOG(\textcolor{stringliteral}{"{}cache\ lock\ acquire\ \%u\ \#\ \%u\ @\ \%lx"{}},\ m\_mem\_component,\ m\_core\_id,\ address);}
\DoxyCodeLine{02553\ \ \ \ assert(isFirstLevel());}
\DoxyCodeLine{02554\ \ \ \ \textcolor{comment}{//\ Lock\ this\ L1\ cache\ for\ the\ set\ containing\ <address>.}}
\DoxyCodeLine{02555\ \ \ \ lastLevelCache()-\/>m\_master-\/>getSetLock(address)-\/>acquire\_shared(m\_core\_id);}
\DoxyCodeLine{02556\ \}}
\DoxyCodeLine{02557\ }
\DoxyCodeLine{02558\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02559\ CacheCntlr::releaseLock(UInt64\ address)}
\DoxyCodeLine{02560\ \{}
\DoxyCodeLine{02561\ MYLOG(\textcolor{stringliteral}{"{}cache\ lock\ release\ \%u\ \#\ \%u\ @\ \%lx"{}},\ m\_mem\_component,\ m\_core\_id,\ address);}
\DoxyCodeLine{02562\ \ \ \ assert(isFirstLevel());}
\DoxyCodeLine{02563\ \ \ \ lastLevelCache()-\/>m\_master-\/>getSetLock(address)-\/>release\_shared(m\_core\_id);}
\DoxyCodeLine{02564\ \}}
\DoxyCodeLine{02565\ }
\DoxyCodeLine{02566\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02567\ CacheCntlr::acquireStackLock(UInt64\ address,\ \textcolor{keywordtype}{bool}\ this\_is\_locked)}
\DoxyCodeLine{02568\ \{}
\DoxyCodeLine{02569\ MYLOG(\textcolor{stringliteral}{"{}stack\ lock\ acquire\ \%u\ \#\ \%u\ @\ \%lx"{}},\ m\_mem\_component,\ m\_core\_id,\ address);}
\DoxyCodeLine{02570\ \ \ \ \textcolor{comment}{//\ Lock\ the\ complete\ stack\ for\ the\ set\ containing\ <address>}}
\DoxyCodeLine{02571\ \ \ \ \textcolor{keywordflow}{if}\ (this\_is\_locked)}
\DoxyCodeLine{02572\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ two\ threads\ decide\ to\ upgrade\ at\ the\ same\ time,\ we\ could\ deadlock.}}
\DoxyCodeLine{02573\ \ \ \ \ \ \ \textcolor{comment}{//\ Upgrade\ therefore\ internally\ releases\ the\ cache\ lock!}}
\DoxyCodeLine{02574\ \ \ \ \ \ \ lastLevelCache()-\/>m\_master-\/>getSetLock(address)-\/>upgrade(m\_core\_id);}
\DoxyCodeLine{02575\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02576\ \ \ \ \ \ \ lastLevelCache()-\/>m\_master-\/>getSetLock(address)-\/>acquire\_exclusive();}
\DoxyCodeLine{02577\ \}}
\DoxyCodeLine{02578\ }
\DoxyCodeLine{02579\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02580\ CacheCntlr::releaseStackLock(UInt64\ address,\ \textcolor{keywordtype}{bool}\ this\_is\_locked)}
\DoxyCodeLine{02581\ \{}
\DoxyCodeLine{02582\ MYLOG(\textcolor{stringliteral}{"{}stack\ lock\ release\ \%u\ \#\ \%u\ @\ \%lx"{}},\ m\_mem\_component,\ m\_core\_id,\ address);}
\DoxyCodeLine{02583\ \ \ \ \textcolor{keywordflow}{if}\ (this\_is\_locked)}
\DoxyCodeLine{02584\ \ \ \ \ \ \ lastLevelCache()-\/>m\_master-\/>getSetLock(address)-\/>downgrade(m\_core\_id);}
\DoxyCodeLine{02585\ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02586\ \ \ \ \ \ \ lastLevelCache()-\/>m\_master-\/>getSetLock(address)-\/>release\_exclusive();}
\DoxyCodeLine{02587\ \}}
\DoxyCodeLine{02588\ }
\DoxyCodeLine{02589\ }
\DoxyCodeLine{02590\ CacheCntlr*}
\DoxyCodeLine{02591\ CacheCntlr::lastLevelCache()}
\DoxyCodeLine{02592\ \{}
\DoxyCodeLine{02593\ \ \ \ \textcolor{keywordflow}{if}\ (!\ m\_last\_level)\ \{}
\DoxyCodeLine{02594\ \ \ \ \ \ \ \textcolor{comment}{/*\ Find\ last-\/level\ cache\ */}}
\DoxyCodeLine{02595\ \ \ \ \ \ \ CacheCntlr*\ last\_level\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{02596\ \ \ \ \ \ \ \textcolor{keywordflow}{while}(last\_level-\/>m\_next\_cache\_cntlr)}
\DoxyCodeLine{02597\ \ \ \ \ \ \ \ \ \ last\_level\ =\ last\_level-\/>m\_next\_cache\_cntlr;}
\DoxyCodeLine{02598\ \ \ \ \ \ \ m\_last\_level\ =\ last\_level;}
\DoxyCodeLine{02599\ \ \ \ \}}
\DoxyCodeLine{02600\ \ \ \ \textcolor{keywordflow}{return}\ m\_last\_level;}
\DoxyCodeLine{02601\ \}}
\DoxyCodeLine{02602\ }
\DoxyCodeLine{02603\ \textcolor{keywordtype}{bool}}
\DoxyCodeLine{02604\ CacheCntlr::isShared(core\_id\_t\ core\_id)}
\DoxyCodeLine{02605\ \{}
\DoxyCodeLine{02606\ \ \ \ core\_id\_t\ core\_id\_master\ =\ core\_id\ -\/\ core\_id\ \%\ m\_shared\_cores;}
\DoxyCodeLine{02607\ \ \ \ \textcolor{keywordflow}{return}\ core\_id\_master\ ==\ m\_core\_id\_master;}
\DoxyCodeLine{02608\ \}}
\DoxyCodeLine{02609\ }
\DoxyCodeLine{02610\ }
\DoxyCodeLine{02611\ \textcolor{comment}{/***\ threads\ ***/}}
\DoxyCodeLine{02612\ }
\DoxyCodeLine{02613\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02614\ CacheCntlr::wakeUpUserThread(Semaphore*\ user\_thread\_sem)}
\DoxyCodeLine{02615\ \{}
\DoxyCodeLine{02616\ \ \ \ (user\_thread\_sem\ ?\ user\_thread\_sem\ :\ m\_user\_thread\_sem)-\/>signal();}
\DoxyCodeLine{02617\ \}}
\DoxyCodeLine{02618\ }
\DoxyCodeLine{02619\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02620\ CacheCntlr::waitForUserThread(Semaphore*\ network\_thread\_sem)}
\DoxyCodeLine{02621\ \{}
\DoxyCodeLine{02622\ \ \ \ (network\_thread\_sem\ ?\ network\_thread\_sem\ :\ m\_network\_thread\_sem)-\/>wait();}
\DoxyCodeLine{02623\ \}}
\DoxyCodeLine{02624\ }
\DoxyCodeLine{02625\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02626\ CacheCntlr::waitForNetworkThread()}
\DoxyCodeLine{02627\ \{}
\DoxyCodeLine{02628\ \ \ \ m\_user\_thread\_sem-\/>wait();}
\DoxyCodeLine{02629\ \}}
\DoxyCodeLine{02630\ }
\DoxyCodeLine{02631\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{02632\ CacheCntlr::wakeUpNetworkThread()}
\DoxyCodeLine{02633\ \{}
\DoxyCodeLine{02634\ \ \ \ m\_network\_thread\_sem-\/>signal();}
\DoxyCodeLine{02635\ \}}
\DoxyCodeLine{02636\ }
\DoxyCodeLine{02637\ Semaphore*}
\DoxyCodeLine{02638\ CacheCntlr::getUserThreadSemaphore()}
\DoxyCodeLine{02639\ \{}
\DoxyCodeLine{02640\ \ \ \ \textcolor{keywordflow}{return}\ m\_user\_thread\_sem;}
\DoxyCodeLine{02641\ \}}
\DoxyCodeLine{02642\ }
\DoxyCodeLine{02643\ Semaphore*}
\DoxyCodeLine{02644\ CacheCntlr::getNetworkThreadSemaphore()}
\DoxyCodeLine{02645\ \{}
\DoxyCodeLine{02646\ \ \ \ \textcolor{keywordflow}{return}\ m\_network\_thread\_sem;}
\DoxyCodeLine{02647\ \}}
\DoxyCodeLine{02648\ }
\DoxyCodeLine{02649\ \}}
\DoxyCodeLine{02650\ \ \ }

\end{DoxyCode}
